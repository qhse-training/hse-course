<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ú–æ–∏ –∫—É—Ä—Å—ã</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f8f8f8; margin: 0; }
    header { background: #3498db; color: #fff; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
    .course-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; padding: 20px; }
    .course-card { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; flex-direction: column; position: relative; }
    .course-image { height: 160px; background-size: cover; background-position: center; position: relative; }
    .progress-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(52, 152, 219, 0.8); height: 4px; }
    .progress-bar { background: #2ecc71; height: 100%; width: 0%; transition: width 0.3s; }
    .course-body { padding: 15px; flex: 1; display: flex; flex-direction: column; }
    .course-title { margin: 0 0 10px; font-size: 18px; }
    .course-desc { flex: 1; color: #555; margin-bottom: 10px; }
    .course-status { font-size: 14px; margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }
    .status-badge { padding: 3px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; }
    .status-not-started { background: #e74c3c; color: white; }
    .status-in-progress { background: #f39c12; color: white; }
    .status-test-available { background: #3498db; color: white; }
    .status-completed { background: #2ecc71; color: white; }
    .course-actions { margin-top: 10px; display: flex; gap: 10px; }
    .btn { padding: 8px 12px; background: #3498db; color: white; text-decoration: none; border-radius: 5px; text-align: center; cursor: pointer; border: none; font-size: 14px; }
    .btn:hover { opacity: 0.9; }
    .btn-test { background: #e67e22; }
    .btn-test:disabled { background: #95a5a6; cursor: not-allowed; opacity: 0.6; }
    .btn-certificate { background: #9b59b6; }
    .btn-certificate:hover { background: #8e44ad; }
    #searchInput { width: 100%; padding: 10px; border: none; border-bottom: 1px solid #ccc; font-size: 16px; }
    .course-meta { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; font-size: 12px; color: #7f8c8d; }
    .loading { text-align: center; padding: 40px; color: #7f8c8d; }
    .no-courses { text-align: center; padding: 40px; color: #7f8c8d; grid-column: 1 / -1; }
  </style>
</head>
<body>
  <header>
    <div>
      <div id="userInfo">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      <div id="userProgress" style="font-size: 12px; opacity: 0.9;"></div>
    </div>
    <button id="logoutBtn" style="background:#e74c3c;color:#fff;border:none;padding:6px 12px;border-radius:5px;cursor:pointer;">–í—ã–π—Ç–∏</button>
  </header>

  <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –∫—É—Ä—Å–æ–≤...">

  <div class="course-list" id="courseList">
    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫—É—Ä—Å–æ–≤...</div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDQXNLAsqmSlAjplpdl2anPSyiDxbz3CjY",
      authDomain: "qhse-training.firebaseapp.com",
      projectId: "qhse-training",
      storageBucket: "qhse-training.appspot.com",
      messagingSenderId: "4501351718",
      appId: "1:4501351718:web:503b00c9ac052b58e2e5e7"
    };
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
    const courseList = document.getElementById('courseList');
    const searchInput = document.getElementById('searchInput');
    const userInfo = document.getElementById('userInfo');
    const userProgress = document.getElementById('userProgress');

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let allCourses = [];
    let userData = null;
    let userProgressData = {};

    // –ü–æ–ª—É—á–µ–Ω–∏–µ URL –ø—Ä–µ–≤—å—é –∫—É—Ä—Å–∞
    async function getPreviewUrl(folder) {
      const base = `https://raw.githubusercontent.com/qhse-training/hse-course/main/${folder}`;
      const variants = ["Slide1.JPG", "%D0%A1%D0%BB%D0%B0%D0%B9%D0%B41.JPG", "slide1.jpg", "cover.jpg", "Slide1.jpeg", "slide1.jpeg"];
      for (let file of variants) {
        try {
          const res = await fetch(`${base}/${file}`, { method: 'HEAD' });
          if (res.ok) return `${base}/${file}`;
        } catch(e) {}
      }
      return 'https://via.placeholder.com/300x160?text=–ù–µ—Ç+–ø—Ä–µ–≤—å—é';
    }

    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∫—É—Ä—Å–∞
    function getCourseStatus(courseId) {
      const progress = userProgressData[courseId] || {};
      const slidesProgress = progress.slidesViewed || 0;
      const testPassed = progress.testPassed || false;
      const certificateGenerated = progress.certificateGenerated || false;
      const certificateId = progress.certificateId || null;

      if (certificateGenerated) {
        return { 
          status: 'completed', 
          progress: 100, 
          testAvailable: false,
          certificateId: certificateId
        };
      } else if (testPassed) {
        return { 
          status: 'test-passed', 
          progress: 100, 
          testAvailable: false 
        };
      } else if (slidesProgress >= 100) {
        return { 
          status: 'test-available', 
          progress: 100, 
          testAvailable: true 
        };
      } else if (slidesProgress > 0) {
        return { 
          status: 'in-progress', 
          progress: slidesProgress, 
          testAvailable: false 
        };
      } else {
        return { 
          status: 'not-started', 
          progress: 0, 
          testAvailable: false 
        };
      }
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å—Ç–∞—Ç—É—Å–∞
    function getStatusText(status) {
      const texts = {
        'not-started': '–ù–µ –Ω–∞—á–∞—Ç',
        'in-progress': '–í –ø—Ä–æ—Ü–µ—Å—Å–µ',
        'test-available': '–¢–µ—Å—Ç –¥–æ—Å—Ç—É–ø–µ–Ω',
        'test-passed': '–¢–µ—Å—Ç —Å–¥–∞–Ω',
        'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω'
      };
      return texts[status] || status;
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∞ –¥–ª—è –±–µ–π–¥–∂–∞ —Å—Ç–∞—Ç—É—Å–∞
    function getStatusClass(status) {
      const classes = {
        'not-started': 'status-not-started',
        'in-progress': 'status-in-progress',
        'test-available': 'status-test-available',
        'test-passed': 'status-in-progress',
        'completed': 'status-completed'
      };
      return classes[status] || 'status-not-started';
    }

    // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ URL –¥–ª—è –∫—É—Ä—Å–∞ (—Å–æ–≥–ª–∞—Å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ)
    function getCourseUrl(courseId) {
      // –ù–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–µ–π —Å—Å—ã–ª–∫–∏, –∫—É—Ä—Å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–æ –ø—É—Ç–∏:
      // https://github.com/qhse-training/hse-course/blob/main/1.01.Occupational_Health_and_Safety_Management_System/course.html
      // –ù–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞–º –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å GitHub Pages:
      return `https://qhse-training.github.io/hse-course/${courseId}/course.html?id=${encodeURIComponent(courseId)}`;
    }

    // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ URL –¥–ª—è —Ç–µ—Å—Ç–∞ (—Å–æ–≥–ª–∞—Å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ)
    function getTestUrl(course) {
      if (!course.testHtml) return '#';
      
      // –ü—Ä–∏–º–µ—Ä —Ç–µ—Å—Ç–∞: https://qhse-training.github.io/hse-course/1.01.Occupational_Health_and_Safety_Management_System/test1.html?id=0EFXo6H4N1mbA1jBJwOK
      
      // –ï—Å–ª–∏ testHtml —É–∂–µ –ø–æ–ª–Ω—ã–π URL, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
      if (course.testHtml.startsWith('http')) {
        return `${course.testHtml}?id=${encodeURIComponent(course.id)}`;
      }
      
      // –ò–Ω–∞—á–µ —Ñ–æ—Ä–º–∏—Ä—É–µ–º –ø—É—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ GitHub Pages
      const baseUrl = 'https://qhse-training.github.io/hse-course';
      return `${baseUrl}/${course.testHtml}?id=${encodeURIComponent(course.id)}`;
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ –∏–∑ –≤–∞—à–µ–≥–æ –æ–±—Ä–∞–∑—Ü–∞
    function showCertificate(certificateId, courseName, userName, date) {
      const certificateWindow = window.open('', '_blank', 'width=1000,height=800');
      certificateWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç - ${courseName}</title>
          <style>
            @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto:wght@300;400;500&display=swap');
            
            body { 
              font-family: 'Roboto', sans-serif; 
              padding: 40px; 
              text-align: center; 
              background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
              min-height: 100vh;
              display: flex;
              justify-content: center;
              align-items: center;
              margin: 0;
            }
            
            .certificate-container {
              background: white;
              border-radius: 15px;
              padding: 50px;
              width: 900px;
              box-shadow: 0 20px 60px rgba(0,0,0,0.15);
              border: 10px solid #2c3e50;
              position: relative;
              overflow: hidden;
            }
            
            .certificate-header {
              margin-bottom: 40px;
              padding-bottom: 20px;
              border-bottom: 3px solid #3498db;
            }
            
            .certificate-title {
              font-family: 'Playfair Display', serif;
              font-size: 48px;
              font-weight: 700;
              color: #2c3e50;
              margin: 0;
              letter-spacing: 3px;
              text-transform: uppercase;
            }
            
            .certificate-subtitle {
              font-size: 20px;
              color: #7f8c8d;
              margin-top: 15px;
              font-weight: 300;
            }
            
            .certificate-content {
              margin: 40px 0;
              padding: 30px;
              background: #f8f9fa;
              border-radius: 10px;
              border-left: 5px solid #3498db;
            }
            
            .certificate-name {
              font-family: 'Playfair Display', serif;
              font-size: 36px;
              color: #e74c3c;
              margin: 25px 0;
              font-weight: 700;
            }
            
            .certificate-course {
              font-size: 28px;
              color: #2c3e50;
              margin: 30px 0;
              font-weight: 500;
              line-height: 1.4;
            }
            
            .course-quote {
              font-style: italic;
              color: #7f8c8d;
              font-size: 18px;
              margin: 20px 0;
              padding: 10px;
              border-top: 1px dashed #ddd;
              border-bottom: 1px dashed #ddd;
            }
            
            .certificate-details {
              display: flex;
              justify-content: space-between;
              margin-top: 50px;
              padding-top: 30px;
              border-top: 2px solid #eee;
            }
            
            .detail-item {
              text-align: center;
              flex: 1;
            }
            
            .detail-label {
              font-size: 16px;
              color: #7f8c8d;
              margin-bottom: 8px;
              text-transform: uppercase;
              letter-spacing: 1px;
            }
            
            .detail-value {
              font-size: 20px;
              color: #2c3e50;
              font-weight: 500;
            }
            
            .certificate-footer {
              margin-top: 60px;
              padding-top: 30px;
              border-top: 2px solid #3498db;
              display: flex;
              justify-content: space-between;
              align-items: flex-end;
            }
            
            .signature {
              text-align: center;
            }
            
            .signature-line {
              width: 200px;
              height: 1px;
              background: #2c3e50;
              margin: 20px auto;
            }
            
            .issued-by {
              font-size: 18px;
              color: #2c3e50;
              font-weight: 500;
              margin-top: 10px;
            }
            
            .logo {
              font-size: 24px;
              font-weight: 700;
              color: #3498db;
              letter-spacing: 2px;
            }
            
            .certificate-id {
              background: #2c3e50;
              color: white;
              padding: 10px 20px;
              border-radius: 5px;
              font-family: monospace;
              font-size: 14px;
              letter-spacing: 1px;
              display: inline-block;
              margin-top: 20px;
            }
            
            .watermark {
              position: absolute;
              opacity: 0.03;
              font-size: 200px;
              transform: rotate(-45deg);
              top: 30%;
              left: 10%;
              white-space: nowrap;
              color: #2c3e50;
              font-family: 'Playfair Display', serif;
              font-weight: 700;
              z-index: 0;
            }
            
            .seal {
              position: absolute;
              top: 50px;
              right: 50px;
              width: 120px;
              height: 120px;
              border: 3px solid #e74c3c;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              font-family: 'Playfair Display', serif;
              font-size: 14px;
              font-weight: 700;
              color: #e74c3c;
              text-align: center;
              padding: 10px;
              background: rgba(255,255,255,0.9);
              transform: rotate(15deg);
            }
            
            @media print {
              body {
                background: white !important;
              }
              .certificate-container {
                box-shadow: none !important;
                border: 15px solid #2c3e50 !important;
              }
              .no-print {
                display: none !important;
              }
            }
          </style>
        </head>
        <body>
          <div class="certificate-container">
            <div class="watermark">–°–ï–†–¢–ò–§–ò–ö–ê–¢</div>
            <div class="seal">
              QHSE<br>SOLUTIONS
            </div>
            
            <div class="certificate-header">
              <h1 class="certificate-title">–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç</h1>
              <p class="certificate-subtitle">–ù–∞—Å—Ç–æ—è—â–∏–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è, —á—Ç–æ</p>
            </div>
            
            <div class="certificate-content">
              <div class="certificate-name">${userName}</div>
              <p style="font-size: 20px; margin: 20px 0;">—É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—à—ë–ª(–∞) –∫—É—Ä—Å –æ–±—É—á–µ–Ω–∏—è –ø–æ –ø—Ä–æ–≥—Ä–∞–º–º–µ</p>
              <div class="certificate-course">"${courseName}"</div>
              <p class="course-quote">–ü—Ä–æ–≥—Ä–∞–º–º–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º —Å–∏—Å—Ç–µ–º—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è –ø–æ –æ—Ö—Ä–∞–Ω–µ —Ç—Ä—É–¥–∞</p>
            </div>
            
            <div class="certificate-details">
              <div class="detail-item">
                <div class="detail-label">–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏</div>
                <div class="detail-value">${date}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">ID —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞</div>
                <div class="detail-value">${certificateId}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">–°—Ç–∞—Ç—É—Å</div>
                <div class="detail-value" style="color: #2ecc71;">–î–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω</div>
              </div>
            </div>
            
            <div class="certificate-footer">
              <div class="signature">
                <div class="signature-line"></div>
                <div class="issued-by">–í—ã–¥–∞–Ω–æ: QHSE-Solutions.kz</div>
                <div style="color: #7f8c8d; font-size: 14px; margin-top: 5px;">–¶–µ–Ω—Ç—Ä –æ–±—É—á–µ–Ω–∏—è –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</div>
              </div>
              <div class="logo">QHSE-SOLUTIONS</div>
            </div>
            
            <div class="certificate-id">ID: ${certificateId}</div>
            
            <div class="no-print" style="margin-top: 40px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
              <p style="color: #7f8c8d; font-size: 14px;">
                <strong>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–µ:</strong><br>
                –î–∞–Ω–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç —É—Å–ø–µ—à–Ω–æ–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ –∫—É—Ä—Å–∞ –æ–±—É—á–µ–Ω–∏—è.<br>
                –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ID: <strong>${certificateId}</strong>
              </p>
              <button onclick="window.print()" style="
                background: #3498db;
                color: white;
                border: none;
                padding: 10px 25px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 16px;
                margin-top: 15px;
              ">üñ®Ô∏è –†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç</button>
            </div>
          </div>
          
          <script>
            window.onload = function() {
              // –§–æ–∫—É—Å –Ω–∞ –æ–∫–Ω–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
              window.focus();
              
              // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø–µ—á–∞—Ç—å —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
              setTimeout(() => {
                if (confirm('–†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç?')) {
                  window.print();
                }
              }, 1000);
            }
          <\/script>
        </body>
        </html>
      `);
    }

    // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫–∞—Ä—Ç–æ—á–µ–∫ –∫—É—Ä—Å–æ–≤
    function renderCourses(courses) {
      if (!courses.length) {
        courseList.innerHTML = '<div class="no-courses">–ö—É—Ä—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
        return;
      }
      
      courseList.innerHTML = '';
      
      courses.forEach(course => {
        const status = getCourseStatus(course.id);
        const card = document.createElement('div');
        card.className = 'course-card';
        
        card.innerHTML = `
          <div class="course-image" style="background-image:url('${course.slideUrl}')">
            <div class="progress-overlay">
              <div class="progress-bar" style="width: ${status.progress}%"></div>
            </div>
          </div>
          <div class="course-body">
            <h3 class="course-title">${course.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</h3>
            <div class="course-status">
              <span class="status-badge ${getStatusClass(status.status)}">
                ${getStatusText(status.status)}
              </span>
              <span>${Math.round(status.progress)}%</span>
            </div>
            <p class="course-desc">${course.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}</p>
            <div class="course-meta">
              <span>${course.duration || '–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–µ —É–∫–∞–∑–∞–Ω–∞'}</span>
              <span>${course.modules || 0} –º–æ–¥—É–ª–µ–π</span>
            </div>
            <div class="course-actions">
              <a href="${getCourseUrl(course.id)}" target="_blank" class="btn">${status.progress > 0 ? '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å' : '–ù–∞—á–∞—Ç—å –∫—É—Ä—Å'}</a>
              ${course.testHtml ? `
                <button class="btn btn-test" ${status.testAvailable ? '' : 'disabled'} 
                  onclick="window.open('${getTestUrl(course)}', '_blank')">
                  –ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç
                </button>
              ` : ''}
              ${status.status === 'completed' ? `
                <button class="btn btn-certificate" onclick="showExistingCertificate('${course.id}')">
                  –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
                </button>
              ` : ''}
            </div>
          </div>
        `;
        
        courseList.appendChild(card);
      });
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∫—É—Ä—Å–æ–≤
    async function loadUserData(user) {
      try {
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const userDoc = await db.collection("approved_users").doc(user.uid).get();
        
        if (!userDoc.exists) {
          console.error("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ approved_users");
          courseList.innerHTML = `
            <div class="no-courses">
              <h3>–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω</h3>
              <p>–í–∞—à–∞ —É—á–µ—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Å–∏—Å—Ç–µ–º–µ</p>
            </div>
          `;
          return false;
        }
        
        userData = userDoc.data();
        userInfo.textContent = `${userData.fullName || user.email} (${user.email})`;
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const progressDoc = await db.collection("user_progress").doc(user.uid).get();
        userProgressData = progressDoc.exists ? progressDoc.data() : {};
        
        // –ü–æ–ª—É—á–∞–µ–º ID –∫—É—Ä—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const userCourseIds = userData.courses || [];
        
        // –ï—Å–ª–∏ –Ω–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –∫—É—Ä—Å–æ–≤
        if (userCourseIds.length === 0) {
          courseList.innerHTML = `
            <div class="no-courses">
              <h3>–ö—É—Ä—Å—ã –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã</h3>
              <p>–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∫—É—Ä—Å–æ–≤</p>
            </div>
          `;
          
          // –†–∞—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
          const completedCourses = 0;
          const totalProgress = 0;
          userProgress.textContent = `–ü—Ä–æ–≥—Ä–µ—Å—Å: 0% | –ó–∞–≤–µ—Ä—à–µ–Ω–æ: 0/0 –∫—É—Ä—Å–æ–≤`;
          return true;
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫—É—Ä—Å–æ–≤
        const courses = [];
        const coursePromises = userCourseIds.map(async (courseId) => {
          try {
            const courseDoc = await db.collection('courses').doc(courseId).get();
            if (courseDoc.exists) {
              const courseData = courseDoc.data();
              const preview = await getPreviewUrl(courseId);
              return {
                id: courseId,
                title: courseData.title || `–ö—É—Ä—Å ${courseId}`,
                description: courseData.description || '',
                testHtml: courseData.testHtml || null,
                duration: courseData.duration || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                modules: courseData.modules || 0,
                slideUrl: preview
              };
            }
          } catch (error) {
            console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—É—Ä—Å–∞ ${courseId}:`, error);
            return null;
          }
        });
        
        // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –∫—É—Ä—Å–æ–≤
        const courseResults = await Promise.all(coursePromises);
        allCourses = courseResults.filter(course => course !== null);
        
        // –†–∞—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        const totalProgress = userCourseIds.reduce((sum, courseId) => {
          const progress = userProgressData[courseId] || {};
          return sum + (progress.slidesViewed || 0);
        }, 0);
        
        const completedCourses = userCourseIds.filter(courseId => {
          const progress = userProgressData[courseId] || {};
          return progress.certificateGenerated === true;
        }).length;
        
        const avgProgress = userCourseIds.length > 0 ? Math.round(totalProgress / userCourseIds.length) : 0;
        
        userProgress.textContent = `–ü—Ä–æ–≥—Ä–µ—Å—Å: ${avgProgress}% | –ó–∞–≤–µ—Ä—à–µ–Ω–æ: ${completedCourses}/${userCourseIds.length} –∫—É—Ä—Å–æ–≤`;
        
        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫—É—Ä—Å–æ–≤
        renderCourses(allCourses);
        return true;
        
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:", error);
        courseList.innerHTML = `
          <div class="no-courses">
            <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</h3>
            <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</p>
            <p style="font-size: 12px; color: #e74c3c;">${error.message}</p>
          </div>
        `;
        return false;
      }
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
    async function showExistingCertificate(courseId) {
      try {
        const user = auth.currentUser;
        if (!user) return;
        
        const progress = userProgressData[courseId] || {};
        if (!progress.certificateGenerated || !progress.certificateId) {
          alert('–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –µ—â–µ –Ω–µ –±—ã–ª —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω');
          return;
        }
        
        const course = allCourses.find(c => c.id === courseId);
        const userName = userData.fullName || user.email;
        const courseName = course?.title || '–ö—É—Ä—Å';
        const date = progress.certificateDate ? 
          new Date(progress.certificateDate).toLocaleDateString('ru-RU') : 
          new Date().toLocaleDateString('ru-RU');
        
        showCertificate(progress.certificateId, courseName, userName, date);
        
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞:", error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞');
      }
    }

    // –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }

      // –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞
      document.getElementById('logoutBtn').addEventListener('click', () => {
        auth.signOut().then(() => location.href = 'login.html');
      });

      // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
      await loadUserData(user);

      // –ü–æ–∏—Å–∫ –∫—É—Ä—Å–æ–≤
      searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        if (!searchTerm) {
          renderCourses(allCourses);
          return;
        }
        
        const filtered = allCourses.filter(c => 
          (c.title || '').toLowerCase().includes(searchTerm) || 
          (c.description || '').toLowerCase().includes(searchTerm)
        );
        renderCourses(filtered);
      });
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
    window.addEventListener('error', function(e) {
      console.error('Global error:', e.error);
    });
  </script>
</body>
</html>