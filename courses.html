<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Мои курсы</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f8f8f8; margin: 0; }
    header { background: #3498db; color: #fff; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
    .course-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; padding: 20px; }
    .course-card { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; flex-direction: column; position: relative; }
    .course-image { height: 160px; background-size: cover; background-position: center; position: relative; }
    .progress-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(52, 152, 219, 0.8); height: 4px; }
    .progress-bar { background: #2ecc71; height: 100%; width: 0%; transition: width 0.3s; }
    .course-body { padding: 15px; flex: 1; display: flex; flex-direction: column; }
    .course-title { margin: 0 0 10px; font-size: 18px; }
    .course-desc { flex: 1; color: #555; margin-bottom: 10px; }
    .course-status { font-size: 14px; margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }
    .status-badge { padding: 3px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; }
    .status-not-started { background: #e74c3c; color: white; }
    .status-in-progress { background: #f39c12; color: white; }
    .status-test-available { background: #3498db; color: white; }
    .status-completed { background: #2ecc71; color: white; }
    .course-actions { margin-top: 10px; display: flex; gap: 10px; }
    .btn { padding: 8px 12px; background: #3498db; color: white; text-decoration: none; border-radius: 5px; text-align: center; cursor: pointer; border: none; font-size: 14px; }
    .btn:hover { opacity: 0.9; }
    .btn-test { background: #e67e22; }
    .btn-test:disabled { background: #95a5a6; cursor: not-allowed; opacity: 0.6; }
    .btn-certificate { background: #9b59b6; }
    .btn-certificate:hover { background: #8e44ad; }
    #searchInput { width: 100%; padding: 10px; border: none; border-bottom: 1px solid #ccc; font-size: 16px; }
    .course-meta { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; font-size: 12px; color: #7f8c8d; }
    .loading { text-align: center; padding: 40px; color: #7f8c8d; }
    .certificate-preview { cursor: pointer; text-decoration: underline; color: #3498db; }
  </style>
</head>
<body>
  <header>
    <div>
      <div id="userInfo">Загрузка...</div>
      <div id="userProgress" style="font-size: 12px; opacity: 0.9;"></div>
    </div>
    <button id="logoutBtn" style="background:#e74c3c;color:#fff;border:none;padding:6px 12px;border-radius:5px;cursor:pointer;">Выйти</button>
  </header>

  <input type="text" id="searchInput" placeholder="Поиск курсов...">

  <div class="course-list" id="courseList">
    <div class="loading">Загрузка курсов...</div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDQXNLAsqmSlAjplpdl2anPSyiDxbz3CjY",
      authDomain: "qhse-training.firebaseapp.com",
      projectId: "qhse-training",
      storageBucket: "qhse-training.appspot.com",
      messagingSenderId: "4501351718",
      appId: "1:4501351718:web:503b00c9ac052b58e2e5e7"
    };
    
    // Инициализация Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM элементы
    const courseList = document.getElementById('courseList');
    const searchInput = document.getElementById('searchInput');
    const userInfo = document.getElementById('userInfo');
    const userProgress = document.getElementById('userProgress');

    // Глобальные переменные
    let allCourses = [];
    let userData = null;
    let userProgressData = {};

    // Получение URL превью курса
    async function getPreviewUrl(folder) {
      const base = `https://raw.githubusercontent.com/qhse-training/hse-course/main/${folder}`;
      const variants = ["Slide1.JPG", "%D0%A1%D0%BB%D0%B0%D0%B9%D0%B41.JPG", "slide1.jpg", "cover.jpg", "Slide1.jpeg", "slide1.jpeg"];
      for (let file of variants) {
        try {
          const res = await fetch(`${base}/${file}`, { method: 'HEAD' });
          if (res.ok) return `${base}/${file}`;
        } catch(e) {}
      }
      return 'https://via.placeholder.com/300x160?text=Нет+превью';
    }

    // Определение статуса курса
    function getCourseStatus(courseId) {
      const progress = userProgressData[courseId] || {};
      const slidesProgress = progress.slidesViewed || 0;
      const testPassed = progress.testPassed || false;
      const certificateGenerated = progress.certificateGenerated || false;
      const certificateId = progress.certificateId || null;

      if (certificateGenerated) {
        return { 
          status: 'completed', 
          progress: 100, 
          testAvailable: false,
          certificateId: certificateId
        };
      } else if (testPassed) {
        return { 
          status: 'test-passed', 
          progress: 100, 
          testAvailable: false 
        };
      } else if (slidesProgress >= 100) {
        return { 
          status: 'test-available', 
          progress: 100, 
          testAvailable: true 
        };
      } else if (slidesProgress > 0) {
        return { 
          status: 'in-progress', 
          progress: slidesProgress, 
          testAvailable: false 
        };
      } else {
        return { 
          status: 'not-started', 
          progress: 0, 
          testAvailable: false 
        };
      }
    }

    // Получение текста статуса
    function getStatusText(status) {
      const texts = {
        'not-started': 'Не начат',
        'in-progress': 'В процессе',
        'test-available': 'Тест доступен',
        'test-passed': 'Тест сдан',
        'completed': 'Завершен'
      };
      return texts[status] || status;
    }

    // Получение класса для бейджа статуса
    function getStatusClass(status) {
      const classes = {
        'not-started': 'status-not-started',
        'in-progress': 'status-in-progress',
        'test-available': 'status-test-available',
        'test-passed': 'status-in-progress',
        'completed': 'status-completed'
      };
      return classes[status] || 'status-not-started';
    }

    // Формирование правильного URL для курса
    function getCourseUrl(courseId) {
      // Используем относительный путь для GitHub Pages
      return `course.html?id=${encodeURIComponent(courseId)}`;
    }

    // Формирование правильного URL для теста
    function getTestUrl(course) {
      if (!course.testHtml) return '#';
      
      // Если testHtml уже полный URL, используем его
      if (course.testHtml.startsWith('http')) {
        return `${course.testHtml}?id=${encodeURIComponent(course.id)}`;
      }
      
      // Иначе формируем путь относительно GitHub Pages
      const baseUrl = 'https://qhse-training.github.io/hse-course';
      return `${baseUrl}/${course.testHtml}?id=${encodeURIComponent(course.id)}`;
    }

    // Показать существующий сертификат
    function showCertificate(certificateId, courseName, userName, date) {
      const certificateWindow = window.open('', '_blank');
      certificateWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Сертификат - ${courseName}</title>
          <style>
            body { 
              font-family: 'Arial', sans-serif; 
              padding: 40px; 
              text-align: center; 
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              min-height: 100vh;
              display: flex;
              justify-content: center;
              align-items: center;
            }
            .certificate-container {
              background: white;
              border-radius: 20px;
              padding: 40px;
              max-width: 800px;
              box-shadow: 0 20px 60px rgba(0,0,0,0.3);
              border: 15px solid #3498db;
              position: relative;
            }
            .certificate-container:before {
              content: '';
              position: absolute;
              top: -15px;
              left: -15px;
              right: -15px;
              bottom: -15px;
              border: 5px solid #2ecc71;
              border-radius: 30px;
              pointer-events: none;
            }
            h1 { 
              color: #2c3e50; 
              margin-bottom: 30px;
              font-size: 2.5em;
              text-transform: uppercase;
              letter-spacing: 2px;
            }
            h2 { 
              color: #3498db; 
              margin: 20px 0;
              font-size: 1.8em;
            }
            h3 { 
              color: #e74c3c; 
              margin: 30px 0;
              font-size: 2em;
              padding: 10px;
              border-bottom: 2px solid #3498db;
              display: inline-block;
            }
            .signature { 
              margin-top: 60px; 
              display: flex; 
              justify-content: space-around;
              align-items: center;
              padding-top: 30px;
              border-top: 2px solid #eee;
            }
            .signature div {
              text-align: center;
            }
            .signature div:first-child {
              font-size: 1.2em;
              color: #2c3e50;
              font-weight: bold;
            }
            .certificate-id {
              background: #f8f9fa;
              padding: 10px 20px;
              border-radius: 10px;
              font-family: monospace;
              color: #7f8c8d;
              margin-top: 20px;
              display: inline-block;
            }
            .watermark {
              position: absolute;
              opacity: 0.1;
              font-size: 120px;
              transform: rotate(-45deg);
              top: 30%;
              left: 10%;
              white-space: nowrap;
              color: #3498db;
            }
          </style>
        </head>
        <body>
          <div class="certificate-container">
            <div class="watermark">СЕРТИФИКАТ</div>
            <h1>Сертификат о прохождении курса</h1>
            <h2>${courseName}</h2>
            <p style="font-size: 1.2em; margin: 30px 0;">Настоящим удостоверяется, что</p>
            <h3>${userName}</h3>
            <p style="font-size: 1.2em; margin: 20px 0;">успешно завершил(а) обучение по курсу</p>
            <p style="font-size: 1.1em; color: #7f8c8d; margin: 20px 0;">
              и продемонстрировал(а) необходимые знания и навыки
            </p>
            <p style="font-size: 1.3em; margin: 30px 0; color: #2c3e50;">
              ${date}
            </p>
            <div class="signature">
              <div>
                <div style="margin-bottom: 10px;">_________________________</div>
                <div>Подпись руководителя</div>
              </div>
              <div>
                <div style="margin-bottom: 10px;">_________________________</div>
                <div>Печать организации</div>
              </div>
            </div>
            <div class="certificate-id">ID сертификата: ${certificateId}</div>
          </div>
          <script>
            window.onload = function() {
              // Автоматически предлагаем печать
              setTimeout(() => {
                if (confirm('Распечатать сертификат?')) {
                  window.print();
                }
              }, 500);
            }
          <\/script>
        </body>
        </html>
      `);
    }

    // Рендеринг карточек курсов
    function renderCourses(courses) {
      if (!courses.length) {
        courseList.innerHTML = '<div class="loading">Курсы не найдены</div>';
        return;
      }
      
      courseList.innerHTML = '';
      
      courses.forEach(course => {
        const status = getCourseStatus(course.id);
        const card = document.createElement('div');
        card.className = 'course-card';
        
        card.innerHTML = `
          <div class="course-image" style="background-image:url('${course.slideUrl}')">
            <div class="progress-overlay">
              <div class="progress-bar" style="width: ${status.progress}%"></div>
            </div>
          </div>
          <div class="course-body">
            <h3 class="course-title">${course.title || 'Без названия'}</h3>
            <div class="course-status">
              <span class="status-badge ${getStatusClass(status.status)}">
                ${getStatusText(status.status)}
              </span>
              <span>${Math.round(status.progress)}%</span>
            </div>
            <p class="course-desc">${course.description || 'Описание отсутствует'}</p>
            <div class="course-meta">
              <span>${course.duration || 'Длительность не указана'}</span>
              <span>${course.modules || 0} модулей</span>
            </div>
            <div class="course-actions">
              <a href="${getCourseUrl(course.id)}" class="btn">${status.progress > 0 ? 'Продолжить' : 'Начать курс'}</a>
              ${course.testHtml ? `
                <button class="btn btn-test" ${status.testAvailable ? '' : 'disabled'} 
                  onclick="window.open('${getTestUrl(course)}', '_blank')">
                  Пройти тест
                </button>
              ` : ''}
              ${status.status === 'completed' ? `
                <button class="btn btn-certificate" onclick="showExistingCertificate('${course.id}')">
                  Сертификат
                </button>
              ` : ''}
            </div>
          </div>
        `;
        
        courseList.appendChild(card);
      });
    }

    // Загрузка данных пользователя и курсов
    async function loadUserData(user) {
      try {
        // Загрузка данных пользователя
        const userDoc = await db.collection("approved_users").doc(user.uid).get();
        
        if (!userDoc.exists) {
          console.error("Пользователь не найден в approved_users");
          courseList.innerHTML = `
            <div class="loading">
              <h3>Доступ запрещен</h3>
              <p>Ваша учетная запись не найдена в системе</p>
            </div>
          `;
          return false;
        }
        
        userData = userDoc.data();
        userInfo.textContent = `${userData.fullName || user.email} (${user.email})`;
        
        // Загрузка прогресса пользователя
        const progressDoc = await db.collection("user_progress").doc(user.uid).get();
        userProgressData = progressDoc.exists ? progressDoc.data() : {};
        
        // Расчет общего прогресса
        const courseIds = userData.courses || [];
        const totalProgress = courseIds.reduce((sum, courseId) => {
          const progress = userProgressData[courseId] || {};
          return sum + (progress.slidesViewed || 0);
        }, 0);
        
        const completedCourses = courseIds.filter(courseId => {
          const progress = userProgressData[courseId] || {};
          return progress.certificateGenerated === true;
        }).length;
        
        const avgProgress = courseIds.length > 0 ? Math.round(totalProgress / courseIds.length) : 0;
        
        userProgress.textContent = `Прогресс: ${avgProgress}% | Завершено: ${completedCourses}/${courseIds.length} курсов`;
        
        // Если нет назначенных курсов
        if (courseIds.length === 0) {
          courseList.innerHTML = `
            <div class="loading" style="grid-column: 1 / -1;">
              <h3>Курсы не назначены</h3>
              <p>Обратитесь к администратору для назначения курсов</p>
            </div>
          `;
          return true;
        }
        
        // Загрузка данных курсов
        const courses = [];
        for (let courseId of courseIds) {
          try {
            const courseDoc = await db.collection('courses').doc(courseId).get();
            if (courseDoc.exists) {
              const courseData = courseDoc.data();
              const preview = await getPreviewUrl(courseId);
              courses.push({
                id: courseId,
                title: courseData.title || `Курс ${courseId}`,
                description: courseData.description || '',
                testHtml: courseData.testHtml || null,
                duration: courseData.duration || 'Не указано',
                modules: courseData.modules || 0,
                slideUrl: preview
              });
            }
          } catch (error) {
            console.error(`Ошибка загрузки курса ${courseId}:`, error);
          }
        }
        
        allCourses = courses;
        renderCourses(allCourses);
        return true;
        
      } catch (error) {
        console.error("Ошибка загрузки данных:", error);
        courseList.innerHTML = `
          <div class="loading">
            <h3>Ошибка загрузки данных</h3>
            <p>Попробуйте обновить страницу</p>
          </div>
        `;
        return false;
      }
    }

    // Показать существующий сертификат
    async function showExistingCertificate(courseId) {
      try {
        const user = auth.currentUser;
        if (!user) return;
        
        const progress = userProgressData[courseId] || {};
        if (!progress.certificateGenerated || !progress.certificateId) {
          alert('Сертификат еще не был сгенерирован');
          return;
        }
        
        const course = allCourses.find(c => c.id === courseId);
        const userName = userData.fullName || user.email;
        const courseName = course?.title || 'Курс';
        const date = progress.certificateDate ? 
          new Date(progress.certificateDate).toLocaleDateString('ru-RU') : 
          new Date().toLocaleDateString('ru-RU');
        
        showCertificate(progress.certificateId, courseName, userName, date);
        
      } catch (error) {
        console.error("Ошибка показа сертификата:", error);
        alert('Ошибка при открытии сертификата');
      }
    }

    // Основная инициализация
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }

      // Кнопка выхода
      document.getElementById('logoutBtn').addEventListener('click', () => {
        auth.signOut().then(() => location.href = 'login.html');
      });

      // Загрузка данных
      await loadUserData(user);

      // Поиск курсов
      searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        if (!searchTerm) {
          renderCourses(allCourses);
          return;
        }
        
        const filtered = allCourses.filter(c => 
          (c.title || '').toLowerCase().includes(searchTerm) || 
          (c.description || '').toLowerCase().includes(searchTerm)
        );
        renderCourses(filtered);
      });
    });

    // Обработка ошибок
    window.addEventListener('error', function(e) {
      console.error('Global error:', e.error);
    });
  </script>
</body>
</html>