<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Мои курсы</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f8f8f8; margin: 0; }
    header { background: #3498db; color: #fff; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
    .course-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; padding: 20px; }
    .course-card { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; flex-direction: column; position: relative; }
    .course-image { height: 160px; background-size: cover; background-position: center; position: relative; }
    .progress-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(52, 152, 219, 0.8); height: 4px; }
    .progress-bar { background: #2ecc71; height: 100%; width: 0%; transition: width 0.3s; }
    .course-body { padding: 15px; flex: 1; display: flex; flex-direction: column; }
    .course-title { margin: 0 0 10px; font-size: 18px; }
    .course-desc { flex: 1; color: #555; margin-bottom: 10px; }
    .course-status { font-size: 14px; margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }
    .status-badge { padding: 3px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; }
    .status-not-started { background: #e74c3c; color: white; }
    .status-in-progress { background: #f39c12; color: white; }
    .status-test-available { background: #3498db; color: white; }
    .status-completed { background: #2ecc71; color: white; }
    .course-actions { margin-top: 10px; display: flex; gap: 10px; }
    .btn { padding: 8px 12px; background: #3498db; color: white; text-decoration: none; border-radius: 5px; text-align: center; cursor: pointer; border: none; font-size: 14px; }
    .btn:hover { opacity: 0.9; transform: translateY(-2px); transition: all 0.3s; }
    .btn-test { background: #e67e22; }
    .btn-test:disabled { background: #95a5a6; cursor: not-allowed; opacity: 0.6; transform: none; }
    .btn-certificate { background: #9b59b6; }
    .btn-certificate:hover { background: #8e44ad; }
    #searchInput { width: 100%; padding: 10px; border: none; border-bottom: 1px solid #ccc; font-size: 16px; }
    .course-meta { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; font-size: 12px; color: #7f8c8d; }
    .loading { text-align: center; padding: 40px; color: #7f8c8d; }
    .no-courses { text-align: center; padding: 40px; color: #7f8c8d; grid-column: 1 / -1; }
    .error-container { 
      text-align: center; 
      padding: 40px; 
      color: #e74c3c; 
      grid-column: 1 / -1;
      background: #fff;
      border-radius: 8px;
      margin: 20px;
    }
    .retry-btn {
      background: #3498db;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 15px;
      font-size: 14px;
      transition: all 0.3s;
    }
    .retry-btn:hover {
      background: #2980b9;
      transform: translateY(-2px);
    }
  </style>
</head>
<body>
  <header>
    <div>
      <div id="userInfo">Загрузка...</div>
      <div id="userProgress" style="font-size: 12px; opacity: 0.9;"></div>
    </div>
    <button id="logoutBtn" style="background:#e74c3c;color:#fff;border:none;padding:6px 12px;border-radius:5px;cursor:pointer;transition:all 0.3s;">Выйти</button>
  </header>

  <input type="text" id="searchInput" placeholder="Поиск курсов...">

  <div class="course-list" id="courseList">
    <div class="loading">Загрузка курсов...</div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDQXNLAsqmSlAjplpdl2anPSyiDxbz3CjY",
      authDomain: "qhse-training.firebaseapp.com",
      projectId: "qhse-training",
      storageBucket: "qhse-training.appspot.com",
      messagingSenderId: "4501351718",
      appId: "1:4501351718:web:503b00c9ac052b58e2e5e7"
    };
    
    // Инициализация Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM элементы
    const courseList = document.getElementById('courseList');
    const searchInput = document.getElementById('searchInput');
    const userInfo = document.getElementById('userInfo');
    const userProgress = document.getElementById('userProgress');

    // Глобальные переменные
    let allCourses = [];
    let userData = null;
    let userProgressData = {};
    let currentUser = null;

    // Карта соответствия ID курса и папки курса
    const courseFolderMap = {
      // Курс 1.01
      '0EFXo6H4N1mbA1jBJwOK': '1.01.Occupational_Health_and_Safety_Management_System',
      // Добавьте здесь соответствия для других курсов
      // Пример:
      // 'ДРУГОЙ_ID_КУРСА': '1.02.Hierarchy_of_hazard_controls',
    };

    // Получение папки курса по его ID
    function getCourseFolder(courseId) {
      // Если есть в карте, используем из карты
      if (courseFolderMap[courseId]) {
        return courseFolderMap[courseId];
      }
      
      // По умолчанию используем первую папку
      return '1.01.Occupational_Health_and_Safety_Management_System';
    }

    // Получение номера курса из папки
    function getCourseNumber(folderName) {
      // Извлекаем номер из названия папки
      const match = folderName.match(/^(\d+\.\d+)/);
      if (match) {
        const parts = match[1].split('.');
        return parts[1]; // Возвращаем вторую часть (01, 02, и т.д.)
      }
      return '1'; // По умолчанию
    }

    // Получение URL превью курса
    async function getPreviewUrl(courseId, folderName = null) {
      const folder = folderName || getCourseFolder(courseId);
      const base = `https://raw.githubusercontent.com/qhse-training/hse-course/main/${folder}`;
      
      const variants = [
        "Slide1.JPG",
        "%D0%A1%D0%BB%D0%B0%D0%B9%D0%B41.JPG",
        "slide1.jpg",
        "cover.jpg",
        "Slide1.jpeg",
        "slide1.jpeg",
        "Slide1.png",
        "slide1.png"
      ];
      
      for (let file of variants) {
        try {
          const res = await fetch(`${base}/${file}`, { method: 'HEAD' });
          if (res.ok) return `${base}/${file}`;
        } catch(e) {}
      }
      
      return 'https://via.placeholder.com/300x160?text=Курс';
    }

    // Определение статуса курса
    function getCourseStatus(courseId) {
      const progress = userProgressData[courseId] || {};
      const slidesProgress = progress.slidesViewed || 0;
      const testPassed = progress.testPassed || false;
      const certificateGenerated = progress.certificateGenerated || false;
      const certificateId = progress.certificateId || null;

      if (certificateGenerated) {
        return { 
          status: 'completed', 
          progress: 100, 
          testAvailable: false,
          certificateId: certificateId
        };
      } else if (testPassed) {
        return { 
          status: 'test-passed', 
          progress: 100, 
          testAvailable: false 
        };
      } else if (slidesProgress >= 100) {
        return { 
          status: 'test-available', 
          progress: 100, 
          testAvailable: true 
        };
      } else if (slidesProgress > 0) {
        return { 
          status: 'in-progress', 
          progress: slidesProgress, 
          testAvailable: false 
        };
      } else {
        return { 
          status: 'not-started', 
          progress: 0, 
          testAvailable: false 
        };
      }
    }

    // Получение текста статуса
    function getStatusText(status) {
      const texts = {
        'not-started': 'Не начат',
        'in-progress': 'В процессе',
        'test-available': 'Тест доступен',
        'test-passed': 'Тест сдан',
        'completed': 'Завершен'
      };
      return texts[status] || status;
    }

    // Получение класса для бейджа статуса
    function getStatusClass(status) {
      const classes = {
        'not-started': 'status-not-started',
        'in-progress': 'status-in-progress',
        'test-available': 'status-test-available',
        'test-passed': 'status-in-progress',
        'completed': 'status-completed'
      };
      return classes[status] || 'status-not-started';
    }

    // Формирование правильного URL для курса - БЕЗ ID параметра
    function getCourseUrl(course) {
      const folderName = course.folderName || getCourseFolder(course.id);
      const courseNumber = getCourseNumber(folderName);
      
      // Простая ссылка без ID параметра
      return `https://qhse-training.github.io/hse-course/${folderName}/course${courseNumber}.html`;
    }

    // Формирование правильного URL для теста - БЕЗ ID параметра
    function getTestUrl(course) {
      const folderName = course.folderName || getCourseFolder(course.id);
      const courseNumber = getCourseNumber(folderName);
      
      // Простая ссылка без ID параметра
      return `https://qhse-training.github.io/hse-course/${folderName}/test${courseNumber}.html`;
    }

    // Показать сертификат
    function showExistingCertificate(courseId) {
      alert('Функция сертификата будет доступна после завершения курса и прохождения теста.');
    }

    // Рендеринг карточек курсов
    function renderCourses(courses) {
      if (!courses.length) {
        courseList.innerHTML = '<div class="no-courses">Курсы не найдены</div>';
        return;
      }
      
      courseList.innerHTML = '';
      
      courses.forEach(course => {
        const status = getCourseStatus(course.id);
        const card = document.createElement('div');
        card.className = 'course-card';
        
        card.innerHTML = `
          <div class="course-image" style="background-image:url('${course.slideUrl}')">
            <div class="progress-overlay">
              <div class="progress-bar" style="width: ${status.progress}%"></div>
            </div>
          </div>
          <div class="course-body">
            <h3 class="course-title">${course.title || 'Курс'}</h3>
            <div class="course-status">
              <span class="status-badge ${getStatusClass(status.status)}">
                ${getStatusText(status.status)}
              </span>
              <span>${Math.round(status.progress)}%</span>
            </div>
            <p class="course-desc">${course.description || 'Описание курса'}</p>
            <div class="course-meta">
              <span>${course.duration || 'Не указано'}</span>
              <span>${course.modules || 0} модулей</span>
            </div>
            <div class="course-actions">
              <a href="${getCourseUrl(course)}" target="_blank" class="btn">${status.progress > 0 ? 'Продолжить' : 'Начать курс'}</a>
              ${course.testHtml || status.testAvailable ? `
                <button class="btn btn-test" ${status.testAvailable ? '' : 'disabled'} 
                  onclick="window.open('${getTestUrl(course)}', '_blank')">
                  Пройти тест
                </button>
              ` : ''}
              ${status.status === 'completed' ? `
                <button class="btn btn-certificate" onclick="showExistingCertificate('${course.id}')">
                  Сертификат
                </button>
              ` : ''}
            </div>
          </div>
        `;
        
        courseList.appendChild(card);
      });
    }

    // Загрузка данных пользователя и курсов
    async function loadUserData(user) {
      try {
        currentUser = user;
        
        userInfo.textContent = `${user.email}`;
        
        try {
          // Загружаем данные пользователя
          const userDoc = await db.collection("approved_users").doc(user.uid).get();
          
          if (!userDoc.exists) {
            showNoAccessMessage(user);
            return false;
          }
          
          userData = userDoc.data();
          userInfo.textContent = `${userData.fullName || user.email} (${user.email})`;
          
          // Загружаем прогресс пользователя
          const progressDoc = await db.collection("user_progress").doc(user.uid).get();
          userProgressData = progressDoc.exists ? progressDoc.data() : {};
          
          // Получаем ID курсов пользователя
          const userCourseIds = userData.courses || [];
          
          if (userCourseIds.length === 0) {
            courseList.innerHTML = `
              <div class="no-courses">
                <h3>Курсы не назначены</h3>
                <p>Обратитесь к администратору для назначения курсов</p>
              </div>
            `;
            userProgress.textContent = `Курсы: 0 назначено`;
            return true;
          }
          
          // Загружаем данные каждого курса
          const courses = [];
          const coursePromises = userCourseIds.map(async (courseId) => {
            try {
              const courseDoc = await db.collection('courses').doc(courseId).get();
              if (courseDoc.exists) {
                const courseData = courseDoc.data();
                
                // Определяем папку курса
                let folderName = courseData.folderName;
                if (!folderName) {
                  folderName = getCourseFolder(courseId);
                }
                
                // Получаем превью
                const preview = await getPreviewUrl(courseId, folderName);
                
                return {
                  id: courseId,
                  folderName: folderName,
                  title: courseData.title || `Курс`,
                  description: courseData.description || 'Описание курса',
                  testHtml: courseData.testHtml || null,
                  duration: courseData.duration || 'Не указано',
                  modules: courseData.modules || 0,
                  slideUrl: preview,
                  slides: courseData.slides || []
                };
              } else {
                console.warn(`Курс ${courseId} не найден в коллекции courses`);
                return null;
              }
            } catch (error) {
              console.error(`Ошибка загрузки курса ${courseId}:`, error);
              return null;
            }
          });
          
          // Ждем загрузки всех курсов
          const courseResults = await Promise.all(coursePromises);
          allCourses = courseResults.filter(course => course !== null);
          
          // Расчет статистики
          const totalProgress = userCourseIds.reduce((sum, courseId) => {
            const progress = userProgressData[courseId] || {};
            return sum + (progress.slidesViewed || 0);
          }, 0);
          
          const completedCourses = userCourseIds.filter(courseId => {
            const progress = userProgressData[courseId] || {};
            return progress.certificateGenerated === true;
          }).length;
          
          const avgProgress = userCourseIds.length > 0 ? Math.round(totalProgress / userCourseIds.length) : 0;
          
          userProgress.textContent = `Прогресс: ${avgProgress}% | Завершено: ${completedCourses}/${userCourseIds.length} курсов`;
          
          // Рендеринг курсов
          renderCourses(allCourses);
          return true;
          
        } catch (dbError) {
          console.error("Ошибка Firestore:", dbError);
          showErrorMessage(dbError);
          return false;
        }
        
      } catch (error) {
        console.error("Общая ошибка:", error);
        showErrorMessage(error);
        return false;
      }
    }

    // Показать сообщение об отсутствии доступа
    function showNoAccessMessage(user) {
      courseList.innerHTML = `
        <div class="error-container">
          <h3>Доступ не предоставлен</h3>
          <p>Ваша учетная запись (${user.email}) не имеет доступа к курсам.</p>
          <p>Обратитесь к администратору для получения доступа.</p>
        </div>
      `;
      userProgress.textContent = "Ожидание доступа к курсам";
    }

    // Показать сообщение об ошибке
    function showErrorMessage(error) {
      let message = "Ошибка загрузки данных";
      let details = "";
      
      if (error.code === 'permission-denied') {
        message = "Недостаточно прав доступа";
        details = "Проверьте настройки безопасности Firebase или обратитесь к администратору.";
      } else if (error.code === 'unavailable') {
        message = "Сервис временно недоступен";
        details = "Проверьте подключение к интернету.";
      }
      
      courseList.innerHTML = `
        <div class="error-container">
          <h3>${message}</h3>
          <p>${details}</p>
          <p style="font-size: 12px; color: #95a5a6;">Код: ${error.code || 'неизвестно'}</p>
          <button class="retry-btn" onclick="window.location.reload()">⟳ Обновить страницу</button>
        </div>
      `;
      
      userProgress.textContent = "Ошибка загрузки данных";
    }

    // Основная инициализация
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }

      // Кнопка выхода
      document.getElementById('logoutBtn').addEventListener('click', () => {
        auth.signOut().then(() => location.href = 'login.html');
      });

      // Загрузка данных
      await loadUserData(user);

      // Поиск курсов
      searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        if (!searchTerm) {
          renderCourses(allCourses);
          return;
        }
        
        const filtered = allCourses.filter(c => 
          (c.title || '').toLowerCase().includes(searchTerm) || 
          (c.description || '').toLowerCase().includes(searchTerm)
        );
        renderCourses(filtered);
      });
    });

    // Обработка ошибок
    window.addEventListener('error', function(e) {
      console.error('Global error:', e.error);
    });
  </script>
</body>
</html>