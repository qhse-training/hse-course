<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Тест — Система управления по охране труда (СУОТ)</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin:20px auto; background:#f7f9fb; padding:20px; }
    h1 { text-align:center; color:#233; }
    .meta { margin:12px 0; background:#fff; padding:12px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.05); }
    .question { background:#fff; padding:14px; margin:12px 0; border-radius:8px; box-shadow:0 1px 4px rgba(0,0,0,0.04); }
    .question p { font-weight:600; margin:0 0 8px 0; }
    label { display:block; margin:6px 0; cursor:pointer; padding:6px 8px; border-radius:6px; }
    label:hover { background:#f0f8ff; }
    #submitBtn { display:block; margin:20px auto; padding:12px 22px; font-size:16px; background:#2c9b4a; color:#fff; border:none; border-radius:8px; cursor:pointer; }
    #result { margin-top:18px; text-align:center; padding:12px; background:#fff; border-radius:8px; box-shadow:0 1px 4px rgba(0,0,0,0.04); }
    .code { font-family:monospace; background:#f4f4f4; padding:4px 8px; border-radius:4px; }
  </style>
</head>
<body>
  <h1>Тест — Система управления по охране труда (СУОТ)</h1>

  <div class="meta">
    Пользователь: <span id="userName">Загрузка...</span><br>
    Электронная почта: <span id="userEmail">—</span><br>
    Курс: <span id="courseTitle">Система управления по охране труда (СУОТ)</span>
  </div>

  <form id="testForm"></form>

  <button id="submitBtn">Отправить тест</button>

  <div id="result"></div>

<script>
/* ---------------- Firebase config (use provided keys) ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyDQXNLAsqmSlAjplpdl2anPSyiDxbz3CjY",
  authDomain: "qhse-training.firebaseapp.com",
  projectId: "qhse-training",
  storageBucket: "qhse-training.appspot.com",
  messagingSenderId: "4501351718",
  appId: "1:4501351718:web:503b00c9ac052b58e2e5e7"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ---------------- Settings ---------------- */
const VERIFY_SITE = "https://qhsesolutions.kz/login";
const DEFAULT_COURSE_TITLE = "Система управления по охране труда (СУОТ)";
const CERT_THRESHOLD = 100; // сертификат только при 100%

/* ---------------- Questions (20) and correct answers (index 0..3) ---------------- */
const questions = [
  { q: "1. Какова основная цель OHSMS?", a: ["Увеличение прибыли","Сокращение рабочего времени","Обеспечение безопасности на рабочем месте","Снижение затрат"], correct: 2 },
  { q: "2. Какой стандарт обычно используется для OHSMS?", a: ["ISO 9001","ISO 14001","ISO 45001","ISO 27001"], correct: 2 },
  { q: "3. Какой первый шаг при внедрении OHSMS?", a: ["Найм консультанта","Оценка рисков","Написание процедур","Обучение сотрудников"], correct: 1 },
  { q: "4. Что означает PDCA в OHSMS?", a: ["Планируй, Делай, Проверяй, Действуй","Подготавливай, Разрабатывай, Контролируй, Анализируй","Предотвращай, Обнаруживай, Исправляй, Аудируй","Проверяй, Делай, Планируй, Анализируй"], correct: 0 },
  { q: "5. Кто несет окончательную ответственность за безопасность на рабочем месте?", a: ["Сотрудники","Специалисты по охране труда","Руководство","Государство"], correct: 2 },
  { q: "6. Что такое опасность в терминах OHSMS?", a: ["Происшествие, которое уже случилось","Потенциальный источник вреда","Процедура безопасности","Тип СИЗ"], correct: 1 },
  { q: "7. Какова цель оценки рисков?", a: ["Назначение вины за аварии","Выявление и контроль опасностей на рабочем месте","Сокращение льгот сотрудников","Увеличение скорости производства"], correct: 1 },
  { q: "8. Что означает СИЗ?", a: ["Средства индивидуальной защиты","Система измерения затрат","Стандартные измерительные знаки","Система информационной защиты"], correct: 0 },
  { q: "9. Когда следует проводить обучение по технике безопасности?", a: ["Только при приеме на работу","При приеме и при изменении рисков","Только после инцидента","Раз в пять лет"], correct: 1 },
  { q: "10. Что такое инцидент в терминах OHSMS?", a: ["Планируемая проверка","Незапланированное событие, которое может причинить вред","Собрание комитета по безопасности","Отчет о производительности"], correct: 1 },
  { q: "11. Какова цель аудита безопасности?", a: ["Поиск нарушителей","Оценка эффективности систем безопасности","Сокращение затрат на оборудование","Повышение производительности"], correct: 1 },
  { q: "12. Что сделать в первую очередь при аварии?", a: ["Назначить виновного","Обезопасить место и оказать первую помощь","Продолжить работу","Сообщить СМИ"], correct: 1 },
  { q: "13. Что такое 'опасное происшествие'?", a: ["Инцидент с травмой","Незапланированное событие без вреда","Проверка безопасности","Оповещение руководства"], correct: 1 },
  { q: "14. Почему важно участие работников в OHSMS?", a: ["Работники лучше знают опасности","Снижает нагрузку на руководство","Требуется законом","Все перечисленное"], correct: 3 },
  { q: "15. Что такое иерархия мер контроля?", a: ["Список руководителей","Система приоритезации мер контроля","Тип обучения","План реагирования"], correct: 1 },
  { q: "16. Какая мера контроля опасностей наиболее эффективна?", a: ["СИЗ","Устранение","Предупреждающие знаки","Обучение"], correct: 1 },
  { q: "17. Что такое культура безопасности?", a: ["Государственное агентство","Общие ценности в отношении безопасности","Программа обучения","Документ"], correct: 1 },
  { q: "18. Зачем документировать процедуры безопасности?", a: ["Соответствие закону","Единые стандарты работы","Обучение","Все перечисленное"], correct: 3 },
  { q: "19. Что такое непрерывное улучшение в OHSMS?", a: ["Единоразовый аудит","Постоянный процесс повышения безопасности","Государственное требование","План обучения"], correct: 1 },
  { q: "20. Какова роль руководства в OHSMS?", a: ["Обеспечение ресурсами","Контроль соблюдения правил","Проведение проверок","Все перечисленное"], correct: 3 }
];

/* ---------------- DOM refs ---------------- */
const form = document.getElementById('testForm');
const submitBtn = document.getElementById('submitBtn');
const resultDiv = document.getElementById('result');
const userNameEl = document.getElementById('userName');
const userEmailEl = document.getElementById('userEmail');
const courseTitleEl = document.getElementById('courseTitle');

/* ---------------- State ---------------- */
let uidFromURL = null;
let courseIdFromURL = null;
let currentUID = null;
let currentUserEmail = '';
let currentUserName = '';
let currentCourseId = null;
let currentCourseTitle = DEFAULT_COURSE_TITLE;

/* --------------- Helpers --------------- */
function getUrlParams() {
  const p = new URLSearchParams(window.location.search);
  uidFromURL = p.get('uid');
  courseIdFromURL = p.get('courseId');
}

/* render questions */
function renderTest() {
  form.innerHTML = '';
  questions.forEach((item, idx) => {
    const div = document.createElement('div');
    div.className = 'question';
    const p = document.createElement('p');
    p.textContent = item.q;
    div.appendChild(p);
    item.a.forEach((opt, i) => {
      const id = `q${idx}_o${i}`;
      const label = document.createElement('label');
      label.htmlFor = id;
      label.innerHTML = `<input id="${id}" type="radio" name="q${idx}" value="${i}"> ${opt}`;
      div.appendChild(label);
    });
    form.appendChild(div);
  });
}

/* score test */
function scoreTest() {
  let correct = 0;
  questions.forEach((item, idx) => {
    const sel = form.querySelector(`input[name="q${idx}"]:checked`);
    if (sel && parseInt(sel.value) === item.correct) correct++;
  });
  return { correct, total: questions.length, percent: Math.round((correct / questions.length) * 100) };
}

/* create unique code (28 chars) */
function makeUniqueCode() {
  if (window.crypto && window.crypto.randomUUID) {
    return crypto.randomUUID().replace(/-/g,'').slice(0,28);
  }
  return ('C' + Date.now().toString(36) + Math.random().toString(36).slice(2,10)).toUpperCase();
}

/* generate and download PDF certificate */
function generateCertificatePdf(name, course, dateStr, uniqueCode, certificateId) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt', format:'a4'});
  const pageW = doc.internal.pageSize.getWidth();

  doc.setFontSize(26);
  doc.setTextColor(30, 50, 70);
  doc.text("СЕРТИФИКАТ О ЗАВЕРШЕНИИ", pageW/2, 100, { align: "center" });

  doc.setFontSize(14);
  doc.setTextColor(0,0,0);
  doc.text("Настоящий сертификат подтверждает, что", pageW/2, 140, { align: "center" });

  doc.setFontSize(22);
  doc.setTextColor(10, 90, 50);
  doc.text(name, pageW/2, 175, { align: "center" });

  doc.setFontSize(14);
  doc.setTextColor(0,0,0);
  doc.text("успешно завершил(а) курс", pageW/2, 200, { align: "center" });

  doc.setFontSize(18);
  doc.text(course, pageW/2, 230, { align: "center" });

  doc.setFontSize(12);
  doc.text(`Дата: ${dateStr}`, 80, 500);
  doc.text("Подпись: QHSE-Solutions.kz", 80, 520);

  // verification link & code
  doc.setFontSize(10);
  doc.text(`Проверить подлинность сертификата: ${VERIFY_SITE}`, 80, 540);
  doc.text(`Код сертификата: ${uniqueCode}`, 80, 556);
  doc.text(`certificateId (в базе): ${certificateId}`, 80, 572);

  // decorative border
  doc.setDrawColor(140);
  doc.setLineWidth(1);
  doc.rect(40, 40, pageW-80, doc.internal.pageSize.getHeight()-80);

  const filename = `${(course || 'course').replace(/\s+/g,'_')}_${(name || 'user').replace(/\s+/g,'_')}_Сертификат.pdf`;
  doc.save(filename);
}

/* update UI user/course */
function setUserAndCourseUI() {
  userNameEl.textContent = currentUserName || 'Без имени';
  userEmailEl.textContent = currentUserEmail || '—';
  courseTitleEl.textContent = currentCourseTitle || DEFAULT_COURSE_TITLE;
  document.title = `Тест — ${currentCourseTitle}`;
}

/* ---------------- Main flow ---------------- */
getUrlParams();
renderTest();

/* auth state — prefer currentUser, but if uid passed in URL use that to fetch name */
auth.onAuthStateChanged(async (user) => {
  try {
    // determine uid to use
    const uidToUse = uidFromURL || (user ? user.uid : null);
    currentUID = uidToUse;

    // if sessionStorage contains userName from Dashboard, read it
    const sessionName = sessionStorage.getItem('userName');

    if (uidToUse) {
      // fetch approved_users doc for precise name
      const doc = await db.collection('approved_users').doc(uidToUse).get();
      if (doc.exists) {
        const data = doc.data();
        currentUserName = data.displayName || data.fullName || sessionName || (user ? user.displayName : '') || '';
        currentUserEmail = data.email || (user ? user.email : '') || '';
      } else {
        // fallback to current auth user info or session
        currentUserName = sessionName || (user ? (user.displayName || user.email) : 'Гость');
        currentUserEmail = (user && user.email) ? user.email : '';
      }
    } else {
      // no uid available
      currentUserName = sessionName || (user ? (user.displayName || user.email) : 'Гость');
      currentUserEmail = (user && user.email) ? user.email : '';
    }

    // course title: if courseId in URL, try to fetch course doc
    if (courseIdFromURL) {
      currentCourseId = courseIdFromURL;
      const cdoc = await db.collection('courses').doc(courseIdFromURL).get();
      if (cdoc.exists) {
        currentCourseTitle = cdoc.data().title || DEFAULT_COURSE_TITLE;
      } else {
        currentCourseTitle = DEFAULT_COURSE_TITLE;
      }
    } else {
      currentCourseId = '';
      currentCourseTitle = DEFAULT_COURSE_TITLE;
    }

    setUserAndCourseUI();
  } catch (err) {
    console.error('Ошибка при загрузке пользователя/курса:', err);
    // still set UI from defaults/session
    const sessionName = sessionStorage.getItem('userName');
    currentUserName = currentUserName || sessionName || 'Гость';
    setUserAndCourseUI();
  }
});

/* ---------------- Submit handler ---------------- */
submitBtn.addEventListener('click', async (e) => {
  e.preventDefault();
  resultDiv.innerHTML = 'Проверка...';

  const { correct, total, percent } = scoreTest();

  // update course_progress doc id
  const uidForWrite = currentUID || (auth.currentUser ? auth.currentUser.uid : null);
  const cpDocId = (uidForWrite ? `${uidForWrite}_` : '') + (currentCourseId || 'unknownCourse');

  try {
    if (percent >= CERT_THRESHOLD) {
      // create unique code & write certificate doc
      const uniqueCode = makeUniqueCode();
      const issueDate = new Date().toISOString();

      const certData = {
        uid: uidForWrite || '',
        email: currentUserEmail || '',
        courseId: currentCourseId || '',
        userName: currentUserName || '',
        uniqueCode,
        issueDate,
        verified: false
      };

      const certRef = await db.collection('certificates').add(certData);
      const certificateId = certRef.id;

      // update course_progress
      const verifyUrl = `${VERIFY_SITE}?code=${uniqueCode}`;
      await db.collection('course_progress').doc(cpDocId).set({
        passed: true,
        score: percent,
        progress: 100,
        certificateUrl: verifyUrl,
        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });

      // generate PDF and download
      const today = new Date();
      const dateStr = `${String(today.getDate()).padStart(2,'0')}.${String(today.getMonth()+1).padStart(2,'0')}.${today.getFullYear()}`;
      generateCertificatePdf(currentUserName || 'Без имени', currentCourseTitle, dateStr, uniqueCode, certificateId);

      resultDiv.innerHTML = `<div style="color:green;">Поздравляем! Вы прошли тест на 100%. Сертификат скачан.<br>Код сертификата: <span class="code">${uniqueCode}</span></div>`;
    } else {
      // update course_progress as failed attempt
      await db.collection('course_progress').doc(cpDocId).set({
        passed: false,
        score: percent,
        progress: Math.round((correct/total)*100),
        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });

      resultDiv.innerHTML = `<div style="color:red;">Вы набрали ${correct} из ${total} (${percent}%). Для выдачи сертификата требуется 100%.</div>`;
    }
  } catch (err) {
    console.error('Ошибка при обработке результатов:', err);
    resultDiv.innerHTML = `<div style="color:red;">Ошибка при сохранении результатов. Проверь консоль.</div>`;
  }

  // disable inputs after submit
  form.querySelectorAll('input').forEach(i => i.disabled = true);
  submitBtn.disabled = true;
});
</script>
</body>
</html>
