<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Админ-панель</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .top-bar span { font-weight: bold; }
    .tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #ccc; }
    .tab { padding: 10px 20px; cursor: pointer; border: 1px solid transparent; }
    .tab.active { border-color: #ccc; border-bottom-color: white; background: white; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 10px; border: 1px solid #ccc; vertical-align: top; }
    button { padding: 6px 12px; margin: 2px; cursor: pointer; }
    .approved { background: #d4edda; }
    .pending { background: #fff3cd; }
    .rejected { background: #f8d7da; }
    .status-badge { padding: 3px 8px; border-radius: 12px; font-size: 12px; display: inline-block; }
  </style>
</head>
<body>
  <div class="top-bar">
    <span>Админ UID: <span id="adminUid">Загрузка...</span></span>
    <button id="logoutBtn">Выйти</button>
  </div>

  <h1>Управление заявками</h1>
  
  <div class="tabs">
    <div class="tab active" data-tab="pending">Новые заявки</div>
    <div class="tab" data-tab="approved">Одобренные</div>
  </div>

  <div id="requestsContainer">Загрузка...</div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDQXNLAsqmSlAjplpdl2anPSyiDxbz3CjY",
      authDomain: "qhse-training.firebaseapp.com",
      projectId: "qhse-training"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    document.getElementById('logoutBtn').onclick = () => {
      auth.signOut().then(() => location.href = "login.html");
    };

    // Переключение вкладок
    document.querySelectorAll('.tab').forEach(tab => {
      tab.onclick = () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        loadRequests(tab.dataset.tab);
      };
    });

    async function loadRequests(status = 'pending') {
      const container = document.getElementById("requestsContainer");
      container.innerHTML = "Загрузка...";

      const user = auth.currentUser;
      if (!user) {
        container.innerHTML = "<p>Вы не авторизованы.</p>";
        return;
      }

      document.getElementById("adminUid").textContent = user.uid;

      // Проверка прав администратора
      const adminDoc = await db.collection("admins").doc(user.uid).get();
      if (!adminDoc.exists) {
        container.innerHTML = "<p>Нет прав администратора.</p>";
        return;
      }

      try {
        const courseDocs = await db.collection("courses").get();
        const courseMap = {};
        courseDocs.forEach(doc => courseMap[doc.id] = doc.data().title || doc.id);

        let query = db.collection("requests").orderBy("timestamp", "desc");
        if (status === 'pending') query = query.where("approved", "==", false);
        if (status === 'approved') query = query.where("approved", "==", true);

        const snapshot = await query.get();
        if (snapshot.empty) {
          container.innerHTML = `<p>${status === 'pending' ? 'Новых заявок нет.' : 'Нет одобренных заявок.'}</p>`;
          return;
        }

        const table = document.createElement("table");
        table.innerHTML = `
          <thead>
            <tr>
              <th>ФИО</th>
              <th>Email</th>
              <th>Телефон</th>
              <th>Курсы</th>
              <th>Статус</th>
              <th>Дата</th>
              <th>Действия</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        container.innerHTML = "";
        container.appendChild(table);
        const tbody = table.querySelector("tbody");

        for (const doc of snapshot.docs) {
          const data = doc.data();
          const courseTitles = (data.selectedCourses || []).map(id => courseMap[id] || id);
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${data.fullName || ""}</td>
            <td>${data.email || ""}</td>
            <td>${data.phone || ""}</td>
            <td>${courseTitles.join("<br>")}</td>
            <td>
              <span class="status-badge ${data.approved ? 'approved' : 'pending'}">
                ${data.approved ? "Одобрено" : "Ожидает"}
              </span>
            </td>
            <td>${data.timestamp?.toDate().toLocaleString() || ""}</td>
            <td></td>
          `;

          const actionsTd = tr.querySelector("td:last-child");
          if (status === 'pending') {
            const approveBtn = document.createElement("button");
            approveBtn.textContent = "Одобрить";
            approveBtn.onclick = async () => {
              if (!data.userId) {
                alert("UID отсутствует. Нельзя одобрить заявку.");
                return;
              }

              try {
                await db.collection("requests").doc(doc.id).update({ approved: true });

                await db.collection("approved_users").doc(data.userId).set({
                  email: data.email,
                  fullName: data.fullName,
                  courses: data.selectedCourses || []
                });

                for (const courseId of data.selectedCourses || []) {
                  const progressId = `${data.userId}_${courseId}`;
                  await db.collection("course_progress").doc(progressId).set({
                    uid: data.userId,
                    courseId,
                    passed: false,
                    progress: 0,
                    score: 0,
                    certificateUrl: ""
                  });
                }

                alert("Заявка одобрена.");
                loadRequests('pending');
              } catch (err) {
                console.error("Ошибка одобрения:", err);
                alert("Ошибка при одобрении: " + err.message);
              }
            };
            actionsTd.appendChild(approveBtn);
          }
          tbody.appendChild(tr);
        }
      } catch (err) {
        console.error("Ошибка загрузки заявок:", err);
        container.innerHTML = "<p>Ошибка загрузки заявок.</p>";
      }
    }

    auth.onAuthStateChanged((user) => {
      if (user) loadRequests('pending');
    });
  </script>
</body>
</html>
