<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Курсы</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header>
    <div class="user-info">
      <span id="userAvatar" class="avatar"></span>
      <button id="logoutBtn">Выйти</button>
    </div>
  </header>

  <main>
    <input type="text" id="searchInput" placeholder="Поиск курсов...">
    <div id="courseList" class="course-list"></div>
  </main>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const courseList = document.getElementById('courseList');
    const searchInput = document.getElementById('searchInput');
    const userAvatar = document.getElementById('userAvatar');
    const logoutBtn = document.getElementById('logoutBtn');

    logoutBtn.addEventListener('click', () => {
      auth.signOut().then(() => {
        window.location.href = 'login.html';
      });
    });

    function getSlideUrl(folderName) {
      const base = `https://raw.githubusercontent.com/qhse-training/hse-course/main/${folderName}`;
      const slideEng = `${base}/Slide1.JPG`;
      const slideRus = `${base}/Слайд1.JPG`;
      const placeholder = 'https://via.placeholder.com/300x160?text=Нет+превью';

      return Promise.allSettled([
        fetch(slideEng, { method: 'HEAD' }),
        fetch(slideRus, { method: 'HEAD' })
      ]).then(([resEng, resRus]) => {
        if (resEng.status === "fulfilled" && resEng.value.ok) return slideEng;
        if (resRus.status === "fulfilled" && resRus.value.ok) return slideRus;
        return placeholder;
      }).catch(() => placeholder);
    }

    async function loadAllCourses() {
      try {
        const snapshot = await db.collection('courses').get();
        const slideUrls = await Promise.all(
          snapshot.docs.map(doc => getSlideUrl(doc.id))
        );
        return snapshot.docs.map((doc, i) => ({
          id: doc.id,
          ...doc.data(),
          slideUrl: slideUrls[i]
        }));
      } catch (error) {
        console.error("Ошибка загрузки курсов:", error);
        return [];
      }
    }

    function renderCourses(courses) {
      if (courses.length === 0) {
        courseList.innerHTML = `<div class="no-courses"><p>Курсы не найдены</p></div>`;
        return;
      }
      courseList.innerHTML = '';
      courses.forEach(course => {
        const card = document.createElement('div');
        card.className = 'course-card';
        card.innerHTML = `
          <div class="course-image" style="background-image: url('${course.slideUrl}')">
            ${course.module ? `<span class="course-module">${course.module}</span>` : ''}
          </div>
          <div class="course-body">
            <h3 class="course-title">${course.title || 'Без названия'}</h3>
            <p class="course-desc">${course.description || 'Описание отсутствует'}</p>
            ${course.price ? `<div class="course-price">${course.price} ₸</div>` : ''}
            <div class="course-actions">
              <a href="course.html?id=${course.id}" class="btn btn-primary">Пройти курс</a>
              ${course.testHtml ? `<a href="${course.testHtml}" target="_blank" class="btn btn-test">Тест</a>` : ''}
            </div>
          </div>
        `;
        courseList.appendChild(card);
      });
    }

    searchInput.addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase();
      const filteredCourses = allCourses.filter(course => 
        course.title.toLowerCase().includes(searchTerm) || 
        (course.description && course.description.toLowerCase().includes(searchTerm))
      );
      renderCourses(filteredCourses);
    });

    let allCourses = [];
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }
      userAvatar.textContent = user.email ? user.email.charAt(0).toUpperCase() : 'U';
      allCourses = await loadAllCourses();
      renderCourses(allCourses);
    });
  </script>
</body>
</html>
