<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ü—Ä–æ—Å–º–æ—Ç—Ä –∫—É—Ä—Å–∞</title>
  <style>
    :root {
      --primary: #3498db;
      --primary-hover: #2980b9;
      --success: #27ae60;
      --error: #e74c3c;
      --text: #2c3e50;
      --text-light: #7f8c8d;
      --bg: #f0f0f0;
      --white: #ffffff;
      --shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg);
      padding: 20px;
      margin: 0;
      color: var(--text);
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: var(--white);
      padding: 30px;
      border-radius: 10px;
      box-shadow: var(--shadow);
      position: relative;
    }
    
    h1 {
      color: var(--text);
      margin-bottom: 10px;
    }
    
    .course-meta {
      color: var(--text-light);
      margin-bottom: 20px;
      font-size: 1.1rem;
    }
    
    .slide-container {
      margin: 20px 0;
      position: relative;
    }
    
    .slide-image {
      width: 100%;
      max-height: 70vh;
      object-fit: contain;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.3s;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .slide-image:hover {
      transform: scale(1.01);
    }
    
    .slide-nav {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    
    .nav-button {
      padding: 12px 24px;
      font-size: 16px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
      min-width: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .nav-button:hover {
      background: var(--primary-hover);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .nav-button:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .progress-container {
      margin: 30px 0;
    }
    
    .progress-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .progress-bar {
      height: 10px;
      background: #ecf0f1;
      border-radius: 5px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: var(--success);
      width: 0%;
      transition: width 0.5s ease;
    }
    
    .test-button {
      text-align: center;
      margin-top: 30px;
    }
    
    .btn-test {
      padding: 14px 28px;
      background: #e67e22;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-block;
    }
    
    .btn-test:hover {
      background: #d35400;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .btn-test.disabled {
      background: #95a5a6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .slide-counter {
      text-align: center;
      color: var(--text-light);
      margin-top: 10px;
    }
    
    .error-message {
      color: var(--error);
      background: #fdecea;
      padding: 15px;
      border-radius: 6px;
      text-align: center;
      margin: 20px 0;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0,0,0,0.1);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .fullscreen-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,0.5);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
      
      .nav-button {
        padding: 10px 15px;
        min-width: 100px;
      }
    }
  </style>
</head>
<body>
  <div class="container" id="courseContainer">
    <h1 id="courseTitle">–ó–∞–≥—Ä—É–∑–∫–∞ –∫—É—Ä—Å–∞...</h1>
    <p class="course-meta" id="courseDescription"></p>
    
    <div class="progress-container">
      <div class="progress-info">
        <span>–ü—Ä–æ–≥—Ä–µ—Å—Å:</span>
        <span id="progressText">0%</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressBar"></div>
      </div>
    </div>
    
    <div class="slide-container">
      <div id="loadingIndicator" style="text-align: center;">
        <div class="loading"></div>
        <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª–∞–π–¥–∞...</p>
      </div>
      <img id="slideImage" class="slide-image" style="display: none;" 
           ondblclick="toggleFullscreen()" alt="–°–ª–∞–π–¥ –∫—É—Ä—Å–∞" />
    </div>
    
    <div class="slide-counter" id="slideCounter">
      –°–ª–∞–π–¥ 0 –∏–∑ 0
    </div>
    
    <div class="slide-nav">
      <button class="nav-button" onclick="prevSlide()" id="prevBtn">
        ‚Üê –ù–∞–∑–∞–¥
      </button>
      <button class="nav-button" onclick="toggleFullscreen()" id="fullscreenBtn">
        üî≥ –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º
      </button>
      <button class="nav-button" onclick="nextSlide()" id="nextBtn">
        –î–∞–ª–µ–µ ‚Üí
      </button>
    </div>
    
    <div class="test-button">
      <a id="testBtn" href="#" class="btn-test disabled">
        –ü–µ—Ä–µ–π—Ç–∏ –∫ —Ç–µ—Å—Ç—É
      </a>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDQXNLAsqmSlAjplpdl2anPSyiDxbz3CjY",
      authDomain: "qhse-training.firebaseapp.com",
      projectId: "qhse-training",
      storageBucket: "qhse-training.appspot.com",
      messagingSenderId: "4501351718",
      appId: "1:4501351718:web:503b00c9ac052b58e2e5e7"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Get course ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const courseId = urlParams.get('id');
    
    if (!courseId) {
      showErrorAndRedirect('–û—à–∏–±–∫–∞: ID –∫—É—Ä—Å–∞ –Ω–µ —É–∫–∞–∑–∞–Ω –≤ URL');
    }

    // Test paths mapping
    const TEST_PATHS = {
      "0EFXo6H4N1mbA1jBJwOK": "1.01.Occupational_Health_and_Safety_Management_System/test1.html",
      "0Jqmw9JvD6lXB1EM1lcD": "1.02.Hierarchy_of_hazard_controls/test2.html"
    };

    // Course variables
    let slideIndex = 0;
    let slidePaths = [];
    let uid = null;
    let progressDocId = null;
    let autoAdvanceTimer = null;
    const AUTO_ADVANCE_DELAY = 10000; // 10 seconds

    // DOM elements
    const courseTitle = document.getElementById('courseTitle');
    const courseDescription = document.getElementById('courseDescription');
    const slideImage = document.getElementById('slideImage');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const slideCounter = document.getElementById('slideCounter');
    const testBtn = document.getElementById('testBtn');
    const loadingIndicator = document.getElementById('loadingIndicator');

    // Initialize the course
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        showErrorAndRedirect('–û—à–∏–±–∫–∞: —Ç—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è');
        return;
      }
      
      uid = user.uid;
      progressDocId = `${uid}_${courseId}`;
      
      try {
        await loadCourseData();
        await loadUserProgress();
        updateSlide();
      } catch (error) {
        showErrorAndRedirect(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—É—Ä—Å–∞: ${error.message}`);
      }
    });

    // Load course data from Firestore
    async function loadCourseData() {
      const courseDoc = await db.collection('courses').doc(courseId).get();
      
      if (!courseDoc.exists) {
        throw new Error('–ö—É—Ä—Å –Ω–µ –Ω–∞–π–¥–µ–Ω');
      }
      
      const courseData = courseDoc.data();
      courseTitle.textContent = courseData.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
      courseDescription.textContent = courseData.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
      slidePaths = courseData.slides || [];
      
      if (slidePaths.length === 0) {
        throw new Error('–í –∫—É—Ä—Å–µ –Ω–µ—Ç —Å–ª–∞–π–¥–æ–≤');
      }
    }

    // Load or create user progress
    async function loadUserProgress() {
      const progressRef = db.collection('course_progress').doc(progressDocId);
      const progressSnap = await progressRef.get();
      
      if (!progressSnap.exists) {
        await progressRef.set({
          uid: uid,
          courseId: courseId,
          progress: 0,
          completed: 0,
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
    }

    // Update slide display
    function updateSlide() {
      clearTimeout(autoAdvanceTimer);
      
      // Show loading indicator
      loadingIndicator.style.display = 'block';
      slideImage.style.display = 'none';
      
      // Update navigation buttons
      prevBtn.disabled = slideIndex === 0;
      nextBtn.disabled = slideIndex === slidePaths.length - 1;
      
      // Update slide counter
      slideCounter.textContent = `–°–ª–∞–π–¥ ${slideIndex + 1} –∏–∑ ${slidePaths.length}`;
      
      // Load slide image
      const img = new Image();
      img.src = resolveSlideUrl(slidePaths[slideIndex]);
      img.onload = () => {
        slideImage.src = img.src;
        slideImage.style.display = 'block';
        loadingIndicator.style.display = 'none';
        updateProgress();
        
        // Auto-advance to next slide after delay (if not last slide)
        if (slideIndex < slidePaths.length - 1) {
          autoAdvanceTimer = setTimeout(() => {
            slideIndex++;
            updateSlide();
          }, AUTO_ADVANCE_DELAY);
        }
      };
      
      img.onerror = () => {
        loadingIndicator.innerHTML = '<p style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–∞–π–¥–∞</p>';
      };
    }

    // Resolve slide URL
    function resolveSlideUrl(path) {
      if (path.startsWith('http')) {
        return path;
      } else {
        // For Firebase Storage paths
        const encodedPath = encodeURIComponent(path);
        return `https://firebasestorage.googleapis.com/v0/b/qhse-training.appspot.com/o/${encodedPath}?alt=media`;
      }
    }

    // Update user progress
    async function updateProgress() {
      const progressRef = db.collection('course_progress').doc(progressDocId);
      const progressSnap = await progressRef.get();
      const currentCompleted = progressSnap.data().completed || 0;
      
      if (slideIndex + 1 > currentCompleted) {
        const newCompleted = slideIndex + 1;
        const newProgress = Math.round((newCompleted / slidePaths.length) * 100);
        
        await progressRef.update({
          completed: newCompleted,
          progress: newProgress,
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        updateProgressUI(newProgress);
        
        // Enable test button if course completed
        if (newProgress === 100) {
          enableTestButton();
        }
      } else {
        const currentProgress = progressSnap.data().progress || 0;
        updateProgressUI(currentProgress);
        
        if (currentProgress === 100) {
          enableTestButton();
        }
      }
    }

    // Update progress UI
    function updateProgressUI(percent) {
      progressBar.style.width = `${percent}%`;
      progressText.textContent = `${percent}%`;
    }

    // Enable test button if test exists for this course
    function enableTestButton() {
      if (TEST_PATHS[courseId]) {
        testBtn.href = `${TEST_PATHS[courseId]}?id=${courseId}`;
        testBtn.classList.remove('disabled');
      } else {
        testBtn.textContent = '–¢–µ—Å—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
      }
    }

    // Navigation functions
    function prevSlide() {
      if (slideIndex > 0) {
        slideIndex--;
        updateSlide();
      }
    }

    function nextSlide() {
      if (slideIndex < slidePaths.length - 1) {
        slideIndex++;
        updateSlide();
      }
    }

    // Fullscreen toggle
    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
          console.error('–û—à–∏–±–∫–∞ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞:', err);
        });
      } else {
        document.exitFullscreen();
      }
    }

    // Update fullscreen button text
    document.addEventListener('fullscreenchange', () => {
      const btn = document.getElementById('fullscreenBtn');
      if (btn) {
        btn.textContent = document.fullscreenElement ? 
          '‚õî –í—ã–π—Ç–∏ –∏–∑ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–∞' : 'üî≥ –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º';
      }
    });

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') prevSlide();
      if (e.key === 'ArrowRight') nextSlide();
      if (e.key === 'f' || e.key === 'F') toggleFullscreen();
    });

    // Show error and redirect
    function showErrorAndRedirect(message) {
      document.body.innerHTML = `
        <div class="error-message">
          <p>${message}</p>
          <p>–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É...</p>
        </div>
      `;
      setTimeout(() => window.location.href = 'dashboard.html', 3000);
    }
  </script>
</body>
</html>