<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Курс</title>
</head>
<body>
  <h1 id="courseTitle">...</h1>
  <p id="courseDescription">...</p>
  <p id="progressText">Прогресс: 0%</p>
  <img id="slideImage" src="" alt="Слайд" style="max-width: 100%; height: auto;"/>
  <p id="slideError" style="color: red;"></p>

  <div>
    <button onclick="prevSlide()">← Назад</button>
    <span id="slideCounter">Слайд ? из ?</span>
    <button onclick="nextSlide()">Далее →</button>
  </div>

  <button onclick="goToTest()">Перейти к тесту</button>

  <!-- Firebase библиотеки -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDQXNLAsqmSlAjplpdl2anPSyiDxbz3CjY",
      authDomain: "qhse-training.firebaseapp.com",
      projectId: "qhse-training",
      storageBucket: "qhse-training.firebasestorage.app",
      messagingSenderId: "4501351718",
      appId: "1:4501351718:web:503b00c9ac052b58e2e5e7"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    let uid = null;
    const courseId = new URLSearchParams(window.location.search).get("id");
    let courseData = null;
    let currentSlide = 0;
    let totalSlides = 0;

    const courseTitleEl = document.getElementById("courseTitle");
    const courseDescEl = document.getElementById("courseDescription");
    const slideImage = document.getElementById("slideImage");
    const slideCounter = document.getElementById("slideCounter");
    const slideError = document.getElementById("slideError");
    const progressText = document.getElementById("progressText");

    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        console.log("Пользователь не авторизован, перенаправляю на login.html");
        window.location.href = "login.html";
        return;
      }

      uid = user.uid;
      console.log("Пользователь авторизован:", user.email);
      await loadCourse();
    });

    async function loadCourse() {
      try {
        const courseSnap = await db.collection("courses").doc(courseId).get();
        if (!courseSnap.exists) {
          alert("Курс не найден");
          return;
        }

        courseData = courseSnap.data();
        if (!courseData.slides || !Array.isArray(courseData.slides)) {
          alert("Слайды не найдены");
          return;
        }

        totalSlides = courseData.slides.length;

        courseTitleEl.textContent = courseData.title || "Без названия";
        courseDescEl.textContent = courseData.description || "";

        const progressRef = db.collection("course_progress").doc(`${uid}_${courseId}`);
        const progressSnap = await progressRef.get();

        if (!progressSnap.exists) {
          await progressRef.set({
            uid,
            courseId,
            progress: 0,
            score: 0,
            passed: false,
            certificateUrl: "",
            completed: 0,
            totalSlides
          });
        }

        renderSlide();
      } catch (err) {
        console.error("Ошибка загрузки курса:", err);
        alert("Ошибка загрузки курса. Проверьте разрешения Firebase.");
      }
    }

    async function renderSlide() {
      if (!courseData || currentSlide < 0 || currentSlide >= totalSlides) return;

      const path = courseData.slides[currentSlide];
      try {
        const url = await storage.ref(path).getDownloadURL();
        slideImage.src = url;
        slideError.textContent = "";
      } catch (err) {
        console.error("Ошибка загрузки слайда:", err);
        slideImage.src = "";
        slideError.textContent = `Не удалось загрузить слайд: ${path}`;
      }

      slideCounter.textContent = `Слайд ${currentSlide + 1} из ${totalSlides}`;
      const progressPercent = Math.round(((currentSlide + 1) / totalSlides) * 100);
      progressText.textContent = `Прогресс: ${progressPercent}% (${currentSlide + 1}/${totalSlides} слайдов)`;

      try {
        await db.collection("course_progress").doc(`${uid}_${courseId}`).update({
          progress: progressPercent,
          completed: currentSlide + 1,
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
      } catch (err) {
        console.warn("Не удалось обновить прогресс:", err.message);
      }
    }

    window.prevSlide = () => {
      if (currentSlide > 0) {
        currentSlide--;
        renderSlide();
      }
    };

    window.nextSlide = () => {
      if (currentSlide < totalSlides - 1) {
        currentSlide++;
        renderSlide();
      }
    };

    window.goToTest = () => {
      window.location.href = `test.html?id=${courseId}`;
    };
  </script>
</body>
</html>
