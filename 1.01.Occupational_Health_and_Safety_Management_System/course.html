<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Курс: Система управления охраной труда</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    /* Сохраните ваш текущий CSS стиль */
    /* ... существующий CSS ... */
  </style>
</head>
<body>
  <header>
    <div class="logo-container">
      <i class="fas fa-hard-hat fa-2x"></i>
      <div class="logo-text">Обучение по охране труда</div>
    </div>
    <div class="user-info">
      <span id="username">Пользователь</span>
      <div class="user-avatar" id="userAvatar">П</div>
    </div>
  </header>
  <nav>
    <ul>
      <li><a href="../index.html">Главная</a></li>
      <li><a href="../courses.html">Курсы</a></li>
      <li><a href="#" id="testLink">Тест</a></li>
      <li><a href="../certificates.html">Сертификаты</a></li>
      <li><a href="../profile.html">Профиль</a></li>
    </ul>
  </nav>
  <div class="course-container">
    <div class="course-header">
      <h1 class="course-title" id="courseTitle">Загрузка курса...</h1>
      <div class="progress-container">
        <div class="progress-bar" id="progressBar">0%</div>
      </div>
    </div>
    <div class="slide-container">
      <h2 class="slide-title" id="slideTitle">Слайд 1</h2>
      <div class="slide-content">
        <img id="slideImage" src="" alt="Слайд курса" class="slide-image">
        <div class="slide-description" id="slideDescription"></div>
      </div>
      <div class="slide-navigation">
        <button class="nav-btn" id="prevBtn">
          <i class="fas fa-arrow-left"></i> Назад
        </button>
        <button class="nav-btn" id="nextBtn">
          Вперед <i class="fas fa-arrow-right"></i>
        </button>
        <button class="fullscreen-btn" id="fullscreenBtn">
          <i class="fas fa-expand"></i> Полный экран
        </button>
      </div>
      <div class="slide-info">
        Слайд <span id="currentSlide">1</span> из <span id="totalSlides">...</span>
      </div>
    </div>
    <div class="actions">
      <a href="../courses.html" class="action-btn">
        <i class="fas fa-book"></i> К списку курсов
      </a>
      <a href="#" id="testBtn" class="action-btn">
        <i class="fas fa-clipboard-check"></i> Пройти тест
      </a>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    // Firebase конфигурация
    const firebaseConfig = {
      apiKey: "AIzaSyDQXNLAsqmSlAjplpdl2anPSyiDxbz3CjY",
      authDomain: "qhse-training.firebaseapp.com",
      projectId: "qhse-training",
      storageBucket: "qhse-training.appspot.com",
      messagingSenderId: "4501351718",
      appId: "1:4501351718:web:503b00c9ac052b58e2e5e7"
    };
    
    // Инициализация Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM элементы
    const courseTitleEl = document.getElementById("courseTitle");
    const slideTitleEl = document.getElementById("slideTitle");
    const slideImageEl = document.getElementById("slideImage");
    const slideDescriptionEl = document.getElementById("slideDescription");
    const currentSlideEl = document.getElementById("currentSlide");
    const totalSlidesEl = document.getElementById("totalSlides");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const progressBar = document.getElementById("progressBar");
    const testBtn = document.getElementById("testBtn");
    const testLink = document.getElementById("testLink");
    const usernameEl = document.getElementById("username");
    const userAvatarEl = document.getElementById("userAvatar");

    // Переменные
    let currentSlideIndex = 0;
    let courseData = null;
    let user = null;
    let userId = null;

    // Получение ID курса из URL параметров
    function getCourseIdFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('id');
    }

    // Загрузка данных курса
    async function loadCourseData(courseId) {
      try {
        const courseDoc = await db.collection('courses').doc(courseId).get();
        if (courseDoc.exists) {
          courseData = courseDoc.data();
          courseTitleEl.textContent = courseData.title || 'Курс';
          totalSlidesEl.textContent = courseData.slides ? courseData.slides.length : 0;
          
          // Настройка ссылки на тест
          if (courseData.testHtml) {
            testBtn.href = courseData.testHtml;
            testLink.href = courseData.testHtml;
          }
          
          // Загрузка прогресса пользователя
          await loadUserProgress(courseId);
          
          // Показать первый слайд
          updateSlide();
        } else {
          courseTitleEl.textContent = 'Курс не найден';
        }
      } catch (error) {
        console.error('Ошибка загрузки курса:', error);
        courseTitleEl.textContent = 'Ошибка загрузки курса';
      }
    }

    // Загрузка прогресса пользователя
    async function loadUserProgress(courseId) {
      try {
        const progressDoc = await db.collection('user_progress').doc(userId).get();
        if (progressDoc.exists) {
          const progressData = progressDoc.data();
          const courseProgress = progressData[courseId] || {};
          
          // Установить текущий слайд из прогресса
          if (courseProgress.lastSlideIndex !== undefined) {
            currentSlideIndex = courseProgress.lastSlideIndex;
          }
          
          updateProgressBar();
        }
      } catch (error) {
        console.error('Ошибка загрузки прогресса:', error);
      }
    }

    // Сохранение прогресса
    async function saveProgress() {
      try {
        const progressRef = db.collection('user_progress').doc(userId);
        const progressDoc = await progressRef.get();
        
        let progressData = {};
        if (progressDoc.exists) {
          progressData = progressDoc.data();
        }
        
        progressData[getCourseIdFromUrl()] = {
          lastSlideIndex: currentSlideIndex,
          slidesViewed: currentSlideIndex + 1,
          totalSlides: courseData.slides ? courseData.slides.length : 0,
          lastAccessed: firebase.firestore.FieldValue.serverTimestamp(),
          progressPercentage: calculateProgressPercentage()
        };
        
        await progressRef.set(progressData, { merge: true });
      } catch (error) {
        console.error('Ошибка сохранения прогресса:', error);
      }
    }

    // Обновление слайда
    function updateSlide() {
      if (!courseData || !courseData.slides) return;
      
      const slideUrl = courseData.slides[currentSlideIndex];
      slideImageEl.src = slideUrl;
      slideTitleEl.textContent = `Слайд ${currentSlideIndex + 1}`;
      slideDescriptionEl.textContent = courseData.description || `Слайд ${currentSlideIndex + 1} курса`;
      currentSlideEl.textContent = currentSlideIndex + 1;
      
      // Обновление состояния кнопок
      prevBtn.disabled = currentSlideIndex === 0;
      nextBtn.disabled = currentSlideIndex === courseData.slides.length - 1;
      
      // Сохранение прогресса
      saveProgress();
      updateProgressBar();
    }

    // Расчет процента прогресса
    function calculateProgressPercentage() {
      if (!courseData || !courseData.slides) return 0;
      return Math.round(((currentSlideIndex + 1) / courseData.slides.length) * 100);
    }

    // Обновление прогресс-бара
    function updateProgressBar() {
      const percentage = calculateProgressPercentage();
      progressBar.style.width = `${percentage}%`;
      progressBar.textContent = `${percentage}%`;
    }

    // Обработчики событий
    prevBtn.addEventListener('click', () => {
      if (currentSlideIndex > 0) {
        currentSlideIndex--;
        updateSlide();
      }
    });

    nextBtn.addEventListener('click', () => {
      if (courseData && courseData.slides && currentSlideIndex < courseData.slides.length - 1) {
        currentSlideIndex++;
        updateSlide();
      }
    });

    // Полноэкранный режим
    document.getElementById('fullscreenBtn').addEventListener('click', () => {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
          console.error(`Ошибка: ${err.message}`);
        });
      } else {
        if (document.exitFullscreen) document.exitFullscreen();
      }
    });

    // Инициализация
    auth.onAuthStateChanged(async (firebaseUser) => {
      if (!firebaseUser) {
        window.location.href = '../login.html';
        return;
      }
      
      user = firebaseUser;
      userId = user.uid;
      usernameEl.textContent = user.displayName || user.email;
      userAvatarEl.textContent = user.email.charAt(0).toUpperCase();
      
      // Загрузка данных курса
      const courseId = getCourseIdFromUrl();
      if (courseId) {
        await loadCourseData(courseId);
      } else {
        courseTitleEl.textContent = 'ID курса не указан';
      }
    });

    // Обработка клавиш
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') prevBtn.click();
      if (e.key === 'ArrowRight') nextBtn.click();
      if (e.key === 'F11' || (e.key === 'f' && e.ctrlKey)) {
        e.preventDefault();
        document.getElementById('fullscreenBtn').click();
      }
    });
  </script>
</body>
</html>