<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Курс обучения</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --accent-color: #e74c3c;
      --light-color: #ecf0f1;
      --dark-color: #2c3e50;
      --success-color: #27ae60;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }
    header {
      background-color: var(--primary-color);
      color: white;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .logo-container { display: flex; align-items: center; gap: 1rem; }
    .logo-text { font-size: 1.5rem; font-weight: bold; }
    .user-info { display: flex; align-items: center; gap: 1rem; }
    .user-avatar {
      width: 40px; height: 40px; border-radius: 50%;
      background-color: var(--secondary-color);
      display: flex; align-items: center; justify-content: center;
      color: white; font-weight: bold;
    }
    nav {
      background-color: var(--dark-color);
      padding: 0.5rem 2rem;
    }
    nav ul {
      display: flex; list-style: none; gap: 1.5rem;
    }
    nav a {
      color: white; text-decoration: none; padding: 0.5rem 0;
      transition: color 0.3s;
    }
    nav a:hover, nav a.active { color: var(--secondary-color); }
    .course-container {
      max-width: 1200px; margin: 2rem auto; padding: 0 1rem;
    }
    .course-header {
      background-color: white; border-radius: 8px;
      padding: 2rem; margin-bottom: 2rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .course-title {
      color: var(--primary-color);
      margin-bottom: 0.5rem;
      text-align: center;
    }
    .course-description {
      color: #666;
      text-align: center;
      margin-bottom: 1.5rem;
      font-size: 1.1rem;
    }
    .progress-container {
      width: 100%; background-color: #eee;
      border-radius: 10px; margin: 1.5rem 0; height: 20px;
    }
    .progress-bar {
      height: 100%; border-radius: 10px;
      background-color: var(--success-color);
      width: 0%; transition: width 0.5s ease;
      display: flex; align-items: center;
      justify-content: center; color: white; font-size: 0.7rem;
    }
    .slide-container {
      background-color: white; border-radius: 8px;
      padding: 2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      text-align: center;
    }
    .slide-title {
      color: var(--primary-color); margin-bottom: 1.5rem;
    }
    .slide-content { margin-bottom: 1.5rem; }
    .slide-image {
      max-width: 100%; max-height: 600px;
      height: auto; border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      margin-bottom: 1rem;
    }
    .slide-description {
      color: #555; margin-top: 1rem; line-height: 1.6;
      text-align: left;
      padding: 1rem;
      background: #f9f9f9;
      border-radius: 8px;
    }
    .slide-navigation {
      display: flex; justify-content: center;
      gap: 1rem; margin-top: 2rem;
    }
    .nav-btn, .fullscreen-btn {
      padding: 0.8rem 1.5rem; border: none; border-radius: 6px;
      cursor: pointer; transition: all 0.3s;
      display: flex; align-items: center; gap: 0.5rem;
      font-weight: 600;
    }
    .nav-btn {
      background-color: var(--secondary-color); color: white;
    }
    .nav-btn:hover {
      background-color: #2980b9; transform: translateY(-2px);
    }
    .nav-btn:disabled {
      background-color: #ccc; cursor: not-allowed; transform: none;
    }
    .fullscreen-btn {
      background-color: var(--primary-color); color: white;
    }
    .fullscreen-btn:hover {
      background-color: #1a252f; transform: translateY(-2px);
    }
    .slide-info {
      margin-top: 1rem;
      font-weight: bold;
      color: var(--primary-color);
      font-size: 1.1rem;
    }
    .actions {
      margin-top: 2rem; display: flex;
      justify-content: center; gap: 1rem;
    }
    .action-btn {
      padding: 0.8rem 1.5rem;
      background-color: var(--success-color); color: white;
      border: none; border-radius: 6px;
      text-decoration: none; font-weight: bold;
      cursor: pointer; transition: all 0.3s;
      display: flex; align-items: center; gap: 0.5rem;
    }
    .action-btn:hover {
      background-color: #219653;
      transform: translateY(-2px);
    }
    .btn-back {
      background-color: #7f8c8d;
    }
    .btn-back:hover {
      background-color: #6c7b7d;
    }
    .btn-test {
      background-color: #e67e22;
    }
    .btn-test:hover {
      background-color: #d35400;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #7f8c8d;
    }
    .error {
      text-align: center;
      padding: 40px;
      color: #e74c3c;
    }
    .course-meta {
      display: flex;
      justify-content: center;
      gap: 2rem;
      margin: 1rem 0;
      color: #666;
    }
    .meta-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    @media (max-width: 768px) {
      header { flex-direction: column; text-align: center; gap: 1rem; }
      nav ul { flex-direction: column; gap: 0.5rem; }
      .slide-navigation, .actions { flex-direction: column; }
      .nav-btn, .fullscreen-btn, .action-btn {
        width: 100%; justify-content: center;
      }
      .slide-image { max-height: 400px; }
      .course-meta { flex-direction: column; gap: 0.5rem; }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo-container">
      <i class="fas fa-hard-hat fa-2x"></i>
      <div class="logo-text">OHSMS Academy</div>
    </div>
    <div class="user-info">
      <span id="username">Загрузка...</span>
      <div class="user-avatar" id="userAvatar">?</div>
    </div>
  </header>
  <nav>
    <ul>
      <li><a href="https://qhse-training.github.io/hse-course/courses.html" class="active">Мои курсы</a></li>
      <li><a href="#" onclick="logout()">Выйти</a></li>
    </ul>
  </nav>
  
  <div class="course-container">
    <div class="course-header">
      <h1 class="course-title" id="courseTitle">Загрузка курса...</h1>
      <div class="course-description" id="courseDescription"></div>
      <div class="course-meta" id="courseMeta"></div>
      <div class="progress-container">
        <div class="progress-bar" id="progressBar">0%</div>
      </div>
    </div>
    
    <div class="slide-container">
      <h2 class="slide-title" id="slideTitle">Загрузка слайда...</h2>
      <div class="slide-content">
        <div id="slideContent" class="loading">
          <p>Загрузка материалов курса...</p>
        </div>
      </div>
      <div class="slide-navigation">
        <button class="nav-btn" id="prevBtn" onclick="prevSlide()" disabled>
          <i class="fas fa-arrow-left"></i> Назад
        </button>
        <button class="nav-btn" id="nextBtn" onclick="nextSlide()" disabled>
          Вперед <i class="fas fa-arrow-right"></i>
        </button>
        <button class="fullscreen-btn" onclick="toggleFullscreen()" id="fullscreenBtn">
          <i class="fas fa-expand"></i> Полный экран
        </button>
      </div>
      <div class="slide-info">
        Слайд <span id="currentSlide">0</span> из <span id="totalSlides">0</span>
      </div>
    </div>
    
    <div class="actions">
      <a href="https://qhse-training.github.io/hse-course/courses.html" class="action-btn btn-back">
        <i class="fas fa-arrow-left"></i> К списку курсов
      </a>
      <button class="action-btn btn-test" id="testBtn" onclick="openTest()" disabled>
        <i class="fas fa-clipboard-check"></i> Пройти тест
      </button>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDQXNLAsqmSlAjplpdl2anPSyiDxbz3CjY",
      authDomain: "qhse-training.firebaseapp.com",
      projectId: "qhse-training",
      storageBucket: "qhse-training.appspot.com",
      messagingSenderId: "4501351718",
      appId: "1:4501351718:web:503b00c9ac052b58e2e5e7"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM elements
    const courseTitleEl = document.getElementById('courseTitle');
    const courseDescriptionEl = document.getElementById('courseDescription');
    const courseMetaEl = document.getElementById('courseMeta');
    const slideTitleEl = document.getElementById('slideTitle');
    const slideContentEl = document.getElementById('slideContent');
    const currentSlideEl = document.getElementById('currentSlide');
    const totalSlidesEl = document.getElementById('totalSlides');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const progressBar = document.getElementById('progressBar');
    const testBtn = document.getElementById('testBtn');
    const usernameEl = document.getElementById('username');
    const userAvatarEl = document.getElementById('userAvatar');

    // Global variables
    let courseId = null;
    let slides = [];
    let currentSlideIndex = 0;
    let userData = null;
    let courseData = null;
    let userProgress = {};

    // Get course ID from URL
    function getCourseIdFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      const id = urlParams.get('id');
      
      if (!id) {
        // Если ID не передан, попробуем получить из hash
        const hash = window.location.hash.substring(1);
        if (hash) return hash;
        
        // Или из последнего сегмента URL
        const pathParts = window.location.pathname.split('/');
        return pathParts[pathParts.length - 1].replace('.html', '');
      }
      
      return id;
    }

    // Debug function to show URL parameters
    function debugUrl() {
      console.log('URL:', window.location.href);
      console.log('Search:', window.location.search);
      console.log('Hash:', window.location.hash);
      console.log('Pathname:', window.location.pathname);
      const urlParams = new URLSearchParams(window.location.search);
      console.log('URL Params:', Object.fromEntries(urlParams));
    }

    // Load course data
    async function loadCourseData() {
      try {
        debugUrl(); // Для отладки
        courseId = getCourseIdFromUrl();
        console.log('Course ID from URL:', courseId);
        
        if (!courseId) {
          showError('ID курса не указан в URL. Проверьте ссылку.');
          return;
        }

        // Пытаемся найти курс по ID в Firestore
        let courseDoc;
        
        // Сначала ищем по точному совпадению ID
        courseDoc = await db.collection('courses').doc(courseId).get();
        
        // Если не нашли, ищем все курсы и проверяем поле testHtml
        if (!courseDoc.exists) {
          console.log('Course not found by ID, searching by testHtml...');
          const allCourses = await db.collection('courses').get();
          
          for (let doc of allCourses.docs) {
            const data = doc.data();
            if (data.testHtml && data.testHtml.includes(courseId)) {
              courseId = doc.id;
              courseDoc = doc;
              console.log('Found course by testHtml:', courseId);
              break;
            }
          }
          
          // Если все еще не нашли, используем первый курс как запасной вариант
          if (!courseDoc || !courseDoc.exists) {
            console.log('Course not found, using first available course');
            const firstCourse = allCourses.docs[0];
            if (firstCourse) {
              courseId = firstCourse.id;
              courseDoc = firstCourse;
            }
          }
        }

        if (!courseDoc || !courseDoc.exists) {
          showError('Курс не найден в базе данных');
          return;
        }

        courseData = courseDoc.data();
        console.log('Course data loaded:', courseData);
        
        // Update course info
        courseTitleEl.textContent = courseData.title || 'Без названия';
        courseDescriptionEl.textContent = courseData.description || '';
        
        // Update course metadata
        let metaHTML = '';
        if (courseData.module) {
          metaHTML += `<div class="meta-item"><i class="fas fa-layer-group"></i> ${courseData.module}</div>`;
        }
        if (courseData.duration) {
          metaHTML += `<div class="meta-item"><i class="fas fa-clock"></i> ${courseData.duration}</div>`;
        }
        if (courseData.slides && courseData.slides.length) {
          metaHTML += `<div class="meta-item"><i class="fas fa-images"></i> ${courseData.slides.length} слайдов</div>`;
        }
        courseMetaEl.innerHTML = metaHTML;

        // Load slides
        await loadSlides();

        // Load user progress
        await loadUserProgress();

        // Enable test button if course has test
        if (courseData.testHtml || courseData.hasTest) {
          testBtn.disabled = false;
          testBtn.title = 'Перейти к тестированию';
        } else {
          testBtn.disabled = true;
          testBtn.title = 'Тест недоступен для этого курса';
        }

      } catch (error) {
        console.error('Ошибка загрузки курса:', error);
        showError(`Ошибка загрузки курса: ${error.message}`);
      }
    }

    // Load slides
    async function loadSlides() {
      try {
        slides = [];
        
        // Если в courseData есть массив slides с URL
        if (courseData.slides && Array.isArray(courseData.slides) && courseData.slides.length > 0) {
          console.log('Loading slides from course data:', courseData.slides.length);
          
          courseData.slides.forEach((slideUrl, index) => {
            slides.push({
              number: index + 1,
              title: `Слайд ${index + 1}`,
              imageUrl: slideUrl,
              description: `Содержание слайда ${index + 1} по теме "${courseData.title}"`
            });
          });
          
        } else {
          // Старый метод - пытаемся найти слайды на GitHub
          console.log('Trying to find slides on GitHub...');
          const folderName = courseId;
          let slideNumber = 1;
          
          while (slideNumber <= 50) {
            const slideUrls = [
              `https://raw.githubusercontent.com/qhse-training/hse-course/main/${folderName}/Slide${slideNumber}.JPG`,
              `https://raw.githubusercontent.com/qhse-training/hse-course/main/${folderName}/Slide${slideNumber}.jpg`,
              `https://raw.githubusercontent.com/qhse-training/hse-course/main/${folderName}/%D0%A1%D0%BB%D0%B0%D0%B9%D0%B4${slideNumber}.JPG`,
              `https://raw.githubusercontent.com/qhse-training/hse-course/main/${folderName}/slide${slideNumber}.jpg`
            ];
            
            let found = false;
            for (const slideUrl of slideUrls) {
              try {
                const response = await fetch(slideUrl, { method: 'HEAD' });
                if (response.ok) {
                  slides.push({
                    number: slideNumber,
                    title: `Слайд ${slideNumber}`,
                    imageUrl: slideUrl,
                    description: `Содержание слайда ${slideNumber} по теме "${courseData.title}"`
                  });
                  found = true;
                  console.log(`Found slide: ${slideUrl}`);
                  break;
                }
              } catch (e) {
                // Пропускаем ошибки
              }
            }
            
            if (!found) {
              // Если не нашли слайд с этим номером, возможно, это последний слайд
              break;
            }
            
            slideNumber++;
          }
        }

        if (slides.length === 0) {
          showError('Слайды курса не найдены. Пожалуйста, обратитесь к администратору.');
          return;
        }

        console.log(`Loaded ${slides.length} slides`);
        totalSlidesEl.textContent = slides.length;
        updateSlide();

      } catch (error) {
        console.error('Ошибка загрузки слайдов:', error);
        showError('Ошибка загрузки слайдов: ' + error.message);
      }
    }

    // Load user progress
    async function loadUserProgress() {
      try {
        const user = auth.currentUser;
        if (!user) return;

        const progressDoc = await db.collection('user_progress').doc(user.uid).get();
        if (progressDoc.exists) {
          const allProgress = progressDoc.data();
          userProgress = allProgress[courseId] || {};
          console.log('Loaded user progress:', userProgress);
        }

        updateProgressBar();
        
      } catch (error) {
        console.warn('Ошибка загрузки прогресса:', error);
      }
    }

    // Save user progress
    async function saveUserProgress() {
      try {
        const user = auth.currentUser;
        if (!user) return;

        const viewedSlides = userProgress.viewedSlides || [];
        if (!viewedSlides.includes(currentSlideIndex)) {
          viewedSlides.push(currentSlideIndex);
        }

        const slidesViewed = Math.min(viewedSlides.length, slides.length);
        const progressPercentage = Math.round((slidesViewed / slides.length) * 100);

        // Update progress in Firestore
        await db.collection('user_progress').doc(user.uid).set({
          [courseId]: {
            slidesViewed: progressPercentage,
            lastViewed: new Date().toISOString(),
            viewedSlides: viewedSlides,
            currentSlide: currentSlideIndex,
            lastActivity: firebase.firestore.FieldValue.serverTimestamp()
          }
        }, { merge: true });

        // Update local progress
        userProgress = {
          ...userProgress,
          slidesViewed: progressPercentage,
          viewedSlides: viewedSlides
        };

        updateProgressBar();

      } catch (error) {
        console.error('Ошибка сохранения прогресса:', error);
      }
    }

    // Update slide display
    function updateSlide() {
      if (slides.length === 0) return;

      const slide = slides[currentSlideIndex];
      slideTitleEl.textContent = slide.title;
      currentSlideEl.textContent = currentSlideIndex + 1;

      slideContentEl.innerHTML = `
        <div style="text-align: center;">
          <img src="${slide.imageUrl}" 
               alt="${slide.title}" 
               class="slide-image" 
               onerror="this.onerror=null; this.src='https://via.placeholder.com/800x600/2c3e50/ffffff?text=Слайд+${currentSlideIndex + 1}';"
               loading="lazy">
          <div class="slide-description">
            <p><strong>${courseData.title}</strong></p>
            <p>${slide.description}</p>
            <p style="color: #666; font-size: 0.9rem; margin-top: 10px;">
              <i class="fas fa-info-circle"></i> Для навигации используйте стрелки на клавиатуре или кнопки ниже
            </p>
          </div>
        </div>
      `;

      // Update navigation buttons
      prevBtn.disabled = currentSlideIndex === 0;
      nextBtn.disabled = currentSlideIndex === slides.length - 1;

      // Save progress
      saveUserProgress();
    }

    // Update progress bar
    function updateProgressBar() {
      if (slides.length === 0) return;

      const progress = userProgress.slidesViewed || 0;
      progressBar.style.width = `${progress}%`;
      progressBar.textContent = `${progress}%`;
      
      // Update progress bar color based on progress
      if (progress >= 100) {
        progressBar.style.backgroundColor = '#2ecc71';
      } else if (progress >= 50) {
        progressBar.style.backgroundColor = '#f39c12';
      } else {
        progressBar.style.backgroundColor = '#3498db';
      }
    }

    // Navigation functions
    function prevSlide() {
      if (currentSlideIndex > 0) {
        currentSlideIndex--;
        updateSlide();
      }
    }

    function nextSlide() {
      if (currentSlideIndex < slides.length - 1) {
        currentSlideIndex++;
        updateSlide();
      }
    }

    // Fullscreen functionality
    function toggleFullscreen() {
      const elem = document.documentElement;
      
      if (!document.fullscreenElement) {
        elem.requestFullscreen().catch(err => {
          console.error(`Ошибка включения полноэкранного режима: ${err.message}`);
          alert('Ваш браузер не поддерживает полноэкранный режим');
        });
      } else {
        document.exitFullscreen();
      }
    }

    // Open test
    function openTest() {
      if (!courseData) return;
      
      let testUrl;
      
      if (courseData.testHtml) {
        // Если testHtml уже полный URL
        if (courseData.testHtml.startsWith('http')) {
          testUrl = courseData.testHtml;
        } else {
          // Иначе формируем путь
          testUrl = `https://qhse-training.github.io/hse-course/${courseData.testHtml}`;
        }
      } else if (courseData.hasTest) {
        // Генерируем URL теста на основе ID курса
        testUrl = `https://qhse-training.github.io/hse-course/test.html?course=${courseId}`;
      } else {
        alert('Тест для этого курса не доступен');
        return;
      }
      
      console.log('Opening test URL:', testUrl);
      window.open(testUrl, '_blank');
    }

    // Logout
    function logout() {
      auth.signOut().then(() => {
        window.location.href = 'https://qhse-training.github.io/hse-course/login.html';
      });
    }

    // Show error
    function showError(message) {
      slideContentEl.innerHTML = `
        <div class="error">
          <h3>Ошибка</h3>
          <p>${message}</p>
          <div style="margin-top: 20px;">
            <p><strong>Текущий URL:</strong> ${window.location.href}</p>
            <p><strong>Параметры:</strong> ${window.location.search}</p>
            <p><strong>ID курса:</strong> ${courseId || 'не определен'}</p>
          </div>
          <button onclick="window.location.href='https://qhse-training.github.io/hse-course/courses.html'" 
                  class="action-btn btn-back" style="margin-top: 20px;">
            <i class="fas fa-arrow-left"></i> Вернуться к курсам
          </button>
        </div>
      `;
    }

    // Initialize
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'https://qhse-training.github.io/hse-course/login.html';
        return;
      }

      // Update user info
      usernameEl.textContent = user.email;
      userAvatarEl.textContent = user.email.charAt(0).toUpperCase();

      // Load course data
      await loadCourseData();
    });

    // Handle keyboard navigation
    document.addEventListener('keydown', (e) => {
      // Prevent navigation when user is typing in input fields
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
        return;
      }
      
      switch(e.key) {
        case 'ArrowLeft':
          prevSlide();
          break;
        case 'ArrowRight':
          nextSlide();
          break;
        case ' ':
        case 'Spacebar':
          e.preventDefault(); // Prevent space from scrolling page
          nextSlide();
          break;
        case 'Escape':
          if (document.fullscreenElement) {
            document.exitFullscreen();
          }
          break;
      }
    });

    // Handle fullscreen change
    document.addEventListener('fullscreenchange', () => {
      const fullscreenBtn = document.getElementById('fullscreenBtn');
      if (document.fullscreenElement) {
        fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i> Обычный режим';
        fullscreenBtn.title = 'Выйти из полноэкранного режима (Esc)';
      } else {
        fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i> Полный экран';
        fullscreenBtn.title = 'Перейти в полноэкранный режим';
      }
    });
    
    // Add touch swipe support for mobile devices
    let touchStartX = 0;
    let touchEndX = 0;
    
    document.addEventListener('touchstart', (e) => {
      touchStartX = e.changedTouches[0].screenX;
    });
    
    document.addEventListener('touchend', (e) => {
      touchEndX = e.changedTouches[0].screenX;
      handleSwipe();
    });
    
    function handleSwipe() {
      const swipeThreshold = 50;
      const diff = touchStartX - touchEndX;
      
      if (Math.abs(diff) > swipeThreshold) {
        if (diff > 0) {
          // Swipe left - go to next slide
          nextSlide();
        } else {
          // Swipe right - go to previous slide
          prevSlide();
        }
      }
    }
  </script>
</body>
</html>