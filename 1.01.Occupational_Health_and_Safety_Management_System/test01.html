<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç: –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ö—Ä–∞–Ω–æ–π —Ç—Ä—É–¥–∞</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #2ecc71;
            --error: #e74c3c;
            --warning: #f39c12;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .test-container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .test-header {
            background: var(--primary);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .test-header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .course-info {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 15px;
        }
        
        .test-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding: 0 10px;
            font-size: 14px;
        }
        
        .timer {
            background: var(--warning);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .progress-container {
            width: 100%;
            background: #eee;
            height: 10px;
            border-radius: 5px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: var(--success);
            width: 0%;
            transition: width 0.3s;
        }
        
        .question-container {
            padding: 30px;
        }
        
        .question {
            margin-bottom: 25px;
            padding: 25px;
            border: 2px solid #eee;
            border-radius: 10px;
            transition: all 0.3s;
        }
        
        .question.active {
            border-color: var(--secondary);
            background: #f8f9fa;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.1);
        }
        
        .question-number {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .question-text {
            font-size: 20px;
            margin-bottom: 25px;
            line-height: 1.5;
            color: #2c3e50;
        }
        
        .options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .option {
            padding: 18px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .option:hover {
            border-color: var(--secondary);
            background: #f0f8ff;
            transform: translateX(5px);
        }
        
        .option.selected {
            border-color: var(--secondary);
            background: #e3f2fd;
        }
        
        .option.correct {
            border-color: var(--success);
            background: #e8f5e9;
        }
        
        .option.incorrect {
            border-color: var(--error);
            background: #ffebee;
        }
        
        .option input {
            display: none;
        }
        
        .option-label {
            width: 32px;
            height: 32px;
            border: 2px solid #ccc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #666;
            font-size: 16px;
            flex-shrink: 0;
        }
        
        .option.selected .option-label {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }
        
        .option-text {
            flex: 1;
            font-size: 18px;
            line-height: 1.4;
        }
        
        .navigation {
            display: flex;
            justify-content: space-between;
            padding: 20px 30px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
        }
        
        .nav-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            background: var(--secondary);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .nav-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .nav-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .submit-btn {
            background: var(--success);
        }
        
        .submit-btn:hover {
            background: #27ae60;
        }
        
        .results-container {
            padding: 40px;
            text-align: center;
        }
        
        .score-circle {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            margin: 0 auto 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 12px solid;
            position: relative;
        }
        
        .score-percent {
            font-size: 48px;
            font-weight: bold;
        }
        
        .score-label {
            font-size: 18px;
            margin-top: 5px;
            color: #666;
        }
        
        .score-passed {
            border-color: var(--success);
            background: #e8f5e9;
        }
        
        .score-passed .score-percent {
            color: var(--success);
        }
        
        .score-failed {
            border-color: var(--error);
            background: #ffebee;
        }
        
        .score-failed .score-percent {
            color: var(--error);
        }
        
        .results-details {
            margin: 30px 0;
            text-align: left;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
            font-size: 16px;
        }
        
        .certificate-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 18px 50px;
            border-radius: 10px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            margin: 30px 0;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .certificate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--secondary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .question-counter {
            font-size: 16px;
            font-weight: bold;
            color: var(--primary);
            background: #f0f8ff;
            padding: 8px 16px;
            border-radius: 20px;
        }
        
        .test-requirements {
            background: #fff8e1;
            border: 2px solid #ffd54f;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            font-size: 16px;
        }
        
        .requirement-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .requirement-item i {
            color: #ff9800;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1 id="testTitle">–¢–µ—Å—Ç: –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ö—Ä–∞–Ω–æ–π —Ç—Ä—É–¥–∞ (–°–£–û–¢)</h1>
            <div class="course-info" id="courseInfo"></div>
            
            <div class="test-requirements" id="requirementsInfo" style="display: none;">
                <h3 style="margin-bottom: 10px; color: #ff6f00;">‚ö†Ô∏è –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –¥–ª—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ç–µ—Å—Ç–∞:</h3>
                <div class="requirement-item">
                    <i class="fas fa-check-circle"></i>
                    <span>–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ —Å–ª–∞–π–¥—ã –∫—É—Ä—Å–∞ (100%)</span>
                </div>
                <div class="requirement-item">
                    <i class="fas fa-check-circle"></i>
                    <span>–¢—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞–±—Ä–∞—Ç—å 100% –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤</span>
                </div>
                <div class="requirement-item">
                    <i class="fas fa-check-circle"></i>
                    <span>–ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π —Å–¥–∞—á–µ –±—É–¥–µ—Ç –≤—ã–¥–∞–Ω —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç</span>
                </div>
            </div>
            
            <div class="test-info">
                <div>–í–æ–ø—Ä–æ—Å–æ–≤: <span id="totalQuestions">0</span></div>
                <div class="timer" id="timer">‚è∞ 60:00</div>
            </div>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>
        
        <div id="testContent">
            <div class="loading">
                <div class="loader"></div>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ—Å—Ç–∞...</p>
            </div>
        </div>
        
        <div class="navigation" id="navigation" style="display: none;">
            <button class="nav-btn" id="prevBtn" onclick="prevQuestion()">
                <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥
            </button>
            <div class="question-counter">
                –í–æ–ø—Ä–æ—Å <span id="currentQuestionNum">1</span> –∏–∑ <span id="totalQuestionsNum">0</span>
            </div>
            <button class="nav-btn" id="nextBtn" onclick="nextQuestion()">
                –î–∞–ª–µ–µ <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <!-- Font Awesome -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDQXNLAsqmSlAjplpdl2anPSyiDxbz3CjY",
            authDomain: "qhse-training.firebaseapp.com",
            projectId: "qhse-training",
            storageBucket: "qhse-training.appspot.com",
            messagingSenderId: "4501351718",
            appId: "1:4501351718:web:503b00c9ac052b58e2e5e7"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Test data - 20 –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è –°–£–û–¢
        const correctAnswers = {
            1: 'b', 2: 'c', 3: 'a', 4: 'd', 5: 'b',
            6: 'c', 7: 'a', 8: 'b', 9: 'd', 10: 'a',
            11: 'c', 12: 'b', 13: 'd', 14: 'a', 15: 'c',
            16: 'b', 17: 'd', 18: 'a', 19: 'c', 20: 'b'
        };

        // Test questions - 20 –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ –°–£–û–¢
        const testQuestions = [
            {
                id: 1,
                question: "–ß—Ç–æ —Ç–∞–∫–æ–µ —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ö—Ä–∞–Ω–æ–π —Ç—Ä—É–¥–∞ (–°–£–û–¢)?",
                options: [
                    { id: 'a', text: "–ù–∞–±–æ—Ä –ø—Ä–∞–≤–∏–ª –ø–æ —Ç–µ—Ö–Ω–∏–∫–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏" },
                    { id: 'b', text: "–°–æ–≤–æ–∫—É–ø–Ω–æ—Å—Ç—å –≤–∑–∞–∏–º–æ—Å–≤—è–∑–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∏—Å–∫–∞–º–∏ –≤ –æ–±–ª–∞—Å—Ç–∏ –æ—Ö—Ä–∞–Ω—ã —Ç—Ä—É–¥–∞" },
                    { id: 'c', text: "–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –°–ò–ó" },
                    { id: 'd', text: "–°–∏—Å—Ç–µ–º–∞ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –æ—Å–º–æ—Ç—Ä–æ–≤" }
                ]
            },
            {
                id: 2,
                question: "–ö–∞–∫–æ–π –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –°–£–û–¢?",
                options: [
                    { id: 'a', text: "ISO 9001" },
                    { id: 'b', text: "ISO 14001" },
                    { id: 'c', text: "ISO 45001" },
                    { id: 'd', text: "ISO 50001" }
                ]
            },
            {
                id: 3,
                question: "–ö—Ç–æ –Ω–µ—Å–µ—Ç –æ—Å–Ω–æ–≤–Ω—É—é –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –Ω–∞ —Ä–∞–±–æ—á–µ–º –º–µ—Å—Ç–µ?",
                options: [
                    { id: 'a', text: "–†–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—å" },
                    { id: 'b', text: "–†–∞–±–æ—Ç–Ω–∏–∫" },
                    { id: 'c', text: "–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –æ—Ö—Ä–∞–Ω–µ —Ç—Ä—É–¥–∞" },
                    { id: 'd', text: "–ü—Ä–æ—Ñ—Å–æ—é–∑" }
                ]
            },
            {
                id: 4,
                question: "–ß—Ç–æ —è–≤–ª—è–µ—Ç—Å—è –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–µ–ª—å—é –°–£–û–¢?",
                options: [
                    { id: 'a', text: "–°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–ª–æ–≥–æ–≤" },
                    { id: 'b', text: "–ü–æ–≤—ã—à–µ–Ω–∏–µ –ø—Ä–∏–±—ã–ª–∏" },
                    { id: 'c', text: "–£–ø—Ä–æ—â–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç–∏" },
                    { id: 'd', text: "–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Ç—Ä–∞–≤–º–∞—Ç–∏–∑–º–∞ –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π" }
                ]
            },
            {
                id: 5,
                question: "–ö–∞–∫ —á–∞—Å—Ç–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–æ–¥–∏—Ç—å –æ—Ü–µ–Ω–∫—É —Ä–∏—Å–∫–æ–≤?",
                options: [
                    { id: 'a', text: "–†–∞–∑ –≤ 5 –ª–µ—Ç" },
                    { id: 'b', text: "–†–µ–≥—É–ª—è—Ä–Ω–æ, –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —É—Å–ª–æ–≤–∏–π —Ç—Ä—É–¥–∞" },
                    { id: 'c', text: "–¢–æ–ª—å–∫–æ –ø—Ä–∏ –ø—Ä–∏–µ–º–µ –Ω–∞ —Ä–∞–±–æ—Ç—É" },
                    { id: 'd', text: "–¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –Ω–µ—Å—á–∞—Å—Ç–Ω–æ–≥–æ —Å–ª—É—á–∞—è" }
                ]
            },
            {
                id: 6,
                question: "–ß—Ç–æ —Ç–∞–∫–æ–µ –∏–Ω—Ü–∏–¥–µ–Ω—Ç –≤ —Å–∏—Å—Ç–µ–º–µ –æ—Ö—Ä–∞–Ω—ã —Ç—Ä—É–¥–∞?",
                options: [
                    { id: 'a', text: "–õ—é–±–æ–µ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª" },
                    { id: 'b', text: "–¢–æ–ª—å–∫–æ –Ω–µ—Å—á–∞—Å—Ç–Ω—ã–π —Å–ª—É—á–∞–π" },
                    { id: 'c', text: "–°–æ–±—ã—Ç–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –º–æ–≥–ª–æ –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ —Ç—Ä–∞–≤–º–µ –∏–ª–∏ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—é" },
                    { id: 'd', text: "–¢–æ–ª—å–∫–æ –∞–≤–∞—Ä–∏—è –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ" }
                ]
            },
            {
                id: 7,
                question: "–ö–∞–∫–æ–≤ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ö–æ–¥–Ω–æ–π –±–∞–ª–ª –ø–æ —Ç–µ—Å—Ç—É –≤ –¥–∞–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ?",
                options: [
                    { id: 'a', text: "100%" },
                    { id: 'b', text: "80%" },
                    { id: 'c', text: "70%" },
                    { id: 'd', text: "60%" }
                ]
            },
            {
                id: 8,
                question: "–ß—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç –∞–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä–∞ –°–ò–ó?",
                options: [
                    { id: 'a', text: "–°–∏—Å—Ç–µ–º–∞ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–π –∑–∞—â–∏—Ç—ã" },
                    { id: 'b', text: "–°—Ä–µ–¥—Å—Ç–≤–∞ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–π –∑–∞—â–∏—Ç—ã" },
                    { id: 'c', text: "–°—Ç–∞–Ω–¥–∞—Ä—Ç—ã –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–π –∑–∞—â–∏—Ç—ã" },
                    { id: 'd', text: "–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–π –∑–∞—â–∏—Ç—ã" }
                ]
            },
            {
                id: 9,
                question: "–ö–∞–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç —è–≤–ª—è–µ—Ç—Å—è –æ—Å–Ω–æ–≤–Ω—ã–º –ø–æ –æ—Ö—Ä–∞–Ω–µ —Ç—Ä—É–¥–∞ –≤ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏?",
                options: [
                    { id: 'a', text: "–¢—Ä—É–¥–æ–≤–æ–π –¥–æ–≥–æ–≤–æ—Ä" },
                    { id: 'b', text: "–®—Ç–∞—Ç–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ" },
                    { id: 'c', text: "–ü—Ä–∞–≤–∏–ª–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Ç—Ä—É–¥–æ–≤–æ–≥–æ —Ä–∞—Å–ø–æ—Ä—è–¥–∫–∞" },
                    { id: 'd', text: "–ü–æ–ª–æ–∂–µ–Ω–∏–µ –æ —Å–∏—Å—Ç–µ–º–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ö—Ä–∞–Ω–æ–π —Ç—Ä—É–¥–∞" }
                ]
            },
            {
                id: 10,
                question: "–î–ª—è —á–µ–≥–æ –ø—Ä–æ–≤–æ–¥–∏—Ç—Å—è –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂ –ø–æ –æ—Ö—Ä–∞–Ω–µ —Ç—Ä—É–¥–∞?",
                options: [
                    { id: 'a', text: "–î–ª—è –æ–∑–Ω–∞–∫–æ–º–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤ —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏" },
                    { id: 'b', text: "–î–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç–µ–π" },
                    { id: 'c', text: "–¢–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤" },
                    { id: 'd', text: "–¢–æ–ª—å–∫–æ –¥–ª—è –æ–ø–∞—Å–Ω—ã—Ö —Ä–∞–±–æ—Ç" }
                ]
            },
            {
                id: 11,
                question: "–ß—Ç–æ —Ç–∞–∫–æ–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –æ–ø–∞—Å–Ω–æ—Å—Ç–µ–π?",
                options: [
                    { id: 'a', text: "–ù–∞–∫–∞–∑–∞–Ω–∏–µ –∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª" },
                    { id: 'b', text: "–í—ã–¥–∞—á–∞ —Å—Ä–µ–¥—Å—Ç–≤ –∑–∞—â–∏—Ç—ã" },
                    { id: 'c', text: "–ü—Ä–æ—Ü–µ—Å—Å –≤—ã—è–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –æ–ø–∞—Å–Ω–æ—Å—Ç–∏" },
                    { id: 'd', text: "–ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –º–µ–¥–æ—Å–º–æ—Ç—Ä–æ–≤" }
                ]
            },
            {
                id: 12,
                question: "–ö–∞–∫ —á–∞—Å—Ç–æ –ø—Ä–æ–≤–æ–¥—è—Ç—Å—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –æ—Å–º–æ—Ç—Ä—ã?",
                options: [
                    { id: 'a', text: "–ï–∂–µ–≥–æ–¥–Ω–æ" },
                    { id: 'b', text: "–í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—Ä–µ–¥–Ω—ã—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤" },
                    { id: 'c', text: "–†–∞–∑ –≤ 3 –≥–æ–¥–∞" },
                    { id: 'd', text: "–¢–æ–ª—å–∫–æ –ø—Ä–∏ —É—Ö—É–¥—à–µ–Ω–∏–∏ –∑–¥–æ—Ä–æ–≤—å—è" }
                ]
            },
            {
                id: 13,
                question: "–ß—Ç–æ —Ç–∞–∫–æ–µ –ø–ª–∞–Ω –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –ø–æ –æ—Ö—Ä–∞–Ω–µ —Ç—Ä—É–¥–∞?",
                options: [
                    { id: 'a', text: "–°–ø–∏—Å–æ–∫ —à—Ç—Ä–∞—Ñ–æ–≤" },
                    { id: 'b', text: "–ì—Ä–∞—Ñ–∏–∫ –æ—Ç–ø—É—Å–∫–æ–≤" },
                    { id: 'c', text: "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã" },
                    { id: 'd', text: "–î–æ–∫—É–º–µ–Ω—Ç —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è–º–∏ –∏ —Å—Ä–æ–∫–∞–º–∏ –∏—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è" }
                ]
            },
            {
                id: 14,
                question: "–ö—Ç–æ –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–≤–æ–¥–∏—Ç—å –≤–≤–æ–¥–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂ –ø–æ –æ—Ö—Ä–∞–Ω–µ —Ç—Ä—É–¥–∞?",
                options: [
                    { id: 'a', text: "–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –æ—Ö—Ä–∞–Ω–µ —Ç—Ä—É–¥–∞" },
                    { id: 'b', text: "–ë—É—Ö–≥–∞–ª—Ç–µ—Ä" },
                    { id: 'c', text: "–ù–∞—á–∞–ª—å–Ω–∏–∫ –æ—Ç–¥–µ–ª–∞" },
                    { id: 'd', text: "–ö–æ–ª–ª–µ–≥–∞ –ø–æ —Ä–∞–±–æ—Ç–µ" }
                ]
            },
            {
                id: 15,
                question: "–ß—Ç–æ —Ç–∞–∫–æ–µ —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –Ω–µ—Å—á–∞—Å—Ç–Ω–æ–≥–æ —Å–ª—É—á–∞—è?",
                options: [
                    { id: 'a', text: "–ü–æ–∏—Å–∫ –≤–∏–Ω–æ–≤–Ω—ã—Ö" },
                    { id: 'b', text: "–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —à—Ç—Ä–∞—Ñ–æ–≤" },
                    { id: 'c', text: "–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏—á–∏–Ω –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –º–µ—Ä" },
                    { id: 'd', text: "–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –±–æ–ª—å–Ω–∏—á–Ω–æ–≥–æ" }
                ]
            },
            {
                id: 16,
                question: "–ö–∞–∫–æ–π –æ—Ä–≥–∞–Ω –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–π –Ω–∞–¥–∑–æ—Ä –∑–∞ –æ—Ö—Ä–∞–Ω–æ–π —Ç—Ä—É–¥–∞?",
                options: [
                    { id: 'a', text: "–ú–í–î" },
                    { id: 'b', text: "–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–∞—è –∏–Ω—Å–ø–µ–∫—Ü–∏—è —Ç—Ä—É–¥–∞" },
                    { id: 'c', text: "–ü—Ä–æ–∫—É—Ä–∞—Ç—É—Ä–∞" },
                    { id: 'd', text: "–°—É–¥" }
                ]
            },
            {
                id: 17,
                question: "–ß—Ç–æ —Ç–∞–∫–æ–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä–∏—Å–∫?",
                options: [
                    { id: 'a', text: "–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–≤—ã—à–µ–Ω–∏—è –∑–∞—Ä–ø–ª–∞—Ç—ã" },
                    { id: 'b', text: "–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∫–∞—Ä—å–µ—Ä–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞" },
                    { id: 'c', text: "–®–∞–Ω—Å –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–µ–º–∏—é" },
                    { id: 'd', text: "–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø—Ä–∏—á–∏–Ω–µ–Ω–∏—è –≤—Ä–µ–¥–∞ –∑–¥–æ—Ä–æ–≤—å—é –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ç—Ä—É–¥–æ–≤–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏" }
                ]
            },
            {
                id: 18,
                question: "–ö–∞–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç –æ—Ñ–æ—Ä–º–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–∞?",
                options: [
                    { id: 'a', text: "–ñ—É—Ä–Ω–∞–ª —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–∞" },
                    { id: 'b', text: "–ü—Ä–∏–∫–∞–∑ –æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏" },
                    { id: 'c', text: "–¢—Ä—É–¥–æ–≤–æ–π –¥–æ–≥–æ–≤–æ—Ä" },
                    { id: 'd', text: "–ë–æ–ª—å–Ω–∏—á–Ω—ã–π –ª–∏—Å—Ç" }
                ]
            },
            {
                id: 19,
                question: "–ß—Ç–æ —Ç–∞–∫–æ–µ —Å–ø–µ—Ü–æ—Ü–µ–Ω–∫–∞ —É—Å–ª–æ–≤–∏–π —Ç—Ä—É–¥–∞?",
                options: [
                    { id: 'a', text: "–û—Ü–µ–Ω–∫–∞ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞" },
                    { id: 'b', text: "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–Ω–∞–Ω–∏–π" },
                    { id: 'c', text: "–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–¥–Ω—ã—Ö –∏ –æ–ø–∞—Å–Ω—ã—Ö –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤" },
                    { id: 'd', text: "–ê—Ç—Ç–µ—Å—Ç–∞—Ü–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è" }
                ]
            },
            {
                id: 20,
                question: "–ö–æ–º—É —Ä–∞–±–æ—Ç–Ω–∏–∫ –¥–æ–ª–∂–µ–Ω —Å–æ–æ–±—â–∏—Ç—å –æ –Ω–µ—Å—á–∞—Å—Ç–Ω–æ–º —Å–ª—É—á–∞–µ –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ?",
                options: [
                    { id: 'a', text: "–¢–æ–ª—å–∫–æ –∫–æ–ª–ª–µ–≥–∞–º" },
                    { id: 'b', text: "–ù–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ–º—É —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—é" },
                    { id: 'c', text: "–¢–æ–ª—å–∫–æ –≤ –ø—Ä–æ—Ñ—Å–æ—é–∑" },
                    { id: 'd', text: "–ù–∏–∫–æ–º—É" }
                ]
            }
        ];

        // Global variables
        let currentUser = null;
        let courseId = null;
        let courseData = null;
        let userAnswers = {};
        let currentQuestionIndex = 0;
        let timeLeft = 90 * 60; // 90 minutes in seconds
        let timerInterval = null;
        let testCompleted = false;

        // Initialize test
        async function initTest() {
            try {
                // Check authentication
                currentUser = await new Promise((resolve, reject) => {
                    const unsubscribe = auth.onAuthStateChanged(user => {
                        unsubscribe();
                        if (user) {
                            resolve(user);
                        } else {
                            reject(new Error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω'));
                        }
                    });
                });

                // Get course ID from URL
                const urlParams = new URLSearchParams(window.location.search);
                courseId = urlParams.get('id');
                
                if (!courseId) {
                    showError('ID –∫—É—Ä—Å–∞ –Ω–µ —É–∫–∞–∑–∞–Ω –≤ URL. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Å—ã–ª–∫—É.');
                    return;
                }

                // Load course data
                await loadCourseData();

                // Show requirements
                document.getElementById('requirementsInfo').style.display = 'block';

                // Load user progress to check if slides were viewed
                const canTakeTest = await checkTestRequirements();
                
                if (!canTakeTest) {
                    return;
                }

                // Start test
                startTest();

                // Start timer
                startTimer();

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                showError('–î–ª—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ç–µ—Å—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É');
            }
        }

        // Load course data
        async function loadCourseData() {
            try {
                const courseDoc = await db.collection('courses').doc(courseId).get();
                if (courseDoc.exists) {
                    courseData = courseDoc.data();
                    document.getElementById('testTitle').textContent = `–¢–µ—Å—Ç: ${courseData.title || '–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ö—Ä–∞–Ω–æ–π —Ç—Ä—É–¥–∞ (–°–£–û–¢)'}`;
                    document.getElementById('courseInfo').textContent = courseData.description || '';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∫—É—Ä—Å–∞:', error);
            }
        }

        // Check test requirements
        async function checkTestRequirements() {
            try {
                const progressDoc = await db.collection('user_progress').doc(currentUser.uid).get();
                if (progressDoc.exists) {
                    const allProgress = progressDoc.data();
                    const courseProgress = allProgress[courseId] || {};
                    
                    // Check if user has viewed all slides
                    if (!courseProgress.slidesViewed || courseProgress.slidesViewed < 100) {
                        showError('–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–µ—Å—Ç—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∫—É—Ä—Å–∞ (100% —Å–ª–∞–π–¥–æ–≤)');
                        return false;
                    }
                    
                    // Check if user already passed the test
                    if (courseProgress.testPassed) {
                        showTestAlreadyPassed(courseProgress.testScore);
                        return false;
                    }
                    
                    return true;
                } else {
                    showError('–ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –∫—É—Ä—Å—É –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–π–¥–∏—Ç–µ –∫—É—Ä—Å —Å–Ω–∞—á–∞–ª–∞.');
                    return false;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π:', error);
                // For testing, allow test even if progress cannot be loaded
                return true;
            }
        }

        // Start test
        function startTest() {
            document.getElementById('totalQuestions').textContent = testQuestions.length;
            document.getElementById('totalQuestionsNum').textContent = testQuestions.length;
            
            displayQuestion();
            document.getElementById('navigation').style.display = 'flex';
            updateProgressBar();
        }

        // Display current question
        function displayQuestion() {
            const question = testQuestions[currentQuestionIndex];
            const testContent = document.getElementById('testContent');
            
            let optionsHTML = '';
            question.options.forEach(option => {
                const isSelected = userAnswers[question.id] === option.id;
                optionsHTML += `
                    <div class="option ${isSelected ? 'selected' : ''}" 
                         onclick="selectAnswer(${question.id}, '${option.id}')">
                        <div class="option-label">${option.id.toUpperCase()}</div>
                        <div class="option-text">${option.text}</div>
                    </div>
                `;
            });
            
            testContent.innerHTML = `
                <div class="question-container">
                    <div class="question active">
                        <div class="question-number">
                            <i class="fas fa-question-circle"></i>
                            <span>–í–æ–ø—Ä–æ—Å ${question.id}</span>
                        </div>
                        <div class="question-text">${question.question}</div>
                        <div class="options">
                            ${optionsHTML}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('currentQuestionNum').textContent = currentQuestionIndex + 1;
            
            // Update navigation buttons
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            document.getElementById('nextBtn').innerHTML = 
                currentQuestionIndex === testQuestions.length - 1 
                    ? '–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç <i class="fas fa-check"></i>' 
                    : '–î–∞–ª–µ–µ <i class="fas fa-arrow-right"></i>';
        }

        // Select answer
        function selectAnswer(questionId, answerId) {
            userAnswers[questionId] = answerId;
            displayQuestion();
            updateProgressBar();
        }

        // Next question
        function nextQuestion() {
            if (currentQuestionIndex < testQuestions.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            } else {
                submitTest();
            }
        }

        // Previous question
        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion();
            }
        }

        // Update progress bar
        function updateProgressBar() {
            const answeredCount = Object.keys(userAnswers).length;
            const progress = (answeredCount / testQuestions.length) * 100;
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = `${progress}%`;
            
            // Change color based on progress
            if (progress >= 100) {
                progressBar.style.background = '#2ecc71';
            } else if (progress >= 50) {
                progressBar.style.background = '#f39c12';
            } else {
                progressBar.style.background = '#3498db';
            }
        }

        // Start timer
        function startTimer() {
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    submitTest();
                }
            }, 1000);
        }

        // Update timer display
        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('timer').textContent = 
                `‚è∞ ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Submit test
        async function submitTest() {
            if (testCompleted) return;
            testCompleted = true;
            
            clearInterval(timerInterval);
            
            // Calculate results
            const totalQuestions = testQuestions.length;
            let correctCount = 0;
            let incorrectQuestions = [];
            
            testQuestions.forEach(question => {
                const userAnswer = userAnswers[question.id];
                const correctAnswer = correctAnswers[question.id];
                
                if (userAnswer === correctAnswer) {
                    correctCount++;
                } else {
                    incorrectQuestions.push({
                        question: question.question,
                        userAnswer: userAnswer,
                        correctAnswer: correctAnswer
                    });
                }
            });
            
            const score = Math.round((correctCount / totalQuestions) * 100);
            const passed = score >= 100; // 100% required
            
            try {
                // Save results to Firestore
                await saveTestResults(score, passed, correctCount);
                
                // Update progress if passed
                if (passed) {
                    await updateUserProgress(score);
                }
                
                // Display results
                displayResults(score, passed, correctCount, totalQuestions, incorrectQuestions);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ç–µ—Å—Ç–∞:', error);
                displayResults(score, passed, correctCount, totalQuestions, incorrectQuestions);
            }
        }

        // Save test results to Firestore
        async function saveTestResults(score, passed, correctCount) {
            try {
                const resultId = `${currentUser.uid}_${courseId}_${Date.now()}`;
                const resultData = {
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    userName: currentUser.displayName || currentUser.email.split('@')[0],
                    courseId: courseId,
                    courseTitle: courseData?.title || '–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ö—Ä–∞–Ω–æ–π —Ç—Ä—É–¥–∞ (–°–£–û–¢)',
                    score: score,
                    passed: passed,
                    correctAnswers: correctCount,
                    totalQuestions: testQuestions.length,
                    answers: userAnswers,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    completedAt: new Date().toISOString(),
                    timeSpent: (90 * 60) - timeLeft // in seconds
                };
                
                await db.collection('test_results').doc(resultId).set(resultData);
                console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã:', resultId);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:', error);
                throw error;
            }
        }

        // Update user progress
        async function updateUserProgress(score) {
            try {
                const progressDocRef = db.collection('user_progress').doc(currentUser.uid);
                
                const progressUpdate = {
                    [courseId]: {
                        testPassed: true,
                        testScore: score,
                        testCompletedAt: new Date().toISOString(),
                        lastActivity: firebase.firestore.FieldValue.serverTimestamp(),
                        answers: userAnswers
                    }
                };
                
                await progressDocRef.set(progressUpdate, { merge: true });
                console.log('–ü—Ä–æ–≥—Ä–µ—Å—Å –æ–±–Ω–æ–≤–ª–µ–Ω');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', error);
                throw error;
            }
        }

        // Display results
        function displayResults(score, passed, correctCount, totalQuestions, incorrectQuestions = []) {
            const testContent = document.getElementById('testContent');
            const navigation = document.getElementById('navigation');
            const requirementsInfo = document.getElementById('requirementsInfo');
            
            navigation.style.display = 'none';
            if (requirementsInfo) requirementsInfo.style.display = 'none';
            
            let resultHTML = `
                <div class="results-container">
                    <div class="score-circle ${passed ? 'score-passed' : 'score-failed'}">
                        <div class="score-percent">${score}%</div>
                        <div class="score-label">${passed ? '–°–î–ê–ù–û' : '–ù–ï –°–î–ê–ù–û'}</div>
                    </div>
                    <h2 style="font-size: 32px; margin-bottom: 15px;">${passed ? 'üéâ –¢–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–π–¥–µ–Ω!' : '‚ùå –¢–µ—Å—Ç –Ω–µ –ø—Ä–æ–π–¥–µ–Ω'}</h2>
                    <p style="font-size: 18px; color: #666; margin-bottom: 30px;">
                        ${passed ? '–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—à–ª–∏ —Ç–µ—Å—Ç –∏ –ø–æ–ª—É—á–∞–µ—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç.' : '–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤—ã –Ω–µ –Ω–∞–±—Ä–∞–ª–∏ 100% –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤.'}
                    </p>
                    
                    <div class="results-details">
                        <div class="result-item">
                            <span><i class="fas fa-check-circle" style="color: #2ecc71;"></i> –ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤:</span>
                            <span><strong>${correctCount} –∏–∑ ${totalQuestions}</strong></span>
                        </div>
                        <div class="result-item">
                            <span><i class="fas fa-percentage" style="color: #3498db;"></i> –ü—Ä–æ—Ü–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:</span>
                            <span><strong>${score}%</strong></span>
                        </div>
                        <div class="result-item">
                            <span><i class="fas fa-target" style="color: #e74c3c;"></i> –¢—Ä–µ–±—É–µ–º—ã–π –º–∏–Ω–∏–º—É–º:</span>
                            <span><strong>100%</strong></span>
                        </div>
                        <div class="result-item">
                            <span><i class="fas fa-flag" style="color: #9b59b6;"></i> –°—Ç–∞—Ç—É—Å:</span>
                            <span><strong style="color: ${passed ? '#2ecc71' : '#e74c3c'}">${passed ? '–ü–†–û–ô–î–ï–ù' : '–ù–ï –ü–†–û–ô–î–ï–ù'}</strong></span>
                        </div>
                    </div>
            `;
            
            if (passed) {
                resultHTML += `
                    <button class="certificate-btn" onclick="generateCertificate(${score})">
                        <i class="fas fa-award"></i> –ü–æ–ª—É—á–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
                    </button>
                    <p style="color: #666; margin-top: 20px; font-size: 16px;">
                        <i class="fas fa-info-circle" style="color: #3498db;"></i>
                        –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º
                    </p>
                `;
            } else {
                resultHTML += `
                    <div style="margin: 30px 0;">
                        <h3 style="color: #e74c3c; margin-bottom: 15px;">
                            <i class="fas fa-exclamation-triangle"></i> –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã:
                        </h3>
                        <div style="text-align: left; max-width: 600px; margin: 0 auto;">
                            ${incorrectQuestions.map((item, index) => `
                                <div style="background: #ffebee; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #e74c3c;">
                                    <p><strong>–í–æ–ø—Ä–æ—Å ${index + 1}:</strong> ${item.question}</p>
                                    <p style="color: #e74c3c;"><i class="fas fa-times"></i> –í–∞—à –æ—Ç–≤–µ—Ç: ${item.userAnswer ? item.userAnswer.toUpperCase() : '–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞'}</p>
                                    <p style="color: #2ecc71;"><i class="fas fa-check"></i> –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: ${item.correctAnswer.toUpperCase()}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <button class="certificate-btn" onclick="retryTest()" style="background: var(--warning);">
                        <i class="fas fa-redo"></i> –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                    </button>
                    <p style="color: #666; margin-top: 20px; font-size: 16px;">
                        –î–ª—è —É—Å–ø–µ—à–Ω–æ–π —Å–¥–∞—á–∏ —Ç–µ—Å—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ—Ç–≤–µ—Ç–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã
                    </p>
                `;
            }
            
            resultHTML += `
                    <div style="margin-top: 40px; display: flex; justify-content: center; gap: 20px;">
                        <button onclick="window.location.href='https://qhse-training.github.io/hse-course/courses.html'" 
                                style="padding: 12px 25px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-arrow-left"></i> –ö —Å–ø–∏—Å–∫—É –∫—É—Ä—Å–æ–≤
                        </button>
                        <button onclick="window.location.href='https://qhse-training.github.io/hse-course/${courseId}/course.html?id=${courseId}'" 
                                style="padding: 12px 25px; background: var(--secondary); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-book"></i> –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∫—É—Ä—Å
                        </button>
                    </div>
                </div>
            `;
            
            testContent.innerHTML = resultHTML;
        }

        // Show test already passed
        function showTestAlreadyPassed(score) {
            const testContent = document.getElementById('testContent');
            const navigation = document.getElementById('navigation');
            const requirementsInfo = document.getElementById('requirementsInfo');
            
            navigation.style.display = 'none';
            if (requirementsInfo) requirementsInfo.style.display = 'none';
            
            testContent.innerHTML = `
                <div class="results-container">
                    <div class="score-circle score-passed">
                        <div class="score-percent">${score}%</div>
                        <div class="score-label">–£–ñ–ï –°–î–ê–ù–û</div>
                    </div>
                    <h2 style="font-size: 32px; margin-bottom: 15px;">üéâ –í—ã —É–∂–µ –ø—Ä–æ—à–ª–∏ —ç—Ç–æ—Ç —Ç–µ—Å—Ç!</h2>
                    <p style="font-size: 18px; color: #666; margin-bottom: 30px;">
                        –í—ã —É–∂–µ —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—à–ª–∏ —ç—Ç–æ—Ç —Ç–µ—Å—Ç ${score}%. –î–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π —Å–¥–∞—á–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.
                    </p>
                    
                    <button class="certificate-btn" onclick="showExistingCertificate()">
                        <i class="fas fa-award"></i> –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
                    </button>
                    
                    <div style="margin-top: 40px;">
                        <button onclick="window.location.href='https://qhse-training.github.io/hse-course/courses.html'" 
                                style="padding: 12px 25px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 10px; margin: 0 auto;">
                            <i class="fas fa-arrow-left"></i> –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫—É—Ä—Å–∞–º
                        </button>
                    </div>
                </div>
            `;
        }

        // Show existing certificate
        async function showExistingCertificate() {
            try {
                const progressDoc = await db.collection('user_progress').doc(currentUser.uid).get();
                if (progressDoc.exists) {
                    const allProgress = progressDoc.data();
                    const courseProgress = allProgress[courseId] || {};
                    
                    if (courseProgress.certificateId) {
                        await showCertificate(
                            courseProgress.certificateId,
                            courseProgress.certificateScore || 100,
                            courseProgress.certificateDate || new Date().toISOString()
                        );
                    } else {
                        // Generate new certificate if not exists
                        await generateCertificate(courseProgress.testScore || 100);
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞');
            }
        }

        // Generate certificate
        async function generateCertificate(score) {
            try {
                // Generate unique certificate ID
                const certificateId = 'CERT-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9).toUpperCase();
                
                // Get user data
                const userDoc = await db.collection('approved_users').doc(currentUser.uid).get();
                const userData = userDoc.exists ? userDoc.data() : {};
                const userName = userData.fullName || currentUser.displayName || currentUser.email.split('@')[0];
                
                // Get course data
                const courseTitle = courseData?.title || '–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ –æ—Ö—Ä–∞–Ω–µ —Ç—Ä—É–¥–∞ (–°–£–û–¢)';
                
                // Update progress with certificate
                await db.collection('user_progress').doc(currentUser.uid).set({
                    [courseId]: {
                        certificateGenerated: true,
                        certificateId: certificateId,
                        certificateDate: new Date().toISOString(),
                        certificateScore: score,
                        certificateDownloaded: true
                    }
                }, { merge: true });
                
                // Save certificate to certificates collection
                await db.collection('certificates').doc(certificateId).set({
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    userName: userName,
                    courseId: courseId,
                    courseTitle: courseTitle,
                    score: score,
                    certificateId: certificateId,
                    issueDate: new Date().toISOString(),
                    issuedBy: 'QHSE-Solutions.kz',
                    status: 'active'
                });
                
                // Show certificate
                await showCertificate(certificateId, score);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
            }
        }

        // Show certificate
        async function showCertificate(certificateId, score, certificateDate = null) {
            // Get user data
            const userDoc = await db.collection('approved_users').doc(currentUser.uid).get();
            const userData = userDoc.exists ? userDoc.data() : {};
            const userName = userData.fullName || currentUser.displayName || currentUser.email.split('@')[0];
            
            const courseTitle = courseData?.title || '–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ –æ—Ö—Ä–∞–Ω–µ —Ç—Ä—É–¥–∞ (–°–£–û–¢)';
            const currentDate = certificateDate ? new Date(certificateDate).toLocaleDateString('ru-RU') : new Date().toLocaleDateString('ru-RU');
            
            const certificateWindow = window.open('', '_blank', 'width=1000,height=800,scrollbars=yes');
            
            certificateWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç - ${courseTitle}</title>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto:wght@300;400;500&display=swap');
                        
                        body { 
                            font-family: 'Roboto', sans-serif; 
                            padding: 40px; 
                            text-align: center; 
                            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                            min-height: 100vh;
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            margin: 0;
                        }
                        
                        .certificate-container {
                            background: white;
                            border-radius: 15px;
                            padding: 50px;
                            width: 900px;
                            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
                            border: 10px solid #2c3e50;
                            position: relative;
                            overflow: hidden;
                        }
                        
                        .certificate-header {
                            margin-bottom: 40px;
                            padding-bottom: 20px;
                            border-bottom: 3px solid #3498db;
                        }
                        
                        .certificate-title {
                            font-family: 'Playfair Display', serif;
                            font-size: 48px;
                            font-weight: 700;
                            color: #2c3e50;
                            margin: 0;
                            letter-spacing: 3px;
                            text-transform: uppercase;
                        }
                        
                        .certificate-subtitle {
                            font-size: 20px;
                            color: #7f8c8d;
                            margin-top: 15px;
                            font-weight: 300;
                        }
                        
                        .certificate-content {
                            margin: 40px 0;
                            padding: 30px;
                            background: #f8f9fa;
                            border-radius: 10px;
                            border-left: 5px solid #3498db;
                        }
                        
                        .certificate-name {
                            font-family: 'Playfair Display', serif;
                            font-size: 36px;
                            color: #e74c3c;
                            margin: 25px 0;
                            font-weight: 700;
                        }
                        
                        .certificate-course {
                            font-size: 28px;
                            color: #2c3e50;
                            margin: 30px 0;
                            font-weight: 500;
                            line-height: 1.4;
                        }
                        
                        .certificate-details {
                            display: flex;
                            justify-content: space-between;
                            margin-top: 50px;
                            padding-top: 30px;
                            border-top: 2px solid #eee;
                        }
                        
                        .detail-item {
                            text-align: center;
                            flex: 1;
                        }
                        
                        .detail-label {
                            font-size: 16px;
                            color: #7f8c8d;
                            margin-bottom: 8px;
                            text-transform: uppercase;
                            letter-spacing: 1px;
                        }
                        
                        .detail-value {
                            font-size: 20px;
                            color: #2c3e50;
                            font-weight: 500;
                        }
                        
                        .certificate-footer {
                            margin-top: 60px;
                            padding-top: 30px;
                            border-top: 2px solid #3498db;
                            display: flex;
                            justify-content: space-between;
                            align-items: flex-end;
                        }
                        
                        .signature {
                            text-align: center;
                        }
                        
                        .signature-line {
                            width: 200px;
                            height: 1px;
                            background: #2c3e50;
                            margin: 20px auto;
                        }
                        
                        .issued-by {
                            font-size: 18px;
                            color: #2c3e50;
                            font-weight: 500;
                            margin-top: 10px;
                        }
                        
                        .certificate-id {
                            background: #2c3e50;
                            color: white;
                            padding: 10px 20px;
                            border-radius: 5px;
                            font-family: monospace;
                            font-size: 14px;
                            letter-spacing: 1px;
                            display: inline-block;
                            margin-top: 20px;
                        }
                        
                        .watermark {
                            position: absolute;
                            opacity: 0.03;
                            font-size: 200px;
                            transform: rotate(-45deg);
                            top: 30%;
                            left: 10%;
                            white-space: nowrap;
                            color: #2c3e50;
                            font-family: 'Playfair Display', serif;
                            font-weight: 700;
                            z-index: 0;
                        }
                        
                        .seal {
                            position: absolute;
                            top: 50px;
                            right: 50px;
                            width: 120px;
                            height: 120px;
                            border: 3px solid #e74c3c;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-family: 'Playfair Display', serif;
                            font-size: 14px;
                            font-weight: 700;
                            color: #e74c3c;
                            text-align: center;
                            padding: 10px;
                            background: rgba(255,255,255,0.9);
                            transform: rotate(15deg);
                        }
                        
                        .print-btn {
                            background: #3498db;
                            color: white;
                            border: none;
                            padding: 12px 25px;
                            border-radius: 5px;
                            font-size: 16px;
                            cursor: pointer;
                            margin-top: 30px;
                            display: flex;
                            align-items: center;
                            gap: 10px;
                            margin-left: auto;
                            margin-right: auto;
                        }
                        
                        .print-btn:hover {
                            background: #2980b9;
                        }
                        
                        @media print {
                            body {
                                background: white !important;
                            }
                            .certificate-container {
                                box-shadow: none !important;
                                border: 15px solid #2c3e50 !important;
                                margin: 0;
                                padding: 30px;
                            }
                            .print-btn {
                                display: none !important;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="certificate-container">
                        <div class="watermark">–°–ï–†–¢–ò–§–ò–ö–ê–¢</div>
                        <div class="seal">
                            QHSE<br>SOLUTIONS
                        </div>
                        
                        <div class="certificate-header">
                            <h1 class="certificate-title">–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç</h1>
                            <p class="certificate-subtitle">–ù–∞—Å—Ç–æ—è—â–∏–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è, —á—Ç–æ</p>
                        </div>
                        
                        <div class="certificate-content">
                            <div class="certificate-name">${userName}</div>
                            <p style="font-size: 20px; margin: 20px 0;">—É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—à—ë–ª(–∞) –∫—É—Ä—Å –æ–±—É—á–µ–Ω–∏—è –ø–æ –ø—Ä–æ–≥—Ä–∞–º–º–µ</p>
                            <div class="certificate-course">"${courseTitle}"</div>
                            <p style="font-size: 16px; color: #7f8c8d; margin-top: 20px;">
                                –†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: <strong>${score}%</strong>
                            </p>
                        </div>
                        
                        <div class="certificate-details">
                            <div class="detail-item">
                                <div class="detail-label">–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏</div>
                                <div class="detail-value">${currentDate}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">ID —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞</div>
                                <div class="detail-value">${certificateId}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">–°—Ç–∞—Ç—É—Å</div>
                                <div class="detail-value" style="color: #2ecc71;">–î–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω</div>
                            </div>
                        </div>
                        
                        <div class="certificate-footer">
                            <div class="signature">
                                <div class="signature-line"></div>
                                <div class="issued-by">–í—ã–¥–∞–Ω–æ: QHSE-Solutions.kz</div>
                                <div style="color: #7f8c8d; font-size: 14px; margin-top: 5px;">–¶–µ–Ω—Ç—Ä –æ–±—É—á–µ–Ω–∏—è –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: #3498db; letter-spacing: 2px;">QHSE-SOLUTIONS</div>
                                <div style="color: #7f8c8d; font-size: 14px; margin-top: 5px;">–û—Ö—Ä–∞–Ω–∞ —Ç—Ä—É–¥–∞ –∏ –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</div>
                            </div>
                        </div>
                        
                        <div class="certificate-id">ID: ${certificateId}</div>
                        
                        <button class="print-btn" onclick="window.print()">
                            <i class="fas fa-print"></i> –†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
                        </button>
                    </div>
                </body>
                </html>
            `);
            
            certificateWindow.focus();
        }

        // Retry test
        function retryTest() {
            window.location.reload();
        }

        // Show error
        function showError(message) {
            const testContent = document.getElementById('testContent');
            testContent.innerHTML = `
                <div class="results-container">
                    <div style="color: var(--error); font-size: 48px; margin-bottom: 20px;">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h2 style="color: var(--error); margin-bottom: 20px;">–û—à–∏–±–∫–∞</h2>
                    <p style="font-size: 18px; color: #666; margin-bottom: 30px; max-width: 600px; margin-left: auto; margin-right: auto;">
                        ${message}
                    </p>
                    <div style="margin-top: 30px;">
                        <button onclick="window.location.href='https://qhse-training.github.io/hse-course/courses.html'" 
                                style="padding: 12px 25px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 10px; margin: 0 auto;">
                            <i class="fas fa-arrow-left"></i> –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫—É—Ä—Å–∞–º
                        </button>
                    </div>
                </div>
            `;
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            initTest();
        });

        // Handle keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                return;
            }
            
            switch(e.key) {
                case 'ArrowLeft':
                    prevQuestion();
                    break;
                case 'ArrowRight':
                case ' ':
                    e.preventDefault();
                    nextQuestion();
                    break;
                case 'Enter':
                    if (currentQuestionIndex === testQuestions.length - 1) {
                        submitTest();
                    }
                    break;
                case '1':
                case '2':
                case '3':
                case '4':
                    const answer = e.key.toLowerCase();
                    if (['a', 'b', 'c', 'd'].includes(answer)) {
                        selectAnswer(testQuestions[currentQuestionIndex].id, answer);
                    }
                    break;
            }
        });
    </script>
</body>
</html>