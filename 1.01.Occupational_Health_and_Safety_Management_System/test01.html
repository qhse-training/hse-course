<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç: –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ö—Ä–∞–Ω–æ–π —Ç—Ä—É–¥–∞</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #2ecc71;
            --error: #e74c3c;
            --warning: #f39c12;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .test-header {
            background: var(--primary);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .test-header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .test-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding: 0 10px;
            font-size: 14px;
        }
        
        .timer {
            background: var(--warning);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
        }
        
        .progress-container {
            width: 100%;
            background: #eee;
            height: 10px;
            border-radius: 5px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: var(--success);
            width: 0%;
            transition: width 0.3s;
        }
        
        .question-container {
            padding: 30px;
        }
        
        .question {
            margin-bottom: 25px;
            padding: 20px;
            border: 2px solid #eee;
            border-radius: 10px;
            transition: all 0.3s;
        }
        
        .question.active {
            border-color: var(--secondary);
            background: #f8f9fa;
        }
        
        .question-number {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .question-text {
            font-size: 18px;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .option {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .option:hover {
            border-color: var(--secondary);
            background: #f0f8ff;
        }
        
        .option.selected {
            border-color: var(--secondary);
            background: #e3f2fd;
        }
        
        .option.correct {
            border-color: var(--success);
            background: #e8f5e9;
        }
        
        .option.incorrect {
            border-color: var(--error);
            background: #ffebee;
        }
        
        .option input {
            display: none;
        }
        
        .option-label {
            width: 24px;
            height: 24px;
            border: 2px solid #ccc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #666;
        }
        
        .option.selected .option-label {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }
        
        .option-text {
            flex: 1;
            font-size: 16px;
        }
        
        .navigation {
            display: flex;
            justify-content: space-between;
            padding: 20px 30px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
        }
        
        .nav-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            background: var(--secondary);
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .nav-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .nav-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .submit-btn {
            background: var(--success);
        }
        
        .submit-btn:hover {
            background: #27ae60;
        }
        
        .results-container {
            padding: 40px;
            text-align: center;
        }
        
        .score-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin: 0 auto 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            font-weight: bold;
            border: 10px solid;
        }
        
        .score-passed {
            border-color: var(--success);
            color: var(--success);
            background: #e8f5e9;
        }
        
        .score-failed {
            border-color: var(--error);
            color: var(--error);
            background: #ffebee;
        }
        
        .results-details {
            margin: 30px 0;
            text-align: left;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .certificate-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin: 20px 0;
            transition: all 0.3s;
        }
        
        .certificate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--secondary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1 id="testTitle">–¢–µ—Å—Ç: –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ö—Ä–∞–Ω–æ–π —Ç—Ä—É–¥–∞ (–°–£–û–¢)</h1>
            <div class="test-info">
                <div>–í–æ–ø—Ä–æ—Å–æ–≤: <span id="totalQuestions">0</span></div>
                <div class="timer" id="timer">‚è∞ 60:00</div>
            </div>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>
        
        <div id="testContent">
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç —Ç–µ—Å—Ç–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω —Å—é–¥–∞ -->
        </div>
        
        <div class="navigation" id="navigation" style="display: none;">
            <button class="nav-btn" id="prevBtn" onclick="prevQuestion()">
                <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥
            </button>
            <div>
                –í–æ–ø—Ä–æ—Å <span id="currentQuestionNum">1</span> –∏–∑ <span id="totalQuestionsNum">0</span>
            </div>
            <button class="nav-btn" id="nextBtn" onclick="nextQuestion()">
                –î–∞–ª–µ–µ <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <!-- Font Awesome -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDQXNLAsqmSlAjplpdl2anPSyiDxbz3CjY",
            authDomain: "qhse-training.firebaseapp.com",
            projectId: "qhse-training",
            storageBucket: "qhse-training.appspot.com",
            messagingSenderId: "4501351718",
            appId: "1:4501351718:web:503b00c9ac052b58e2e5e7"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Test data - –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
        const correctAnswers = {
            1: 'b', 2: 'c', 3: 'a', 4: 'd', 5: 'b',
            6: 'c', 7: 'a', 8: 'b', 9: 'd', 10: 'a'
        };

        // Test questions
        const testQuestions = [
            {
                id: 1,
                question: "–ß—Ç–æ —Ç–∞–∫–æ–µ —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ö—Ä–∞–Ω–æ–π —Ç—Ä—É–¥–∞ (–°–£–û–¢)?",
                options: [
                    { id: 'a', text: "–ù–∞–±–æ—Ä –ø—Ä–∞–≤–∏–ª –ø–æ —Ç–µ—Ö–Ω–∏–∫–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏" },
                    { id: 'b', text: "–°–æ–≤–æ–∫—É–ø–Ω–æ—Å—Ç—å –≤–∑–∞–∏–º–æ—Å–≤—è–∑–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∏—Å–∫–∞–º–∏ –≤ –æ–±–ª–∞—Å—Ç–∏ –æ—Ö—Ä–∞–Ω—ã —Ç—Ä—É–¥–∞" },
                    { id: 'c', text: "–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –°–ò–ó" },
                    { id: 'd', text: "–°–∏—Å—Ç–µ–º–∞ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –æ—Å–º–æ—Ç—Ä–æ–≤" }
                ]
            },
            {
                id: 2,
                question: "–ö–∞–∫–æ–π –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –°–£–û–¢?",
                options: [
                    { id: 'a', text: "ISO 9001" },
                    { id: 'b', text: "ISO 14001" },
                    { id: 'c', text: "ISO 45001" },
                    { id: 'd', text: "ISO 50001" }
                ]
            },
            {
                id: 3,
                question: "–ö—Ç–æ –Ω–µ—Å–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –Ω–∞ —Ä–∞–±–æ—á–µ–º –º–µ—Å—Ç–µ?",
                options: [
                    { id: 'a', text: "–í—Å–µ —Ä–∞–±–æ—Ç–Ω–∏–∫–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏" },
                    { id: 'b', text: "–¢–æ–ª—å–∫–æ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å" },
                    { id: 'c', text: "–¢–æ–ª—å–∫–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –æ—Ö—Ä–∞–Ω–µ —Ç—Ä—É–¥–∞" },
                    { id: 'd', text: "–¢–æ–ª—å–∫–æ —Ä–∞–±–æ—Ç–Ω–∏–∫–∏ –æ–ø–∞—Å–Ω—ã—Ö –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤" }
                ]
            },
            {
                id: 4,
                question: "–ß—Ç–æ –≤–∫–ª—é—á–∞–µ—Ç –≤ —Å–µ–±—è –ø–æ–ª–∏—Ç–∏–∫–∞ –≤ –æ–±–ª–∞—Å—Ç–∏ –æ—Ö—Ä–∞–Ω—ã —Ç—Ä—É–¥–∞?",
                options: [
                    { id: 'a', text: "–¢–æ–ª—å–∫–æ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ü–µ–ª–∏" },
                    { id: 'b', text: "–¢–æ–ª—å–∫–æ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏" },
                    { id: 'c', text: "–¢–æ–ª—å–∫–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞" },
                    { id: 'd', text: "–û–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –ø–æ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—é –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π —Ç—Ä—É–¥–∞" }
                ]
            },
            {
                id: 5,
                question: "–ö–∞–∫ —á–∞—Å—Ç–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–æ–¥–∏—Ç—å –æ—Ü–µ–Ω–∫—É —Ä–∏—Å–∫–æ–≤?",
                options: [
                    { id: 'a', text: "–†–∞–∑ –≤ 5 –ª–µ—Ç" },
                    { id: 'b', text: "–†–µ–≥—É–ª—è—Ä–Ω–æ, –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —É—Å–ª–æ–≤–∏–π —Ç—Ä—É–¥–∞" },
                    { id: 'c', text: "–¢–æ–ª—å–∫–æ –ø—Ä–∏ –ø—Ä–∏–µ–º–µ –Ω–∞ —Ä–∞–±–æ—Ç—É" },
                    { id: 'd', text: "–¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –Ω–µ—Å—á–∞—Å—Ç–Ω–æ–≥–æ —Å–ª—É—á–∞—è" }
                ]
            },
            {
                id: 6,
                question: "–ß—Ç–æ —Ç–∞–∫–æ–µ –∏–Ω—Ü–∏–¥–µ–Ω—Ç –≤ —Å–∏—Å—Ç–µ–º–µ –æ—Ö—Ä–∞–Ω—ã —Ç—Ä—É–¥–∞?",
                options: [
                    { id: 'a', text: "–õ—é–±–æ–µ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª" },
                    { id: 'b', text: "–¢–æ–ª—å–∫–æ –Ω–µ—Å—á–∞—Å—Ç–Ω—ã–π —Å–ª—É—á–∞–π" },
                    { id: 'c', text: "–°–æ–±—ã—Ç–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –º–æ–≥–ª–æ –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ —Ç—Ä–∞–≤–º–µ –∏–ª–∏ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—é" },
                    { id: 'd', text: "–¢–æ–ª—å–∫–æ –∞–≤–∞—Ä–∏—è –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ" }
                ]
            },
            {
                id: 7,
                question: "–ö–∞–∫–æ–≤ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ö–æ–¥–Ω–æ–π –±–∞–ª–ª –ø–æ —Ç–µ—Å—Ç—É?",
                options: [
                    { id: 'a', text: "100%" },
                    { id: 'b', text: "80%" },
                    { id: 'c', text: "70%" },
                    { id: 'd', text: "60%" }
                ]
            },
            {
                id: 8,
                question: "–ß—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç –∞–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä–∞ –°–ò–ó?",
                options: [
                    { id: 'a', text: "–°–∏—Å—Ç–µ–º–∞ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–π –∑–∞—â–∏—Ç—ã" },
                    { id: 'b', text: "–°—Ä–µ–¥—Å—Ç–≤–∞ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–π –∑–∞—â–∏—Ç—ã" },
                    { id: 'c', text: "–°—Ç–∞–Ω–¥–∞—Ä—Ç—ã –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–π –∑–∞—â–∏—Ç—ã" },
                    { id: 'd', text: "–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–π –∑–∞—â–∏—Ç—ã" }
                ]
            },
            {
                id: 9,
                question: "–ö–∞–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç —è–≤–ª—è–µ—Ç—Å—è –æ—Å–Ω–æ–≤–Ω—ã–º –ø–æ –æ—Ö—Ä–∞–Ω–µ —Ç—Ä—É–¥–∞ –≤ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏?",
                options: [
                    { id: 'a', text: "–¢—Ä—É–¥–æ–≤–æ–π –¥–æ–≥–æ–≤–æ—Ä" },
                    { id: 'b', text: "–®—Ç–∞—Ç–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ" },
                    { id: 'c', text: "–ü—Ä–∞–≤–∏–ª–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Ç—Ä—É–¥–æ–≤–æ–≥–æ —Ä–∞—Å–ø–æ—Ä—è–¥–∫–∞" },
                    { id: 'd', text: "–ü–æ–ª–æ–∂–µ–Ω–∏–µ –æ —Å–∏—Å—Ç–µ–º–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ö—Ä–∞–Ω–æ–π —Ç—Ä—É–¥–∞" }
                ]
            },
            {
                id: 10,
                question: "–î–ª—è —á–µ–≥–æ –ø—Ä–æ–≤–æ–¥–∏—Ç—Å—è –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂ –ø–æ –æ—Ö—Ä–∞–Ω–µ —Ç—Ä—É–¥–∞?",
                options: [
                    { id: 'a', text: "–î–ª—è –æ–∑–Ω–∞–∫–æ–º–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤ —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏" },
                    { id: 'b', text: "–î–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç–µ–π" },
                    { id: 'c', text: "–¢–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤" },
                    { id: 'd', text: "–¢–æ–ª—å–∫–æ –¥–ª—è –æ–ø–∞—Å–Ω—ã—Ö —Ä–∞–±–æ—Ç" }
                ]
            }
        ];

        // Global variables
        let currentUser = null;
        let courseId = null;
        let userAnswers = {};
        let currentQuestionIndex = 0;
        let timeLeft = 60 * 60; // 60 minutes in seconds
        let timerInterval = null;
        let testCompleted = false;

        // Initialize test
        async function initTest() {
            try {
                // Check authentication
                currentUser = await new Promise((resolve, reject) => {
                    const unsubscribe = auth.onAuthStateChanged(user => {
                        unsubscribe();
                        if (user) {
                            resolve(user);
                        } else {
                            reject(new Error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω'));
                        }
                    });
                });

                // Get course ID from URL
                const urlParams = new URLSearchParams(window.location.search);
                courseId = urlParams.get('id');
                
                if (!courseId) {
                    showError('ID –∫—É—Ä—Å–∞ –Ω–µ —É–∫–∞–∑–∞–Ω');
                    return;
                }

                // Load user progress to check if slides were viewed
                await loadUserProgress();

                // Start test
                startTest();

                // Start timer
                startTimer();

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                showError('–î–ª—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ç–µ—Å—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É');
            }
        }

        // Load user progress
        async function loadUserProgress() {
            try {
                const progressDoc = await db.collection('user_progress').doc(currentUser.uid).get();
                if (progressDoc.exists) {
                    const allProgress = progressDoc.data();
                    const courseProgress = allProgress[courseId] || {};
                    
                    // Check if user has viewed all slides
                    if (!courseProgress.slidesViewed || courseProgress.slidesViewed < 100) {
                        showError('–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–µ—Å—Ç—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∫—É—Ä—Å–∞');
                        return false;
                    }
                    
                    return true;
                } else {
                    showError('–ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –∫—É—Ä—Å—É –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–π–¥–∏—Ç–µ –∫—É—Ä—Å —Å–Ω–∞—á–∞–ª–∞.');
                    return false;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', error);
                // Allow test even if progress cannot be loaded
                return true;
            }
        }

        // Start test
        function startTest() {
            document.getElementById('totalQuestions').textContent = testQuestions.length;
            document.getElementById('totalQuestionsNum').textContent = testQuestions.length;
            
            displayQuestion();
            document.getElementById('navigation').style.display = 'flex';
            updateProgressBar();
        }

        // Display current question
        function displayQuestion() {
            const question = testQuestions[currentQuestionIndex];
            const testContent = document.getElementById('testContent');
            
            let optionsHTML = '';
            question.options.forEach(option => {
                const isSelected = userAnswers[question.id] === option.id;
                optionsHTML += `
                    <div class="option ${isSelected ? 'selected' : ''}" 
                         onclick="selectAnswer(${question.id}, '${option.id}')">
                        <div class="option-label">${option.id.toUpperCase()}</div>
                        <div class="option-text">${option.text}</div>
                    </div>
                `;
            });
            
            testContent.innerHTML = `
                <div class="question-container">
                    <div class="question active">
                        <div class="question-number">
                            <span>–í–æ–ø—Ä–æ—Å ${question.id}</span>
                        </div>
                        <div class="question-text">${question.question}</div>
                        <div class="options">
                            ${optionsHTML}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('currentQuestionNum').textContent = currentQuestionIndex + 1;
            
            // Update navigation buttons
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            document.getElementById('nextBtn').innerHTML = 
                currentQuestionIndex === testQuestions.length - 1 
                    ? '–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç <i class="fas fa-check"></i>' 
                    : '–î–∞–ª–µ–µ <i class="fas fa-arrow-right"></i>';
        }

        // Select answer
        function selectAnswer(questionId, answerId) {
            userAnswers[questionId] = answerId;
            displayQuestion();
            updateProgressBar();
        }

        // Next question
        function nextQuestion() {
            if (currentQuestionIndex < testQuestions.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            } else {
                submitTest();
            }
        }

        // Previous question
        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion();
            }
        }

        // Update progress bar
        function updateProgressBar() {
            const answeredCount = Object.keys(userAnswers).length;
            const progress = (answeredCount / testQuestions.length) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
        }

        // Start timer
        function startTimer() {
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    submitTest();
                }
            }, 1000);
        }

        // Update timer display
        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('timer').textContent = 
                `‚è∞ ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Submit test
        async function submitTest() {
            if (testCompleted) return;
            testCompleted = true;
            
            clearInterval(timerInterval);
            
            // Calculate results
            const totalQuestions = testQuestions.length;
            let correctCount = 0;
            
            testQuestions.forEach(question => {
                if (userAnswers[question.id] === correctAnswers[question.id]) {
                    correctCount++;
                }
            });
            
            const score = Math.round((correctCount / totalQuestions) * 100);
            const passed = score >= 100; // 100% required
            
            // Save results to Firestore
            await saveTestResults(score, passed);
            
            // Update progress if passed
            if (passed) {
                await updateUserProgress(score);
            }
            
            // Display results
            displayResults(score, passed, correctCount, totalQuestions);
        }

        // Save test results to Firestore
        async function saveTestResults(score, passed) {
            try {
                const resultData = {
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    courseId: courseId,
                    score: score,
                    passed: passed,
                    answers: userAnswers,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    completedAt: new Date().toISOString()
                };
                
                await db.collection('test_results').add(resultData);
                console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:', error);
                // Continue even if save fails
            }
        }

        // Update user progress
        async function updateUserProgress(score) {
            try {
                const progressDocRef = db.collection('user_progress').doc(currentUser.uid);
                
                const progressData = {
                    [courseId]: {
                        testPassed: true,
                        testScore: score,
                        testCompletedAt: new Date().toISOString(),
                        lastActivity: firebase.firestore.FieldValue.serverTimestamp()
                    }
                };
                
                await progressDocRef.set(progressData, { merge: true });
                console.log('–ü—Ä–æ–≥—Ä–µ—Å—Å –æ–±–Ω–æ–≤–ª–µ–Ω');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', error);
                // Continue even if update fails
            }
        }

        // Display results
        function displayResults(score, passed, correctCount, totalQuestions) {
            const testContent = document.getElementById('testContent');
            const navigation = document.getElementById('navigation');
            
            navigation.style.display = 'none';
            
            let resultHTML = `
                <div class="results-container">
                    <div class="score-circle ${passed ? 'score-passed' : 'score-failed'}">
                        ${score}%
                    </div>
                    <h2>${passed ? 'üéâ –¢–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–π–¥–µ–Ω!' : '‚ùå –¢–µ—Å—Ç –Ω–µ –ø—Ä–æ–π–¥–µ–Ω'}</h2>
                    <p>${passed ? '–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—à–ª–∏ —Ç–µ—Å—Ç.' : '–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤—ã –Ω–µ –Ω–∞–±—Ä–∞–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–ª–ª–æ–≤.'}</p>
                    
                    <div class="results-details">
                        <div class="result-item">
                            <span>–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤:</span>
                            <span><strong>${correctCount} –∏–∑ ${totalQuestions}</strong></span>
                        </div>
                        <div class="result-item">
                            <span>–ü—Ä–æ—Ü–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:</span>
                            <span><strong>${score}%</strong></span>
                        </div>
                        <div class="result-item">
                            <span>–¢—Ä–µ–±—É–µ–º—ã–π –º–∏–Ω–∏–º—É–º:</span>
                            <span><strong>100%</strong></span>
                        </div>
                        <div class="result-item">
                            <span>–°—Ç–∞—Ç—É—Å:</span>
                            <span><strong>${passed ? '–ü–†–û–ô–î–ï–ù' : '–ù–ï –ü–†–û–ô–î–ï–ù'}</strong></span>
                        </div>
                    </div>
            `;
            
            if (passed) {
                resultHTML += `
                    <button class="certificate-btn" onclick="generateCertificate(${score})">
                        <i class="fas fa-award"></i> –ü–æ–ª—É—á–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
                    </button>
                    <p style="color: #666; margin-top: 20px;">
                        –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º
                    </p>
                `;
            } else {
                resultHTML += `
                    <button class="certificate-btn" onclick="retryTest()" style="background: var(--warning);">
                        <i class="fas fa-redo"></i> –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                    </button>
                    <p style="color: #666; margin-top: 20px;">
                        –î–ª—è —É—Å–ø–µ—à–Ω–æ–π —Å–¥–∞—á–∏ —Ç–µ—Å—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ—Ç–≤–µ—Ç–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã
                    </p>
                `;
            }
            
            resultHTML += `
                    <div style="margin-top: 30px;">
                        <button onclick="window.location.href='https://qhse-training.github.io/hse-course/courses.html'" 
                                style="padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer;">
                            <i class="fas fa-arrow-left"></i> –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫—É—Ä—Å–∞–º
                        </button>
                    </div>
                </div>
            `;
            
            testContent.innerHTML = resultHTML;
        }

        // Generate certificate
        async function generateCertificate(score) {
            try {
                // Generate unique certificate ID
                const certificateId = 'CERT-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9).toUpperCase();
                
                // Get user data
                const userDoc = await db.collection('approved_users').doc(currentUser.uid).get();
                const userData = userDoc.exists ? userDoc.data() : {};
                const userName = userData.fullName || currentUser.email.split('@')[0];
                
                // Get course data
                const courseDoc = await db.collection('courses').doc(courseId).get();
                const courseData = courseDoc.exists ? courseDoc.data() : {};
                const courseName = courseData.title || '–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ –æ—Ö—Ä–∞–Ω–µ —Ç—Ä—É–¥–∞ (–°–£–û–¢)';
                
                // Update progress with certificate
                await db.collection('user_progress').doc(currentUser.uid).set({
                    [courseId]: {
                        certificateGenerated: true,
                        certificateId: certificateId,
                        certificateDate: new Date().toISOString(),
                        certificateScore: score
                    }
                }, { merge: true });
                
                // Show certificate
                showCertificate(certificateId, userName, courseName, score);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
            }
        }

        // Show certificate
        function showCertificate(certificateId, userName, courseName, score) {
            const certificateWindow = window.open('', '_blank', 'width=1000,height=800');
            const currentDate = new Date().toLocaleDateString('ru-RU');
            
            certificateWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç - ${courseName}</title>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto:wght@300;400;500&display=swap');
                        
                        body { 
                            font-family: 'Roboto', sans-serif; 
                            padding: 40px; 
                            text-align: center; 
                            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                            min-height: 100vh;
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            margin: 0;
                        }
                        
                        .certificate-container {
                            background: white;
                            border-radius: 15px;
                            padding: 50px;
                            width: 900px;
                            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
                            border: 10px solid #2c3e50;
                            position: relative;
                            overflow: hidden;
                        }
                        
                        .certificate-header {
                            margin-bottom: 40px;
                            padding-bottom: 20px;
                            border-bottom: 3px solid #3498db;
                        }
                        
                        .certificate-title {
                            font-family: 'Playfair Display', serif;
                            font-size: 48px;
                            font-weight: 700;
                            color: #2c3e50;
                            margin: 0;
                            letter-spacing: 3px;
                            text-transform: uppercase;
                        }
                        
                        .certificate-subtitle {
                            font-size: 20px;
                            color: #7f8c8d;
                            margin-top: 15px;
                            font-weight: 300;
                        }
                        
                        .certificate-content {
                            margin: 40px 0;
                            padding: 30px;
                            background: #f8f9fa;
                            border-radius: 10px;
                            border-left: 5px solid #3498db;
                        }
                        
                        .certificate-name {
                            font-family: 'Playfair Display', serif;
                            font-size: 36px;
                            color: #e74c3c;
                            margin: 25px 0;
                            font-weight: 700;
                        }
                        
                        .certificate-course {
                            font-size: 28px;
                            color: #2c3e50;
                            margin: 30px 0;
                            font-weight: 500;
                            line-height: 1.4;
                        }
                        
                        .certificate-details {
                            display: flex;
                            justify-content: space-between;
                            margin-top: 50px;
                            padding-top: 30px;
                            border-top: 2px solid #eee;
                        }
                        
                        .detail-item {
                            text-align: center;
                            flex: 1;
                        }
                        
                        .detail-label {
                            font-size: 16px;
                            color: #7f8c8d;
                            margin-bottom: 8px;
                            text-transform: uppercase;
                            letter-spacing: 1px;
                        }
                        
                        .detail-value {
                            font-size: 20px;
                            color: #2c3e50;
                            font-weight: 500;
                        }
                        
                        .certificate-footer {
                            margin-top: 60px;
                            padding-top: 30px;
                            border-top: 2px solid #3498db;
                            display: flex;
                            justify-content: space-between;
                            align-items: flex-end;
                        }
                        
                        .signature {
                            text-align: center;
                        }
                        
                        .signature-line {
                            width: 200px;
                            height: 1px;
                            background: #2c3e50;
                            margin: 20px auto;
                        }
                        
                        .issued-by {
                            font-size: 18px;
                            color: #2c3e50;
                            font-weight: 500;
                            margin-top: 10px;
                        }
                        
                        .certificate-id {
                            background: #2c3e50;
                            color: white;
                            padding: 10px 20px;
                            border-radius: 5px;
                            font-family: monospace;
                            font-size: 14px;
                            letter-spacing: 1px;
                            display: inline-block;
                            margin-top: 20px;
                        }
                        
                        .watermark {
                            position: absolute;
                            opacity: 0.03;
                            font-size: 200px;
                            transform: rotate(-45deg);
                            top: 30%;
                            left: 10%;
                            white-space: nowrap;
                            color: #2c3e50;
                            font-family: 'Playfair Display', serif;
                            font-weight: 700;
                            z-index: 0;
                        }
                        
                        .seal {
                            position: absolute;
                            top: 50px;
                            right: 50px;
                            width: 120px;
                            height: 120px;
                            border: 3px solid #e74c3c;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-family: 'Playfair Display', serif;
                            font-size: 14px;
                            font-weight: 700;
                            color: #e74c3c;
                            text-align: center;
                            padding: 10px;
                            background: rgba(255,255,255,0.9);
                            transform: rotate(15deg);
                        }
                    </style>
                </head>
                <body>
                    <div class="certificate-container">
                        <div class="watermark">–°–ï–†–¢–ò–§–ò–ö–ê–¢</div>
                        <div class="seal">
                            QHSE<br>SOLUTIONS
                        </div>
                        
                        <div class="certificate-header">
                            <h1 class="certificate-title">–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç</h1>
                            <p class="certificate-subtitle">–ù–∞—Å—Ç–æ—è—â–∏–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è, —á—Ç–æ</p>
                        </div>
                        
                        <div class="certificate-content">
                            <div class="certificate-name">${userName}</div>
                            <p style="font-size: 20px; margin: 20px 0;">—É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—à—ë–ª(–∞) –∫—É—Ä—Å –æ–±—É—á–µ–Ω–∏—è –ø–æ –ø—Ä–æ–≥—Ä–∞–º–º–µ</p>
                            <div class="certificate-course">"${courseName}"</div>
                            <p style="font-size: 16px; color: #7f8c8d; margin-top: 20px;">
                                –†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: <strong>${score}%</strong>
                            </p>
                        </div>
                        
                        <div class="certificate-details">
                            <div class="detail-item">
                                <div class="detail-label">–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏</div>
                                <div class="detail-value">${currentDate}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">ID —Å–µ—Ä