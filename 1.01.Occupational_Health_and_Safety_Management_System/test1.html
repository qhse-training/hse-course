<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Тест по охране труда (OHSMS)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      padding: 20px; 
      background-color: #f9f9f9; 
      max-width: 800px;
      margin: 0 auto;
    }
    h1 { 
      text-align: center; 
      color: #2c3e50; 
      margin-bottom: 30px;
    }
    .question { 
      background: #fff; 
      padding: 20px; 
      margin-bottom: 15px; 
      border-radius: 8px; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
    }
    .question p { 
      margin: 0 0 15px; 
      font-weight: bold;
      font-size: 18px;
    }
    .question label { 
      display: block; 
      margin-bottom: 10px; 
      padding: 8px;
      border-radius: 4px;
      transition: background 0.2s;
    }
    .question label:hover {
      background: #f0f8ff;
    }
    #submitBtn { 
      background: #27ae60; 
      color: white; 
      padding: 12px 25px; 
      border: none; 
      border-radius: 5px; 
      cursor: pointer; 
      font-size: 18px; 
      display: block; 
      margin: 30px auto; 
      transition: background 0.3s;
    }
    #submitBtn:hover {
      background: #219955;
    }
    #result { 
      text-align: center; 
      font-size: 20px; 
      margin: 30px 0;
      padding: 20px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    #timer { 
      position: fixed; 
      top: 10px; 
      right: 10px; 
      background: #2c3e50; 
      color: white; 
      padding: 10px 15px; 
      border-radius: 5px; 
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .correct-answer { 
      color: #27ae60; 
      font-weight: bold; 
      margin-top: 15px;
      padding: 10px;
      background: #e8f5e9;
      border-radius: 5px;
      display: none;
    }
    .time-up { 
      color: #e74c3c; 
      font-weight: bold; 
      text-align: center;
      font-size: 20px;
      margin: 20px 0;
    }
    .score-perfect {
      color: #27ae60;
      font-weight: bold;
    }
    .score-low {
      color: #e74c3c;
    }
    .review-section {
      margin-top: 30px;
      text-align: left;
    }
    .review-item {
      background: #fff;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .user-answer-wrong {
      color: #e74c3c;
      font-weight: bold;
    }
    .correct-answer-review {
      color: #27ae60;
      font-weight: bold;
    }
    .explanation {
      font-style: italic;
      margin-top: 10px;
    }
    .progress-container {
      width: 100%;
      background: #ecf0f1;
      border-radius: 5px;
      margin: 20px 0;
    }
    .progress-bar {
      height: 10px;
      background: #27ae60;
      border-radius: 5px;
      width: 0%;
      transition: width 0.5s;
    }
  </style>
</head>
<body>
  <div id="timer">Осталось времени: 15:00</div>
  <h1>Тест по системе управления охраной труда (OHSMS)</h1>
  <div id="timeUpMessage" class="time-up" style="display: none;">Время вышло! Тест отправлен автоматически.</div>
  
  <div class="progress-container">
    <div id="progressBar" class="progress-bar"></div>
  </div>
  
  <form id="testForm">
    <!-- Вопросы будут вставлены здесь -->
  </form>
  
  <button id="submitBtn">Отправить тест</button>
  
  <div id="result"></div>
  <div id="reviewSection" class="review-section" style="display: none;"></div>

  <script>
    // Конфигурация теста
    const testConfig = {
      userName: "Иванов Иван",
      courseName: "Система управления охраной труда",
      testDuration: 15 * 60, // 15 минут в секундах
      passingScore: 100, // Требуется 100% для прохождения
      certificateRequirement: 100, // Сертификат только при 100%
      questions: [
        { 
          q: "1. Какова основная цель OHSMS?", 
          a: ["Увеличение прибыли", "Сокращение рабочего времени", "Обеспечение безопасности на рабочем месте", "Снижение затрат"], 
          correct: 2, 
          explanation: "Правильный ответ: Основная цель OHSMS - обеспечение безопасности на рабочем месте." 
        },
        { 
          q: "2. Какой стандарт обычно используется для OHSMS?", 
          a: ["ISO 9001", "ISO 14001", "ISO 45001", "ISO 27001"], 
          correct: 2, 
          explanation: "Правильный ответ: ISO 45001 - международный стандарт для систем управления охраной труда." 
        },
        { 
          q: "3. Какой первый шаг при внедрении OHSMS?", 
          a: ["Найм консультанта", "Оценка рисков", "Написание процедур", "Обучение сотрудников"], 
          correct: 1, 
          explanation: "Правильный ответ: Первый шаг - проведение оценки рисков для выявления опасностей." 
        },
        { 
          q: "4. Что означает PDCA в OHSMS?", 
          a: ["Планируй, Делай, Проверяй, Действуй", "Подготавливай, Разрабатывай, Контролируй, Анализируй", "Предотвращай, Обнаруживай, Исправляй, Аудируй"], 
          correct: 0, 
          explanation: "Правильный ответ: PDCA означает Plan, Do, Check, Act - цикл непрерывного улучшения." 
        },
        { 
          q: "5. Кто несет окончательную ответственность за безопасность на рабочем месте?", 
          a: ["Сотрудники", "Специалисты по охране труда", "Руководство", "Государство"], 
          correct: 2, 
          explanation: "Правильный ответ: Руководство несет окончательную ответственность за безопасность." 
        },
        { 
          q: "6. Что такое опасность в терминах OHSMS?", 
          a: ["Происшествие, которое уже случилось", "Потенциальный источник вреда", "Процедура безопасности", "Тип СИЗ"], 
          correct: 1, 
          explanation: "Правильный ответ: Опасность - это потенциальный источник вреда или негативного воздействия на здоровье." 
        },
        { 
          q: "7. Какова цель оценки рисков?", 
          a: ["Назначение вины за аварии", "Выявление и контроль опасностей на рабочем месте", "Сокращение льгот сотрудников", "Увеличение скорости производства"], 
          correct: 1, 
          explanation: "Правильный ответ: Оценка рисков выявляет и контролирует опасности на рабочем месте." 
        },
        { 
          q: "8. Что означает СИЗ?", 
          a: ["Средства индивидуальной защиты", "Система измерения затрат", "Стандартные измерительные знаки"], 
          correct: 0, 
          explanation: "Правильный ответ: СИЗ - средства индивидуальной защиты." 
        },
        { 
          q: "9. Когда следует проводить обучение по технике безопасности?", 
          a: ["Только при приеме на работу", "При приеме и при изменении рисков", "Только после инцидента", "Раз в пять лет"], 
          correct: 1, 
          explanation: "Правильный ответ: Обучение проводится при приеме на работу и при изменении рисков." 
        },
        { 
          q: "10. Что такое инцидент в терминах OHSMS?", 
          a: ["Планируемая проверка", "Незапланированное событие, которое может причинить вред", "Собрание комитета по безопасности"], 
          correct: 1, 
          explanation: "Правильный ответ: Инцидент - незапланированное событие, которое может причинить вред." 
        },
        { 
          q: "11. Какова цель аудита безопасности?", 
          a: ["Поиск нарушителей", "Оценка эффективности систем безопасности", "Сокращение затрат на оборудование"], 
          correct: 1, 
          explanation: "Правильный ответ: Аудит безопасности оценивает эффективность систем безопасности." 
        },
        { 
          q: "12. Что сделать в первую очередь при аварии?", 
          a: ["Назначить виновного", "Обезопасить место и оказать первую помощь", "Продолжить работу"], 
          correct: 1, 
          explanation: "Правильный ответ: Сначала обезопасить место происшествия и оказать первую помощь." 
        },
        { 
          q: "13. Что такое 'опасное происшествие'?", 
          a: ["Инцидент с травмой", "Незапланированное событие без вреда", "Проверка безопасности"], 
          correct: 1, 
          explanation: "Правильный ответ: Опасное происшествие - событие без вреда, но с потенциалом причинения вреда." 
        },
        { 
          q: "14. Почему важно участие работников в OHSMS?", 
          a: ["Работники лучше знают опасности", "Снижает нагрузку на руководство", "Требуется законом", "Все перечисленное"], 
          correct: 3, 
          explanation: "Правильный ответ: Участие работников важно по всем указанным причинам." 
        },
        { 
          q: "15. Что такое иерархия мер контроля?", 
          a: ["Список руководителей", "Система приоритезации мер контроля", "Тип обучения"], 
          correct: 1, 
          explanation: "Правильный ответ: Иерархия мер контроля ранжирует методы контроля опасностей." 
        },
        { 
          q: "16. Какая мера контроля опасностей наиболее эффективна?", 
          a: ["СИЗ", "Устранение", "Предупреждающие знаки"], 
          correct: 1, 
          explanation: "Правильный ответ: Устранение - наиболее эффективный метод контроля опасностей." 
        },
        { 
          q: "17. Что такое культура безопасности?", 
          a: ["Государственное агентство", "Общие ценности в отношении безопасности", "Программа обучения"], 
          correct: 1, 
          explanation: "Правильный ответ: Культура безопасности - общие ценности организации в отношении безопасности." 
        },
        { 
          q: "18. Зачем документировать процедуры безопасности?", 
          a: ["Соответствие закону", "Единые стандарты работы", "Обучение", "Все перечисленное"], 
          correct: 3, 
          explanation: "Правильный ответ: Документирование важно по всем указанным причинам." 
        },
        { 
          q: "19. Что такое непрерывное улучшение в OHSMS?", 
          a: ["Единоразовый аудит", "Постоянный процесс повышения безопасности", "Государственное требование"], 
          correct: 1, 
          explanation: "Правильный ответ: Непрерывное улучшение - постоянный процесс повышения безопасности." 
        },
        { 
          q: "20. Какова роль руководства в OHSMS?", 
          a: ["Обеспечение ресурсами", "Контроль соблюдения правил", "Проведение проверок", "Все перечисленное"], 
          correct: 3, 
          explanation: "Правильный ответ: Руководство выполняет все указанные обязанности в OHSMS." 
        }
      ]
    };

    // Элементы DOM
    const form = document.getElementById('testForm');
    const resultDiv = document.getElementById('result');
    const submitBtn = document.getElementById('submitBtn');
    const timerElement = document.getElementById('timer');
    const timeUpMessage = document.getElementById('timeUpMessage');
    const reviewSection = document.getElementById('reviewSection');
    const progressBar = document.getElementById('progressBar');

    // Состояние теста
    let timeLeft = testConfig.testDuration;
    let timerInterval;
    let userAnswers = {};

    // Инициализация теста
    function initTest() {
      startTimer();
      renderQuestions();
      updateProgressBar();
    }

    // Отображение вопросов
    function renderQuestions() {
      testConfig.questions.forEach((q, index) => {
        const container = document.createElement('div');
        container.className = 'question';
        
        const qText = document.createElement('p');
        qText.textContent = q.q;
        container.appendChild(qText);
        
        q.a.forEach((option, i) => {
          const label = document.createElement('label');
          const input = document.createElement('input');
          input.type = 'radio';
          input.name = `q${index}`;
          input.value = i;
          
          input.addEventListener('change', () => {
            userAnswers[index] = parseInt(input.value);
            updateProgressBar();
          });
          
          label.appendChild(input);
          label.appendChild(document.createTextNode(` ${option}`));
          container.appendChild(label);
        });
        
        const correctAnswer = document.createElement('div');
        correctAnswer.className = 'correct-answer';
        correctAnswer.id = `correct-answer-${index}`;
        correctAnswer.innerHTML = `<strong>Объяснение:</strong> ${q.explanation}`;
        container.appendChild(correctAnswer);
        
        form.appendChild(container);
      });
    }

    // Таймер
    function startTimer() {
      updateTimerDisplay();
      timerInterval = setInterval(() => {
        timeLeft--;
        updateTimerDisplay();
        
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          submitTest();
          timeUpMessage.style.display = 'block';
        }
      }, 1000);
    }

    function updateTimerDisplay() {
      const minutes = Math.floor(timeLeft / 60);
      const seconds = timeLeft % 60;
      timerElement.textContent = `Осталось времени: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
      
      if (timeLeft <= 60) {
        timerElement.style.backgroundColor = '#e74c3c';
      }
    }

    function updateProgressBar() {
      const answered = Object.keys(userAnswers).length;
      const progress = (answered / testConfig.questions.length) * 100;
      progressBar.style.width = `${progress}%`;
    }

    // Отправка теста
    function submitTest() {
      clearInterval(timerInterval);
      
      let score = 0;
      const results = [];
      
      testConfig.questions.forEach((q, i) => {
        const selected = document.querySelector(`input[name=q${i}]:checked`);
        const isCorrect = selected && parseInt(selected.value) === q.correct;
        
        if (isCorrect) {
          score++;
        }
        
        results.push({
          question: q.q,
          userAnswer: selected ? parseInt(selected.value) : null,
          isCorrect: isCorrect,
          correctAnswer: q.correct,
          explanation: q.explanation
        });
      });

      const percent = Math.round((score / testConfig.questions.length) * 100);
      displayResults(percent, results);
      displayReviewSection(results);
      
      const inputs = form.querySelectorAll('input');
      inputs.forEach(input => input.disabled = true);
      submitBtn.disabled = true;
    }

    // Отображение результатов
    function displayResults(percent, results) {
      let resultHTML = `Вы набрали <strong>${score}</strong> из <strong>${testConfig.questions.length}</strong> (${percent}%)`;
      
      if (percent >= testConfig.certificateRequirement) {
        const today = new Date().toLocaleDateString();
        generateCertificate(testConfig.userName, testConfig.courseName, today);
        resultHTML += `<br><span class="score-perfect">Идеальный результат! Сертификат скачан.</span>`;
      } 
      else {
        resultHTML += `<br><span class="score-low">Вы не прошли тест. Требуется 100% правильных ответов.</span>`;
      }
      
      resultDiv.innerHTML = resultHTML;
      resultDiv.scrollIntoView({ behavior: 'smooth' });
    }

    // Раздел проверки
    function displayReviewSection(results) {
      reviewSection.style.display = 'block';
      reviewSection.innerHTML = '<h2>Проверьте свои ответы</h2>';
      
      let hasWrongAnswers = false;
      
      results.forEach((result, index) => {
        if (!result.isCorrect || result.userAnswer === null) {
          hasWrongAnswers = true;
          
          const reviewItem = document.createElement('div');
          reviewItem.className = 'review-item';
          
          let reviewHTML = `<p><strong>Вопрос ${index + 1}:</strong> ${result.question}</p>`;
          
          if (result.userAnswer !== null) {
            reviewHTML += `<p class="user-answer-wrong">Ваш ответ: ${testConfig.questions[index].a[result.userAnswer]}</p>`;
          } else {
            reviewHTML += `<p class="user-answer-wrong">Вы не ответили на этот вопрос</p>`;
          }
          
          reviewHTML += `
            <p class="correct-answer-review">Правильный ответ: ${testConfig.questions[index].a[result.correctAnswer]}</p>
            <p class="explanation">${result.explanation}</p>
          `;
          
          reviewItem.innerHTML = reviewHTML;
          reviewSection.appendChild(reviewItem);
        }
      });
      
      if (!hasWrongAnswers) {
        reviewSection.innerHTML += '<p>Вы ответили правильно на все вопросы! Отличный результат!</p>';
      }
    }

    // Генерация сертификата
    function generateCertificate(name, course, date) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(22);
      doc.setTextColor(40, 62, 80);
      doc.text("СЕРТИФИКАТ ОБ ОКОНЧАНИИ", 105, 30, null, null, "center");

      doc.setDrawColor(40, 62, 80);
      doc.setLineWidth(1);
      doc.rect(20, 40, 170, 120);

      doc.setFontSize(16);
      doc.setTextColor(0, 0, 0);
      doc.text(`Настоящий сертификат подтверждает, что`, 105, 60, null, null, "center");
      
      doc.setFontSize(24);
      doc.setTextColor(30, 130, 76);
      doc.text(name, 105, 75, null, null, "center");
      
      doc.setFontSize(16);
      doc.setTextColor(0, 0, 0);
      doc.text(`успешно завершил(а) курс`, 105, 90, null, null, "center");
      doc.setFontSize(18);
      doc.text(course, 105, 100, null, null, "center");
      doc.setFontSize(16);
      doc.text(`с результатом 100%`, 105, 110, null, null, "center");
      
      doc.setFontSize(14);
      doc.text(`Дата: ${date}`, 50, 130);
      doc.text("Подпись: QHSE-Solutions.kz", 50, 145);

      doc.save(`${name.replace(' ', '_')}_Сертификат.pdf`);
    }

    // Обработчики событий
    submitBtn.addEventListener('click', submitTest);
    window.addEventListener('DOMContentLoaded', initTest);
  </script>
</body>
</html>