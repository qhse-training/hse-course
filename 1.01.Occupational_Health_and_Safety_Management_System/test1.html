<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Тест — Система управления по охране труда (СУОТ)</title>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- QRCode (создаёт <img> или <canvas>) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- Firebase v8 (UMD, без import/export) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <style>
    body{font-family:Arial,Helvetica,sans-serif;max-width:900px;margin:18px auto;background:#f7f9fb;padding:18px}
    h1{text-align:center;color:#20313a}
    .meta{background:#fff;padding:12px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.04);margin-bottom:12px}
    .timer{float:right;font-weight:bold;color:#c0392b}
    .question{background:#fff;padding:12px;border-radius:8px;margin:12px 0;box-shadow:0 1px 4px rgba(0,0,0,0.04)}
    .question p{margin:0 0 8px;font-weight:600}
    label{display:block;margin:6px 0;padding:6px;border-radius:6px;cursor:pointer}
    label:hover{background:#f0f8ff}
    #submitBtn{display:block;margin:14px auto;padding:12px 22px;background:#27ae60;color:#fff;border:none;border-radius:8px;font-size:16px;cursor:pointer}
    #submitBtn[disabled]{opacity:0.6;cursor:not-allowed}
    #result{margin-top:14px;padding:12px;background:#fff;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.04)}
    .code{font-family:monospace;background:#f4f4f4;padding:4px 8px;border-radius:4px}
  </style>
</head>
<body>
  <h1>Тест — Система управления по охране труда (СУОТ)</h1>

  <div class="meta">
    <span id="courseTitle">Курс: Система управления по охране труда (СУОТ)</span>
    <span class="timer" id="timer">Осталось времени: 10:00</span>
    <div>Пользователь: <strong id="userName">Загрузка...</strong> — <span id="userEmail">—</span></div>
  </div>

  <form id="testForm">
    <div id="questions"></div>
    <button id="submitBtn" type="submit">Отправить тест</button>
  </form>

  <div id="result"></div>

<script>
/* --------- Firebase config (твой) --------- */
var firebaseConfig = {
  apiKey: "AIzaSyDQXNLAsqmSlAjplpdl2anPSyiDxbz3CjY",
  authDomain: "qhse-training.firebaseapp.com",
  projectId: "qhse-training",
  storageBucket: "qhse-training.appspot.com",
  messagingSenderId: "4501351718",
  appId: "1:4501351718:web:503b00c9ac052b58e2e5e7"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* --------- Настройки --------- */
const VERIFY_SITE = "https://qhsesolutions.kz/login";
const TEST_DURATION_SEC = 10 * 60; // 10 минут
const CERT_THRESHOLD = 100; // сертификат только при 100%
const COURSE_NAME = "Система управления по охране труда (СУОТ)";

/* --------- Вопросы (20) --------- */
/* correct — индекс правильного варианта (0..3) */
const questions = [
  { q: "1. Какова основная цель OHSMS?", a: ["Увеличение прибыли","Сокращение рабочего времени","Обеспечение безопасности на рабочем месте","Снижение затрат"], correct:2 },
  { q: "2. Какой стандарт обычно используется для OHSMS?", a: ["ISO 9001","ISO 14001","ISO 45001","ISO 27001"], correct:2 },
  { q: "3. Какой первый шаг при внедрении OHSMS?", a: ["Найм консультанта","Оценка рисков","Написание процедур","Обучение сотрудников"], correct:1 },
  { q: "4. Что означает PDCA в OHSMS?", a: ["Планируй, Делай, Проверяй, Действуй","Подготавливай, Разрабатывай, Контролируй, Анализируй","Предотвращай, Обнаруживай, Исправляй, Аудируй","Проверяй, Делай, Планируй, Анализируй"], correct:0 },
  { q: "5. Кто несет окончательную ответственность за безопасность на рабочем месте?", a: ["Сотрудники","Специалисты по охране труда","Руководство","Государство"], correct:2 },
  { q: "6. Что такое опасность в терминах OHSMS?", a: ["Происшествие, которое уже случилось","Потенциальный источник вреда","Процедура безопасности","Тип СИЗ"], correct:1 },
  { q: "7. Какова цель оценки рисков?", a: ["Назначение вины за аварии","Выявление и контроль опасностей на рабочем месте","Сокращение льгот сотрудников","Увеличение скорости производства"], correct:1 },
  { q: "8. Что означает СИЗ?", a: ["Средства индивидуальной защиты","Система измерения затрат","Стандартные измерительные знаки","Система информационной защиты"], correct:0 },
  { q: "9. Когда следует проводить обучение по технике безопасности?", a: ["Только при приеме на работу","При приеме и при изменении рисков","Только после инцидента","Раз в пять лет"], correct:1 },
  { q: "10. Что такое инцидент в терминах OHSMS?", a: ["Планируемая проверка","Незапланированное событие, которое может причинить вред","Собрание комитета по безопасности","Отчет о производительности"], correct:1 },
  { q: "11. Какова цель аудита безопасности?", a: ["Поиск нарушителей","Оценка эффективности систем безопасности","Сокращение затрат на оборудование","Повышение производительности"], correct:1 },
  { q: "12. Что сделать в первую очередь при аварии?", a: ["Назначить виновного","Обезопасить место и оказать первую помощь","Продолжить работу","Сообщить СМИ"], correct:1 },
  { q: "13. Что такое 'опасное происшествие'?", a: ["Инцидент с травмой","Незапланированное событие без вреда","Проверка безопасности","Оповещение руководства"], correct:1 },
  { q: "14. Почему важно участие работников в OHSMS?", a: ["Работники лучше знают опасности","Снижает нагрузку на руководство","Требуется законом","Все перечисленное"], correct:3 },
  { q: "15. Что такое иерархия мер контроля?", a: ["Список руководителей","Система приоритезации мер контроля","Тип обучения","План реагирования"], correct:1 },
  { q: "16. Какая мера контроля опасностей наиболее эффективна?", a: ["СИЗ","Устранение","Предупреждающие знаки","Обучение"], correct:1 },
  { q: "17. Что такое культура безопасности?", a: ["Государственное агентство","Общие ценности в отношении безопасности","Программа обучения","Документ"], correct:1 },
  { q: "18. Зачем документировать процедуры безопасности?", a: ["Соответствие закону","Единые стандарты работы","Обучение","Все перечисленное"], correct:3 },
  { q: "19. Что такое непрерывное улучшение в OHSMS?", a: ["Единоразовый аудит","Постоянный процесс повышения безопасности","Государственное требование","План обучения"], correct:1 },
  { q: "20. Какова роль руководства в OHSMS?", a: ["Обеспечение ресурсами","Контроль соблюдения правил","Проведение проверок","Все перечисленное"], correct:3 }
];

/* --------- Render questions --------- */
const questionsContainer = document.getElementById('questions');
function renderQuestions(){
  questionsContainer.innerHTML = '';
  questions.forEach((itm, idx) => {
    const div = document.createElement('div');
    div.className = 'question';
    let html = `<p>${itm.q}</p>`;
    itm.a.forEach((opt, i) => {
      const id = `q${idx}_o${i}`;
      html += `<label for="${id}"><input id="${id}" name="q${idx}" type="radio" value="${i}"> ${opt}</label>`;
    });
    div.innerHTML = html;
    questionsContainer.appendChild(div);
  });
}
renderQuestions();

/* --------- Timer --------- */
let timeLeft = TEST_DURATION_SEC;
const timerEl = document.getElementById('timer');
let timerInterval = setInterval(() => {
  if (timeLeft < 0) return;
  const m = Math.floor(timeLeft/60);
  const s = timeLeft%60;
  timerEl.textContent = `Осталось времени: ${m}:${s < 10 ? '0' : ''}${s}`;
  if (timeLeft === 0) {
    clearInterval(timerInterval);
    // автосабмит формы
    document.getElementById('submitBtn').disabled = true;
    // submit programmatically
    submitTest();
  }
  timeLeft--;
}, 1000);

/* --------- Auth & load user name --------- */
let currentUID = null;
let currentUserEmail = '';
let currentUserName = '';
auth.onAuthStateChanged(async (user) => {
  if (!user) {
    alert('Вы не авторизованы. Пожалуйста, войдите в систему.');
    window.location.href = 'login.html';
    return;
  }
  currentUID = user.uid;
  currentUserEmail = user.email || '';
  // пытаемся получить точное имя из approved_users
  try {
    const doc = await db.collection('approved_users').doc(currentUID).get();
    if (doc.exists) {
      const data = doc.data();
      currentUserName = data.displayName || data.fullName || data.name || (user.displayName || user.email) || 'Без имени';
    } else {
      currentUserName = user.displayName || user.email || 'Без имени';
    }
  } catch (e) {
    console.warn('Ошибка при получении имени из approved_users:', e);
    currentUserName = user.displayName || user.email || 'Без имени';
  }
  document.getElementById('userName').textContent = currentUserName;
  document.getElementById('userEmail').textContent = currentUserEmail;
});

/* --------- Helpers --------- */
function scoreTest() {
  let correct = 0;
  questions.forEach((itm, idx) => {
    const sel = document.querySelector(`input[name="q${idx}"]:checked`);
    if (sel && parseInt(sel.value,10) === itm.correct) correct++;
  });
  const total = questions.length;
  const percent = Math.round((correct/total)*100);
  return { correct, total, percent };
}

function makeUniqueCode() {
  if (window.crypto && window.crypto.randomUUID) {
    return crypto.randomUUID().replace(/-/g,'').slice(0,28);
  }
  // fallback
  return ('C' + Date.now().toString(36) + Math.random().toString(36).slice(2,10)).toUpperCase();
}

/* --------- Submit handling --------- */
document.getElementById('testForm').addEventListener('submit', function(e){
  e.preventDefault();
  submitTest();
});

async function submitTest(){
  // disable submit button to avoid double send
  document.getElementById('submitBtn').disabled = true;
  clearInterval(timerInterval);

  const { correct, total, percent } = scoreTest();
  const resultDiv = document.getElementById('result');

  if (percent >= CERT_THRESHOLD) {
    // success: create unique code, save in Firestore, generate PDF and download
    const uniqueCode = makeUniqueCode();
    const issueDateISO = new Date().toISOString();
    const issueDateHuman = (new Date()).toLocaleDateString();

    const certDoc = {
      uid: currentUID || '',
      email: currentUserEmail || '',
      userName: currentUserName || '',
      courseName: COURSE_NAME,
      uniqueCode,
      issueDate: issueDateISO,
      verified: false
    };

    try {
      const certRef = await db.collection('certificates').add(certDoc);
      const certificateId = certRef.id;

      // generate PDF
      generatePdfAndDownload(currentUserName || 'Без имени', COURSE_NAME, issueDateHuman, uniqueCode, certificateId);

      resultDiv.innerHTML = `<div style="color:green;">Поздравляем! Вы прошли тест на 100%. Сертификат скачан.<br>Код сертификата: <span class="code">${uniqueCode}</span></div>`;
    } catch (err) {
      console.error('Ошибка при сохранении сертификата:', err);
      resultDiv.innerHTML = `<div style="color:red;">Ошибка при создании записи сертификата. Повторите позже.</div>`;
    }

  } else {
    // failed: show score
    resultDiv.innerHTML = `<div style="color:darkred;">Вы набрали ${correct} из ${total} (${percent}%). Для выдачи сертификата требуется 100%.</div>`;
  }

  // disable all inputs after submit
  document.querySelectorAll('input[type=radio]').forEach(i => i.disabled = true);
}

/* --------- PDF generation (jsPDF) --------- */
function generatePdfAndDownload(name, course, dateStr, uniqueCode, certificateId) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt', format:'a4'});
  const w = doc.internal.pageSize.getWidth();

  doc.setFontSize(26);
  doc.setTextColor(30,50,70);
  doc.text("СЕРТИФИКАТ О ЗАВЕРШЕНИИ", w/2, 110, {align:'center'});

  doc.setFontSize(14);
  doc.setTextColor(0,0,0);
  doc.text("Настоящий сертификат подтверждает, что", w/2, 150, {align:'center'});

  doc.setFontSize(22);
  doc.setTextColor(10,90,50);
  doc.text(name, w/2, 190, {align:'center'});

  doc.setFontSize(14);
  doc.setTextColor(0,0,0);
  doc.text("успешно завершил(а) курс", w/2, 220, {align:'center'});

  doc.setFontSize(18);
  doc.text(course, w/2, 250, {align:'center'});

  // date and signature
  doc.setFontSize(12);
  doc.text(`Дата: ${dateStr}`, 80, 520);
  doc.text("Подпись: QHSE-Solutions.kz", 80, 540);

  // verification link & code
  doc.setFontSize(10);
  doc.text(`Проверить подлинность: ${VERIFY_SITE}`, 80, 560);
  doc.text(`Код сертификата: ${uniqueCode}`, 80, 576);
  doc.text(`certificateId: ${certificateId}`, 80, 592);

  // border
  doc.setDrawColor(140);
  doc.setLineWidth(1);
  doc.rect(40,40, w-80, doc.internal.pageSize.getHeight()-80);

  // add QR image (link to site)
  // create temporary QR element
  const tmpDiv = document.createElement('div');
  const qr = new QRCode(tmpDiv, { text: VERIFY_SITE, width: 80, height: 80 });
  // QRCode lib may render <img> or <canvas>
  setTimeout(()=> {
    let img = tmpDiv.querySelector('img');
    if (!img) {
      const canvas = tmpDiv.querySelector('canvas');
      if (canvas) {
        img = new Image();
        img.src = canvas.toDataURL('image/png');
      }
    }
    if (img && img.src) {
      doc.addImage(img.src, 'PNG', w/2 + 100, 480, 80, 80);
    }
    // save file
    const filename = `${course.replace(/\s+/g,'_')}_${name.replace(/\s+/g,'_')}_Сертификат.pdf`;
    doc.save(filename);
    // cleanup
    tmpDiv.innerHTML = '';
  }, 150); // небольшая задержка для генерации QR
}

</script>
</body>
</html>
