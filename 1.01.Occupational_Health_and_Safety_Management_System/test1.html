<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Тест — Система управления по охране труда (СУОТ)</title>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Firebase v8 (UMD/compat) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <style>
    body { font-family: Arial, sans-serif; max-width:900px; margin:20px auto; background:#f7f9fb; padding:18px; }
    h1 { text-align:center; color:#20313a; }
    .meta { background:#fff; padding:12px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.04); margin-bottom:12px; }
    .timer { float:right; font-weight:bold; color:#c0392b; }
    .question { background:#fff; padding:12px; border-radius:8px; margin:12px 0; box-shadow:0 1px 4px rgba(0,0,0,0.04); }
    .question p { margin:0 0 8px 0; font-weight:600; }
    label { display:block; margin:6px 0; padding:6px 8px; border-radius:6px; cursor:pointer; }
    label:hover { background:#f0f8ff; }
    #submitBtn { display:block; margin:18px auto; padding:12px 22px; font-size:16px; background:#27ae60; color:#fff; border:none; border-radius:8px; cursor:pointer; }
    #submitBtn[disabled] { opacity:0.6; cursor:not-allowed; }
    #result { margin-top:14px; padding:12px; background:#fff; border-radius:8px; box-shadow:0 1px 4px rgba(0,0,0,0.04); }
    .code { font-family:monospace; background:#f4f4f4; padding:4px 8px; border-radius:4px; }
  </style>
</head>
<body>
  <h1>Тест — Система управления по охране труда (СУОТ)</h1>

  <div class="meta">
    <span id="courseTitle">Курс: Система управления по охране труда (СУОТ)</span>
    <span class="timer" id="timer">Осталось времени: 10:00</span>
    <div>Пользователь: <strong id="userName">Загрузка...</strong> — <span id="userEmail">—</span></div>
  </div>

  <form id="testForm">
    <div id="questions"></div>
    <button id="submitBtn" type="submit">Отправить тест</button>
  </form>

  <div id="result"></div>

<script>
/* ================= CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyDQXNLAsqmSlAjplpdl2anPSyiDxbz3CjY",
  authDomain: "qhse-training.firebaseapp.com",
  projectId: "qhse-training",
  storageBucket: "qhse-training.appspot.com",
  messagingSenderId: "4501351718",
  appId: "1:4501351718:web:503b00c9ac052b58e2e5e7"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const COURSE_ID = "0EFXo6H4N1mbA1jBJwOK";
const VERIFY_SITE = "https://qhsesolutions.kz/login";
const TEST_DURATION = 10 * 60; // seconds
const PASS_THRESHOLD = 95; // percent
const TOTAL_QUESTIONS = 20;

/* ================ QUESTIONS (exact same 20) ================ */
/* each question has options array and correct index (0-based) */
const questions = [
  { q: "1. Какова основная цель OHSMS?", a: ["Увеличение прибыли","Сокращение рабочего времени","Обеспечение безопасности на рабочем месте","Снижение затрат"], correct: 2 },
  { q: "2. Какой стандарт обычно используется для OHSMS?", a: ["ISO 9001","ISO 14001","ISO 45001","ISO 27001"], correct: 2 },
  { q: "3. Какой первый шаг при внедрении OHSMS?", a: ["Найм консультанта","Оценка рисков","Написание процедур","Обучение сотрудников"], correct: 1 },
  { q: "4. Что означает PDCA в OHSMS?", a: ["Планируй, Делай, Проверяй, Действуй","Подготавливай, Разрабатывай, Контролируй, Анализируй","Предотвращай, Обнаруживай, Исправляй, Аудируй","Проверяй, Делай, Планируй, Анализируй"], correct: 0 },
  { q: "5. Кто несет окончательную ответственность за безопасность на рабочем месте?", a: ["Сотрудники","Специалисты по охране труда","Руководство","Государство"], correct: 2 },
  { q: "6. Что такое опасность в терминах OHSMS?", a: ["Происшествие, которое уже случилось","Потенциальный источник вреда","Процедура безопасности","Тип СИЗ"], correct: 1 },
  { q: "7. Какова цель оценки рисков?", a: ["Назначение вины за аварии","Выявление и контроль опасностей на рабочем месте","Сокращение льгот сотрудников","Увеличение скорости производства"], correct: 1 },
  { q: "8. Что означает СИЗ?", a: ["Средства индивидуальной защиты","Система измерения затрат","Стандартные измерительные знаки","Система информационной защиты"], correct: 0 },
  { q: "9. Когда следует проводить обучение по технике безопасности?", a: ["Только при приеме на работу","При приеме и при изменении рисков","Только после инцидента","Раз в пять лет"], correct: 1 },
  { q: "10. Что такое инцидент в терминах OHSMS?", a: ["Планируемая проверка","Незапланированное событие, которое может причинить вред","Собрание комитета по безопасности","Отчет о производительности"], correct: 1 },
  { q: "11. Какова цель аудита безопасности?", a: ["Поиск нарушителей","Оценка эффективности систем безопасности","Сокращение затрат на оборудование","Повышение производительности"], correct: 1 },
  { q: "12. Что сделать в первую очередь при аварии?", a: ["Назначить виновного","Обезопасить место и оказать первую помощь","Продолжить работу","Сообщить СМИ"], correct: 1 },
  { q: "13. Что такое 'опасное происшествие'?", a: ["Инцидент с травмой","Незапланированное событие без вреда","Проверка безопасности","Оповещение руководства"], correct: 1 },
  { q: "14. Почему важно участие работников в OHSMS?", a: ["Работники лучше знают опасности","Снижает нагрузку на руководство","Требуется законом","Все перечисленное"], correct: 3 },
  { q: "15. Что такое иерархия мер контроля?", a: ["Список руководителей","Система приоритезации мер контроля","Тип обучения","План реагирования"], correct: 1 },
  { q: "16. Какая мера контроля опасностей наиболее эффективна?", a: ["СИЗ","Устранение","Предупреждающие знаки","Обучение"], correct: 1 },
  { q: "17. Что такое культура безопасности?", a: ["Государственное агентство","Общие ценности в отношении безопасности","Программа обучения","Документ"], correct: 1 },
  { q: "18. Зачем документировать процедуры безопасности?", a: ["Соответствие закону","Единые стандарты работы","Обучение","Все перечисленное"], correct: 3 },
  { q: "19. Что такое непрерывное улучшение в OHSMS?", a: ["Единоразовый аудит","Постоянный процесс повышения безопасности","Государственное требование","План обучения"], correct: 1 },
  { q: "20. Какова роль руководства в OHSMS?", a: ["Обеспечение ресурсами","Контроль соблюдения правил","Проведение проверок","Все перечисленное"], correct: 3 }
];

/* ============ DOM refs & state ============ */
const questionsContainer = document.getElementById('questions');
const submitBtn = document.getElementById('submitBtn');
const timerEl = document.getElementById('timer');
const resultDiv = document.getElementById('result');
const userNameEl = document.getElementById('userName');
const userEmailEl = document.getElementById('userEmail');

let currentUID = null;
let currentUserName = '';
let currentUserEmail = '';
let timerInterval = null;
let timeLeft = TEST_DURATION;

/* ============ Render questions ============ */
function renderQuestions() {
  questionsContainer.innerHTML = '';
  questions.forEach((item, idx) => {
    const div = document.createElement('div');
    div.className = 'question';
    let html = `<p>${item.q}</p>`;
    item.a.forEach((opt, i) => {
      const id = `q${idx}_o${i}`;
      html += `<label for="${id}"><input id="${id}" name="q${idx}" type="radio" value="${i}"> ${opt}</label>`;
    });
    div.innerHTML = html;
    questionsContainer.appendChild(div);
  });
}
renderQuestions();

/* ============ Timer ============ */
function startTimer() {
  timeLeft = TEST_DURATION;
  timerEl.textContent = formatTime(timeLeft);
  timerInterval = setInterval(() => {
    timeLeft--;
    timerEl.textContent = formatTime(timeLeft);
    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      submitTest(); // auto-submit
    }
  }, 1000);
}
function formatTime(sec) {
  if (sec < 0) sec = 0;
  const m = Math.floor(sec / 60);
  const s = sec % 60;
  return `Осталось времени: ${m}:${s < 10 ? '0' : ''}${s}`;
}
startTimer();

/* ============ Auth & load user ============ */
auth.onAuthStateChanged(async (user) => {
  if (!user) {
    alert('Пожалуйста, войдите в систему.');
    window.location.href = 'login.html';
    return;
  }
  currentUID = user.uid;
  currentUserEmail = user.email || '';
  try {
    const doc = await db.collection('approved_users').doc(currentUID).get();
    if (doc.exists) {
      const data = doc.data();
      currentUserName = data.fullName || data.name || user.displayName || 'Без имени';
    } else {
      currentUserName = user.displayName || user.email || 'Без имени';
    }
  } catch (e) {
    console.warn('Ошибка получения имени:', e);
    currentUserName = user.displayName || user.email || 'Без имени';
  }
  userNameEl.textContent = currentUserName;
  userEmailEl.textContent = currentUserEmail;
});

/* ============ Scoring & submission ============ */
document.getElementById('testForm').addEventListener('submit', (ev) => {
  ev.preventDefault();
  submitTest();
});

async function submitTest() {
  // prevent double submit
  submitBtn.disabled = true;
  if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }

  // calculate score
  let correct = 0;
  questions.forEach((item, idx) => {
    const sel = document.querySelector(`input[name="q${idx}"]:checked`);
    if (sel && parseInt(sel.value, 10) === item.correct) correct++;
  });
  const percent = Math.round((correct / questions.length) * 100);

  // build course_progress doc id
  const cpDocId = `${currentUID}_${COURSE_ID}`;

  if (percent >= PASS_THRESHOLD) {
    // generate certificateId via Firestore doc id
    const certRef = db.collection('certificates').doc(); // creates new id but not yet set
    const certificateId = certRef.id;

    const issueDate = formatDate(new Date()); // DD.MM.YYYY

    // prepare certificate doc
    const certDoc = {
      certificateId,
      uid: currentUID,
      courseId: COURSE_ID,
      issueDate,
      verified: false
    };

    try {
      // write certificate
      await certRef.set(certDoc);

      // update course_progress
      await db.collection('course_progress').doc(cpDocId).set({
        certificateId,
        completed: 100,
        courseId: COURSE_ID,
        lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
        passed: true,
        progress: 100,
        score: correct,
        total: questions.length,
        uid: currentUID
      }, { merge: true });

      // generate PDF certificate and download
      generatePdf(currentUserName, certificateId, issueDate);

      resultDiv.innerHTML = `<div style="color:green;">Поздравляем! Вы прошли тест. Сертификат скачан.<br>Код сертификата: <span class="code">${certificateId}</span></div>`;
    } catch (err) {
      console.error('Ошибка записи сертификата/статуса:', err);
      resultDiv.innerHTML = `<div style="color:red;">Ошибка при сохранении сертификата. Проверьте консоль.</div>`;
    }
  } else {
    // update limited progress (failed)
    try {
      await db.collection('course_progress').doc(cpDocId).set({
        completed: 0,
        courseId: COURSE_ID,
        lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
        passed: false,
        progress: Math.round((correct / questions.length) * 100),
        score: correct,
        total: questions.length,
        uid: currentUID
      }, { merge: true });
    } catch (err) {
      console.warn('Не удалось обновить course_progress:', err);
    }
    resultDiv.innerHTML = `<div style="color:darkred;">Вы набрали ${correct} из ${questions.length} (${percent}%). Для выдачи сертификата требуется ${PASS_THRESHOLD}%.</div>`;
  }

  // disable inputs after submit
  document.querySelectorAll('input[type=radio]').forEach(i => i.disabled = true);
}

/* ============ PDF generation ============ */
function generatePdf(name, certificateId, issueDate) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: 'pt', format: 'a4' });
  const w = doc.internal.pageSize.getWidth();

  doc.setFontSize(26);
  doc.setTextColor(30,50,70);
  doc.text("СЕРТИФИКАТ", w/2, 120, { align: 'center' });

  doc.setFontSize(14);
  doc.setTextColor(0,0,0);
  doc.text("Настоящий сертификат подтверждает, что", w/2, 160, { align: 'center' });

  doc.setFontSize(22);
  doc.setTextColor(10,90,50);
  doc.text(name || 'Без имени', w/2, 200, { align: 'center' });

  doc.setFontSize(14);
  doc.setTextColor(0,0,0);
  doc.text("успешно завершил(а) курс", w/2, 230, { align: 'center' });

  doc.setFontSize(18);
  doc.text("Система управления по охране труда (СУОТ)", w/2, 260, { align: 'center' });

  doc.setFontSize(12);
  doc.text(`Certificate ID: ${certificateId}`, 80, 520);
  doc.text(`Дата выдачи: ${issueDate}`, 80, 536);
  doc.text("Выдал: QHSE-Solutions.kz", 80, 552);

  // border
  doc.setDrawColor(140);
  doc.setLineWidth(1);
  doc.rect(40,40, w-80, doc.internal.pageSize.getHeight()-80);

  const filename = `Сертификат_${certificateId}.pdf`;
  doc.save(filename);
}

/* ============ Helpers ============ */
function formatDate(d) {
  const day = String(d.getDate()).padStart(2,'0');
  const mon = String(d.getMonth()+1).padStart(2,'0');
  const yr = d.getFullYear();
  return `${day}.${mon}.${yr}`;
}
</script>
</body>
</html>
