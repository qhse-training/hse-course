<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Тест — Знаки безопасности на производстве</title>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Roboto для поддержки кириллицы в PDF -->
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<style>
:root {
  --primary: #2c3e50;
  --primary-light: #3498db;
  --success: #27ae60;
  --danger: #e74c3c;
  --warning: #f39c12;
  --light-bg: #f7f9fb;
  --white: #ffffff;
  --text: #333333;
  --border: #e0e0e0;
  --shadow: 0 2px 10px rgba(0,0,0,0.08);
}

body {
  font-family: 'Roboto', sans-serif;
  background: var(--light-bg);
  margin: 0;
  padding: 20px;
  color: var(--text);
  line-height: 1.6;
}

.container {
  max-width: 900px;
  margin: auto;
  background: var(--white);
  padding: 20px;
  border-radius: 10px;
  box-shadow: var(--shadow);
}

h1 {
  text-align: center;
  color: var(--primary);
  margin-bottom: 10px;
}

.meta-container {
  background: var(--white);
  padding: 15px;
  border-radius: 10px;
  box-shadow: var(--shadow);
  margin-bottom: 20px;
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  gap: 10px;
}

.meta-item {
  display: flex;
  align-items: center;
  gap: 8px;
}

.question {
  padding: 20px;
  background: var(--white);
  margin-bottom: 15px;
  border-radius: 8px;
  border: 1px solid var(--border);
  box-shadow: var(--shadow);
  transition: transform 0.2s;
}
.question:hover { transform: translateY(-2px); }

.question-text {
  font-weight: 600;
  margin-bottom: 15px;
  font-size: 1.1rem;
}

.option-label {
  display: flex;
  align-items: center;
  margin: 10px 0;
  padding: 12px 15px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
  border: 1px solid var(--border);
}
.option-label:hover {
  background: #f0f8ff;
  border-color: var(--primary-light);
}
.option-label input {
  margin-right: 12px;
  cursor: pointer;
}

button {
  background: var(--success);
  color: white;
  border: none;
  padding: 12px 20px;
  border-radius: 5px;
  cursor: pointer;
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}
button:hover {
  background: #219653;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
button:disabled {
  background: #95a5a6;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.status {
  margin: 15px 0;
  padding: 15px;
  border-radius: 8px;
  text-align: center;
}
.success { background: #e8f5e9; border: 1px solid #c8e6c9; color: var(--success); }
.fail { background: #ffebee; border: 1px solid #ffcdd2; color: var(--danger); }

.warning-message {
  color: var(--warning);
  background: #fff8e6;
  padding: 10px;
  border-radius: 6px;
  margin: 15px 0;
  text-align: center;
}

.result-container {
  margin-top: 30px;
  padding: 20px;
  background: var(--white);
  border-radius: 10px;
  box-shadow: var(--shadow);
  text-align: center;
}
.success-result { color: var(--success); font-weight: 600; }
.fail-result { color: var(--danger); }

.certificate-code {
  font-family: monospace;
  background: #f4f4f4;
  padding: 8px 12px;
  border-radius: 4px;
  margin: 10px 0;
  display: inline-block;
  font-size: 1.1rem;
}

.action-buttons {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin-top: 20px;
}
.action-btn {
  padding: 10px 20px;
  border-radius: 6px;
  text-decoration: none;
  font-weight: 500;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}
.action-btn i { font-size: 0.9em; }
.btn-primary { background: var(--primary-light); color: white; }
.btn-primary:hover { background: #2980b9; }
.btn-secondary { background: var(--white); color: var(--primary); border: 1px solid var(--primary-light); }
.btn-secondary:hover { background: #f0f8ff; }

.progress-container { width: 100%; margin: 10px 0; }
.progress-bar {
  height: 8px;
  background: #ecf0f1;
  border-radius: 4px;
  overflow: hidden;
  margin-top: 5px;
}
.progress-fill {
  height: 100%;
  background: var(--primary-light);
  width: 0%;
  transition: width 0.3s ease;
}

@media (max-width: 768px) {
  .container { padding: 15px; }
  .question { padding: 15px; }
  .option-label { padding: 10px; }
  .action-buttons { flex-direction: column; align-items: center; }
  .action-btn { width: 100%; max-width: 260px; justify-content: center; }
}
</style>
</head>
<body>
<div class="container">
  <h1><i class="fas fa-graduation-cap"></i> Тест — Знаки безопасности на производстве</h1>

  <div class="meta-container">
    <div class="meta-item">
      <i class="fas fa-book"></i>
      <span id="courseTitle">Курс: Знаки безопасности</span>
    </div>
    <div class="meta-item">
      <i class="fas fa-user"></i>
      <span id="userName">Загрузка...</span>
    </div>
    <div class="meta-item">
      <i class="fas fa-envelope"></i>
      <span id="userEmail">—</span>
    </div>
  </div>

  <div class="progress-container" style="display: none;" id="progressInfo">
    <div>Прогресс: <span id="progressText">0%</span></div>
    <div class="progress-bar">
      <div class="progress-fill" id="progressBar"></div>
    </div>
  </div>

  <div id="status" class="status">Пройдите тест, чтобы получить сертификат</div>
  <div class="warning-message" id="incompleteWarning" style="display: none;">
    <i class="fas fa-exclamation-triangle"></i> Вы ответили не на все вопросы!
  </div>

  <div id="questions"></div>

  <button id="submitBtn" disabled>
    <i class="fas fa-paper-plane"></i> Отправить ответы
  </button>

  <div class="result-container" id="resultContainer" style="display: none;">
    <div id="resultMessage"></div>
    <div class="action-buttons" id="actionButtons" style="display: none;">
      <a href="#" class="action-btn btn-primary" id="downloadBtn">
        <i class="fas fa-download"></i> Скачать сертификат
      </a>
      <a href="https://qhse-training.github.io/hse-course/dashboard.html" class="action-btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Вернуться к курсам
      </a>
    </div>
  </div>
</div>

<script>
/* =========================
   Firebase Init
   ========================= */
const firebaseConfig = {
  apiKey: "AIzaSyDQXNLAsqmSlAjplpdl2anPSyiDxbz3CjY",
  authDomain: "qhse-training.firebaseapp.com",
  projectId: "qhse-training",
  storageBucket: "qhse-training.appspot.com",
  messagingSenderId: "73177963917",
  appId: "1:73177963917:web:adf0dbb61a8770f32d5c5e"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* =========================
   Constants
   ========================= */
const urlParams = new URLSearchParams(window.location.search);
const COURSE_ID = "знаки_безопасности";
const COURSE_TITLE = "Знаки безопасности на производстве";
const COURSE_TITLE_EN = "Safety Signs in the Workplace";
const PASS_THRESHOLD = 95;

/* =========================
   State
   ========================= */
let certificateData = null;
let currentUser = null;

/* =========================
   DOM
   ========================= */
const userNameEl = document.getElementById('userName');
const userEmailEl = document.getElementById('userEmail');
const courseTitleEl = document.getElementById('courseTitle');
const progressInfo = document.getElementById('progressInfo');
const progressText = document.getElementById('progressText');
const progressBar = document.getElementById('progressBar');
const incompleteWarning = document.getElementById('incompleteWarning');
const downloadBtn = document.getElementById('downloadBtn');
const resultContainer = document.getElementById('resultContainer');
const resultMessage = document.getElementById('resultMessage');
const actionButtons = document.getElementById('actionButtons');
const statusDiv = document.getElementById("status");

/* =========================
   Questions (20)
   ========================= */
const questions = [
  { 
    q: "1. Какой документ подготавливается перед началом работы для контроля оборудования?", 
    a: [
      "Должностная инструкция",
      "График инспекции рабочего места",
      "Бухгалтерский отчёт",
      "Трудовой договор"
    ], 
    correct: 1 
  },
  { 
    q: "2. Что является первым шагом при инспекции оборудования?", 
    a: [
      "Ремонт неисправных инструментов",
      "Визуальный осмотр на наличие повреждений",
      "Учёт стоимости оборудования",
      "Фотографирование инструментов"
    ], 
    correct: 1 
  },
  { 
    q: "3. Как часто проводится инспекция рабочего места согласно модулю 12?", 
    a: [
      "Только после несчастных случаев",
      "Согласно утверждённому графику",
      "Раз в год",
      "По усмотрению сотрудников"
    ], 
    correct: 1 
  },
  { 
    q: "4. Что следует сделать с неисправным оборудованием?", 
    a: [
      "Продолжать работу",
      "Изъять из эксплуатации и пометить",
      "Передать коллеге",
      "Выбросить в мусор"
    ], 
    correct: 1 
  },
  { 
    q: "5. Какие действия входят в инспекцию в ходе работы?", 
    a: [
      "Контроль соблюдения требований безопасности",
      "Подписание контрактов",
      "Перерасчёт зарплат",
      "Организация праздников"
    ], 
    correct: 0 
  },
  { 
    q: "6. Как фиксируются результаты инспекции оборудования?", 
    a: [
      "Устный доклад",
      "Заполнение акта проверки",
      "SMS-сообщение",
      "Личная запись в дневнике"
    ], 
    correct: 1 
  },
  { 
    q: "7. Что проверяется во время аудита рабочего места?", 
    a: [
      "Соответствие требованиям безопасности",
      "Личные сообщения сотрудников",
      "Курсы валют",
      "Погодные условия"
    ], 
    correct: 0 
  },
  { 
    q: "8. Кто должен проводить инспекцию инструментов?", 
    a: [
      "Бухгалтер",
      "Ответственное лицо/комиссия",
      "Случайный прохожий",
      "Директор компании"
    ], 
    correct: 1 
  },
  { 
    q: "9. Что делать при обнаружении нарушений во время проверки?", 
    a: [
      "Игнорировать",
      "Немедленно устранить и задокументировать",
      "Обсудить на собрании через месяц",
      "Уволить сотрудника"
    ], 
    correct: 1 
  },
  { 
    q: "10. Какой инструмент НЕЛЬЗЯ использовать при неисправности?", 
    a: [
      "Треснувший молоток",
      "Новая отвёртка",
      "Заточенный нож",
      "Чистый гаечный ключ"
    ], 
    correct: 0 
  },
  { 
    q: "11. Какова цель графика инспекций?", 
    a: [
      "Украшение офиса",
      "Систематический контроль состояния оборудования",
      "Учёт рабочего времени",
      "Составление меню столовой"
    ], 
    correct: 1 
  },
  { 
    q: "12. Что включает анализ рабочего процесса?", 
    a: [
      "Выявление производственных узких мест",
      "Подсчёт прибыли",
      "Выбор цвета униформы",
      "Планирование корпоративных мероприятий"
    ], 
    correct: 0 
  },
  { 
    q: "13. Какой параметр НЕ важен при инспекции электрооборудования?", 
    a: [
      "Целостность изоляции",
      "Цена покупки",
      "Работоспособность розеток",
      "Наличие заземления"
    ], 
    correct: 1 
  },
  { 
    q: "14. Что делать после завершения аудита?", 
    a: [
      "Выбросить все документы",
      "Составить отчёт и передать руководству",
      "Назначить себе премию",
      "Устроить чаепитие"
    ], 
    correct: 1 
  },
  { 
    q: "15. Что является обязательным для безопасной работы?", 
    a: [
      "Исправное состояние всех инструментов",
      "Наличие кофемашины",
      "Красивая спецодежда",
      "Музыкальная пауза"
    ], 
    correct: 0 
  },
  { 
    q: "16. Кто подписывает акт инспекции?", 
    a: [
      "Ответственное лицо/комиссия",
      "Любой сотрудник",
      "Поставщик оборудования",
      "HR-менеджер"
    ], 
    correct: 0 
  },
  { 
    q: "17. Что является ключевым результатом инспекции?", 
    a: [
      "Обнаружение и устранение нарушений",
      "Создание праздничной атмосферы",
      "Отпуск сотрудников",
      "Установка кондиционеров"
    ], 
    correct: 0 
  },
  { 
    q: "18. Какой инструмент помогает документировать результаты?", 
    a: [
      "Личный дневник",
      "Акт проверки/отчёт",
      "Телефон с камерой",
      "Линейка"
    ], 
    correct: 1 
  },
  { 
    q: "19. Какой принцип соблюдается при инспекции?", 
    a: [
      "Объективность и системность",
      "Случайный подход",
      "Игнорирование нарушений",
      "Персональная симпатия"
    ], 
    correct: 0 
  },
  { 
    q: "20. Что происходит после успешного завершения инспекции?", 
    a: [
      "Составляется отчёт и обновляется статус курса",
      "Отправляется сертификат и фиксируется прогресс",
      "Обе вышеуказанные опции верны",
      "Ничего не делается"
    ], 
    correct: 2 
  }
];

/* =========================
   Render questions
   ========================= */
const qDiv = document.getElementById("questions");
questions.forEach((item, i) => {
  const div = document.createElement("div");
  div.className = "question";
  div.innerHTML = `
    <div class="question-text">${item.q}</div>
    ${item.a.map((ans, idx) => `
      <label class="option-label">
        <input type="radio" name="q${i}" value="${idx}">
        ${ans}
      </label>
    `).join("")}
  `;
  qDiv.appendChild(div);
});

/* =========================
   Progress updates
   ========================= */
document.addEventListener("change", updateProgress);
function updateProgress() {
  const answered = document.querySelectorAll('input[type="radio"]:checked').length;
  const total = questions.length;
  const percent = Math.round((answered / total) * 100);

  progressText.textContent = `${percent}% (${answered}/${total})`;
  progressBar.style.width = `${percent}%`;

  document.getElementById("submitBtn").disabled = answered < total;
  incompleteWarning.style.display = answered < total ? 'block' : 'none';
  if (answered > 0) progressInfo.style.display = 'block';
}

/* =========================
   Helpers
   ========================= */
function formatDate(date) {
  const d = String(date.getDate()).padStart(2, '0');
  const m = String(date.getMonth() + 1).padStart(2, '0');
  const y = date.getFullYear();
  return `${d}.${m}.${y}`;
}
function arrayBufferToBase64(buffer) {
  let binary = '';
  const bytes = new Uint8Array(buffer);
  for (let i = 0; i < bytes.byteLength; i++) {
    binary += String.fromCharCode(bytes[i]);
  }
  return btoa(binary);
}
function generateId(len = 20) {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  let id = "";
  for (let i = 0; i < len; i++) id += chars.charAt(Math.floor(Math.random() * chars.length));
  return id;
}

/* =========================
   Result UI
   ========================= */
function showTestResult(correct, percent, passed, certificateId) {
  if (passed) {
    statusDiv.className = "status success";
    statusDiv.innerHTML = `<i class="fas fa-check-circle"></i> Тест пройден (${percent.toFixed(1)}%) — Сертификат выдан`;
    resultMessage.innerHTML = `
      <div class="success-result"><i class="fas fa-check-circle"></i> Поздравляем! Вы успешно прошли тест.</div>
      <p>Вы ответили правильно на <strong>${correct} из ${questions.length}</strong> вопросов (${percent.toFixed(1)}%).</p>
      <p>Ваш код сертификата:</p>
      <div class="certificate-code">${certificateId}</div>
    `;
  } else {
    statusDiv.className = "status fail";
    statusDiv.innerHTML = `<i class="fas fa-times-circle"></i> Тест не пройден (${percent.toFixed(1)}%), требуется ${PASS_THRESHOLD}%`;
    resultMessage.innerHTML = `
      <div class="fail-result"><i class="fas fa-times-circle"></i> Тест не пройден.</div>
      <p>Вы ответили правильно на <strong>${correct} из ${questions.length}</strong> вопросов (${percent.toFixed(1)}%).</p>
      <p>Для успешного прохождения теста необходимо набрать ${PASS_THRESHOLD}%.</p>
    `;
  }
  resultContainer.style.display = 'block';
  actionButtons.style.display = passed ? 'flex' : 'none';
}

/* =========================
   PDF generation (English certificate, Cyrillic-safe font)
   ========================= */
async function generateCertificate() {
  if (!certificateData) return;

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });

  // Try to load Roboto to support Cyrillic names inside English certificate
  try {
    const fontUrl = 'https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf';
    const response = await fetch(fontUrl);
    if (!response.ok) throw new Error('Font load failed');
    const fontData = await response.arrayBuffer();
    const fontBase64 = arrayBufferToBase64(fontData);
    doc.addFileToVFS("Roboto-Regular.ttf", fontBase64);
    doc.addFont("Roboto-Regular.ttf", "Roboto", "normal");
    doc.setFont("Roboto");
  } catch (e) {
    console.warn("Не удалось загрузить шрифт Roboto, используем Helvetica:", e);
    doc.setFont("helvetica");
  }

  // Certificate content (English)
  doc.setFontSize(28);
  doc.setTextColor(40, 60, 80);
  doc.text('CERTIFICATE OF COMPLETION', 148, 30, { align: 'center' });

  doc.setFontSize(16);
  doc.setTextColor(100, 100, 100);
  doc.text('This certifies that', 148, 45, { align: 'center' });

  doc.setFontSize(24);
  doc.setTextColor(20, 100, 60);
  doc.text(certificateData.userName, 148, 60, { align: 'center' });

  doc.setFontSize(16);
  doc.setTextColor(100, 100, 100);
  doc.text('has successfully completed the course', 148, 75, { align: 'center' });

  doc.setFontSize(20);
  doc.setTextColor(40, 60, 80);
  doc.text(`"${certificateData.courseTitleEn}"`, 148, 90, { align: 'center' });

  doc.setFontSize(14);
  doc.setTextColor(100, 100, 100);
  doc.text(`Date Issued: ${certificateData.date}`, 148, 110, { align: 'center' });
  doc.text(`Certificate ID: ${certificateData.id}`, 148, 120, { align: 'center' });
  doc.text('Issued by: QHSE-Solutions.kz', 148, 130, { align: 'center' });

  // Border
  doc.setDrawColor(200);
  doc.setLineWidth(1);
  doc.rect(10, 10, 277, 190);

  const safeName = certificateData.userName.replace(/[^a-zA-Zа-яА-Я0-9]/g, '_');
  const fileName = `Certificate_${safeName}.pdf`;
  doc.save(fileName);
}

/* =========================
   Submit handler
   ========================= */
document.getElementById("submitBtn").addEventListener("click", async () => {
  const user = auth.currentUser;
  if (!user) { alert("Вы не авторизованы"); return; }

  let score = 0;
  questions.forEach((q, i) => {
    const selected = document.querySelector(`input[name=q${i}]:checked`);
    if (selected && parseInt(selected.value, 10) === q.correct) score++;
  });
  const percent = (score / questions.length) * 100;
  const passed = percent >= PASS_THRESHOLD;

  // Сертификат ID (20 символов)
  const certId = generateId(20);

  // Имя для сертификата
  const fullName = userNameEl.textContent || user.email || 'Participant';

  // Ссылка на документ прогресса по UID
  const progressRef = db.collection("course_progress").doc(user.uid);
  const nowISO = new Date().toISOString();

  try {
    await progressRef.set({
      userId: user.uid,
      courseId: COURSE_ID,
      status: passed ? "Курс завершён" : "Курс в процессе",
      testPassed: passed,
      certificateIssued: passed,
      certificateId: passed ? certId : null,
      issueDate: passed ? nowISO : null,
      score: Math.round(percent * 10) / 10,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });
  } catch (e) {
    console.error("Ошибка записи в Firestore:", e);
    alert("Не удалось сохранить результат. Проверьте доступ и правила Firestore.");
    return;
  }

  // UI-результат
  showTestResult(score, percent, passed, certId);

  if (passed) {
    certificateData = {
      id: certId,
      userName: fullName,
      date: formatDate(new Date()),
      courseTitle: COURSE_TITLE,
      courseTitleEn: COURSE_TITLE_EN,
      score: percent
    };
    downloadBtn.style.display = 'inline-flex';
  } else {
    downloadBtn.style.display = 'none';
  }
});

/* =========================
   Download certificate
   ========================= */
downloadBtn.addEventListener('click', (e) => {
  e.preventDefault();
  generateCertificate();
});

/* =========================
   Auth state + preload name
   ========================= */
auth.onAuthStateChanged(async user => {
  courseTitleEl.textContent = `Курс: ${COURSE_TITLE}`;
  if (!user) {
    alert("Пожалуйста, войдите в систему, чтобы пройти тест.");
    return;
  }
  currentUser = user;
  userEmailEl.textContent = user.email || '—';

  try {
    const approvedSnap = await db.collection("approved_users").doc(user.uid).get();
    if (!approvedSnap.exists) {
      userNameEl.textContent = user.email || 'Пользователь';
      statusDiv.className = "status fail";
      statusDiv.innerHTML = `<i class="fas fa-ban"></i> Вы не зарегистрированы как одобренный пользователь. Обратитесь к администратору.`;
      document.getElementById("submitBtn").disabled = true;
      return;
    }
    const userData = approvedSnap.data();
    userNameEl.textContent = userData.fullName || user.email || 'Пользователь';

    // (Опционально) проверка доступа к курсу, если ведёте список в approved_users
    if (userData.courses && Array.isArray(userData.courses) && !userData.courses.includes(COURSE_ID)) {
      statusDiv.className = "status fail";
      statusDiv.innerHTML = `<i class="fas fa-lock"></i> У вас нет доступа к этому курсу.`;
      document.getElementById("submitBtn").disabled = true;
      return;
    }

    statusDiv.className = "status";
    statusDiv.innerHTML = `<i class="fas fa-user"></i> Привет, ${userNameEl.textContent}! Удачи в тесте.`;
  } catch (e) {
    console.error("Ошибка чтения approved_users:", e);
    statusDiv.className = "status fail";
    statusDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> Ошибка доступа к данным пользователя.`;
    document.getElementById("submitBtn").disabled = true;
    return;
  }

  // Если уже есть выданный сертификат — покажем статус
  try {
    const progressDoc = await db.collection("course_progress").doc(user.uid).get();
    if (progressDoc.exists && progressDoc.data().certificateIssued) {
      statusDiv.className = "status success";
      statusDiv.innerHTML = `<i class="fas fa-check-circle"></i> Курс уже завершён, сертификат выдан.`;
    }
  } catch (e) {
    console.warn("Не удалось прочитать progress:", e);
  }
});
</script>
</body>
</html>